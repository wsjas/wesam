<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام WESAM - متصل بـ Firebase</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- Bootstrap RTL, Icons, Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#3498db;
      --dark:#2c3e50;
      --light:#f8f9fa;
    }
    body { background: var(--light); font-family: 'Segoe UI', Tahoma, Arial, sans-serif; }
    .sidebar { background: var(--dark); color: #fff; height: 100vh; position: fixed; right:0; width:250px; padding-top:20px; overflow-y: auto; }
    .sidebar a { color: #dfe6ee; text-decoration: none; display:block; padding:8px 12px; border-radius:6px; }
    .sidebar a.active, .sidebar a:hover { background: var(--primary); color:#fff; }
    .main { margin-right:250px; padding:18px; }
    .card-ghost { border-radius:10px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    .stat-number { font-size:1.6rem; font-weight:700; }
    .tiny { font-size:0.85rem; color:#6c757d; }
    .badge-status { min-width:80px; display:inline-block; text-align:center; }
    @media (max-width: 900px){
      .sidebar { position: relative; width:100%; height:auto; }
      .main { margin:0; padding:12px; }
    }
    @media print {
      .sidebar, .btn, .no-print { display: none !important; }
      .main { margin-right: 0 !important; }
      .card-ghost { box-shadow: none !important; border: 1px solid #ddd !important; }
    }
    .invoice-items { max-height: 300px; overflow-y: auto; }
    .invoice-item-row { border-bottom: 1px solid #eee; padding: 10px 0; }
    .backup-card { border-left: 4px solid var(--primary); }
    .restore-card { border-left: 4px solid #28a745; }
    .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; }
    .login-error { color: #dc3545; font-size: 0.9rem; margin-top: 5px; display: none; }
    .toast-container { z-index: 9999; }
    .delete-btn { color: #dc3545; cursor: pointer; }
    .delete-btn:hover { color: #bd2130; }
    .edit-btn { color: #007bff; cursor: pointer; }
    .edit-btn:hover { color: #0056b3; }
    .view-btn { color: #28a745; cursor: pointer; }
    .view-btn:hover { color: #1e7e34; }
    .action-btns { display: flex; gap: 8px; }
    .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    .notification-badge { position: absolute; top: -5px; right: -5px; }
    .cursor-pointer { cursor: pointer; }
    .dark-mode { background: #1a1a1a; color: #ffffff; }
    .dark-mode .card { background: #2c2c2c; color: #ffffff; }
    .dark-mode .table { color: #ffffff; }
    .dark-mode .table th, .dark-mode .table td { border-color: #444; }
    .dark-mode .modal-content { background: #2c2c2c; color: #ffffff; }
    .dark-mode .form-control, .dark-mode .form-select { 
      background: #333; 
      color: #fff; 
      border-color: #555;
    }
    .dark-mode .form-control:focus, .dark-mode .form-select:focus { 
      background: #333; 
      color: #fff; 
      border-color: #0d6efd;
    }
    .prediction-chart { height: 200px; }
    .date-range-filter { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .date-range-filter h6 { margin-bottom: 15px; color: #2c3e50; }
    .quick-date-range { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .quick-date-range .btn { padding: 5px 10px; font-size: 0.85rem; }
    .date-range-inputs { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .date-range-inputs label { margin-bottom: 0; font-weight: 500; }
  
    /* تحسين العرض على الجوال */
    @media (max-width: 576px) {
      html,
      body {
        font-size: 0.9rem;
        max-width: 100%;
        overflow-x: hidden;
      }
      .sidebar {
        width: 100% !important;
        position: relative !important;
        height: auto !important;
      }
      .main {
        margin: 0 !important;
        padding: 10px !important;
      }
      .content-section {
        padding: 0.75rem !important;
      }
      .card-ghost {
        margin-bottom: 0.75rem;
      }
      .table-responsive {
        font-size: 0.8rem;
        overflow-x: auto;
      }
      .table-responsive table {
        width: 100%;
      }
      .navbar-brand {
        font-size: 1rem;
      }
      .content-section h3 {
        font-size: 1.1rem;
      }
      .quick-date-range,
      .date-range-inputs {
        flex-wrap: wrap;
      }
      .date-range-inputs > * {
        flex: 1 1 100%;
      }
      .btn-group,
      .btn-toolbar {
        flex-wrap: wrap;
        width: 100%;
      }
      .btn-group .btn,
      .btn-toolbar .btn {
        flex: 1 1 48%;
        margin-bottom: 4px;
      }
    }

/* =========================
   MOBILE: Sidebar Toggle + Tables as Cards
   ========================= */
.mobile-topbar{display:none;}
.sidebar-overlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1040;}
@media (max-width: 768px){
  /* Make topbar compact + sticky */
  .mobile-topbar{
    position: sticky;
    top: 0;
    z-index: 1030;
    background: var(--light);
    padding: 8px 10px;
    margin: -10px -10px 10px; /* align with .main padding */
    border-bottom: 1px solid rgba(0,0,0,.08);
  }
  .mobile-topbar .btn{ padding: 8px 12px; font-size: .95rem; }

  /* Show topbar button */
  .mobile-topbar{display:flex;}

  /* Sidebar becomes off-canvas on mobile */
  .sidebar{
    position:fixed !important;
    top:0 !important;
    right:0 !important;
    height:100vh !important;
    width:min(86vw, 320px) !important;
    padding-top:14px !important;
    overflow-y:auto !important;
    z-index:1050 !important;
    transform:translateX(110%);
    transition:transform .25s ease;
    border-left:1px solid rgba(255,255,255,.12);
  }
  body.sidebar-open .sidebar{ transform:translateX(0); }

  /* Overlay */
  body.sidebar-open .sidebar-overlay{ display:block; }

  /* Prevent background scroll when sidebar open */
  body.sidebar-open{ overflow:hidden; }

  /* Main area */
  .main{ margin-right:0 !important; padding:10px !important; }

  /* Dashboard / Filters layout on mobile */
  .date-range-filter{
    padding: 10px !important;
  }
  .date-range-filter h6{
    font-size: 1rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .date-range-filter .quick-date-range{
    display: grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 8px;
    margin-bottom: 10px;
  }
  .date-range-filter .quick-date-range .btn{
    width: 100% !important;
    white-space: nowrap;
    padding: 8px 6px;
  }
  .date-range-filter .date-range-inputs{
    display: grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    align-items: center;
  }
  .date-range-filter .date-range-inputs label{
    font-size: .9rem;
    margin: 0;
  }
  .date-range-filter .date-range-inputs input,
  .date-range-filter .date-range-inputs select{
    width: 100% !important;
  }
  .date-range-filter .date-range-inputs button{
    grid-column: 1 / -1;
  }
  @media (max-width: 420px){
    .date-range-filter .quick-date-range{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .date-range-filter .date-range-inputs{ grid-template-columns: 1fr; }
  }

  /* Sidebar links spacing */
  .sidebar a{ font-size:.95rem; padding:10px 12px; margin:2px 0; display:block; }

  /* ===== Tables -> Cards ===== */
  .table-responsive{ overflow-x: visible; } /* because cards need full width */
  table.table{ width:100%; }

  table.table thead{ display:none; }
  table.table tbody, table.table tr, table.table td{ display:block; width:100%; }
  table.table tr{
    background:#fff;
    border:1px solid #e9ecef;
    border-radius:12px;
    padding:10px 10px 6px;
    margin-bottom:12px;
    box-shadow:0 6px 20px rgba(0,0,0,0.05);
  }
  table.table td{
    border:none !important;
    padding:6px 6px !important;
    white-space:normal !important;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  table.table td::before{
    content: attr(data-label);
    font-weight:700;
    color:#6c757d;
    flex:0 0 45%;
    max-width:45%;
  }
  table.table td > *{ flex:1 1 auto; }

  /* Make action buttons wrap nicely */
  table.table td:last-child{
    justify-content:flex-start;
    gap:8px;
    flex-wrap:wrap;
  }
  table.table td:last-child::before{ content:""; flex:0 0 0; max-width:0; }

  /* Smaller controls */
  .btn{ font-size:.8rem; padding:6px 10px; }
  input.form-control, select.form-select{ font-size:.95rem; }

  /* ===== Dashboard (and all date-range filters) better layout ===== */
  .date-range-filter{
    padding: 10px !important;
  }
  .date-range-filter h6{
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .date-range-filter .quick-date-range{
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 6px;
    margin-bottom: 10px;
  }
  .date-range-filter .quick-date-range .btn{
    width: 100%;
    padding: 10px 6px;
    font-size: .85rem;
    white-space: nowrap;
  }
  .date-range-filter .date-range-inputs{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    align-items: center;
  }
  .date-range-filter .date-range-inputs label{
    font-size: .9rem;
    margin: 0;
  }
  .date-range-filter .date-range-inputs input,
  .date-range-filter .date-range-inputs select{
    width: 100% !important;
  }
  .date-range-filter .date-range-inputs button{
    grid-column: 1 / -1;
    width: 100% !important;
  }

  @media (max-width: 420px){
    .date-range-filter .quick-date-range{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
}

  
/* ===== Mobile Dashboard & Charts Fix ===== */
.chart-box{ position: relative; width: 100%; }
.chart-box canvas{ width:100% !important; height:100% !important; display:block; }

@media (max-width: 768px){
  /* اجعل قسم لوحة التحكم أخف على الموبايل */
  #dashboard .card-ghost{ padding: 12px !important; }
  #dashboard h3{ font-size: 1.15rem !important; margin-bottom: 10px !important; }
  #dashboard h6{ font-size: 0.95rem !important; }

  /* البطاقات الإحصائية */
  #dashboard .stat-number{ font-size: 1.15rem !important; }

  /* صناديق الرسوم البيانية (تمنع تضخم الصفحة) */
  #dashboard .chart-box{ height: 240px; }
  #dashboard .chart-box.small{ height: 200px; }

  /* فلترة التاريخ في لوحة التحكم */
  #dashboard .date-range-filter{ padding: 10px !important; }
  #dashboard .quick-date-range{
    display: grid !important;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 6px;
  }
  #dashboard .quick-date-range .btn{ width: 100% !important; padding: 8px 6px !important; font-size: 0.85rem !important; }
  #dashboard .date-range-inputs{
    display: grid !important;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 10px;
  }
  #dashboard .date-range-inputs label{ font-size: 0.85rem; }
  #dashboard .date-range-inputs input,
  #dashboard .date-range-inputs select,
  #dashboard .date-range-inputs button{ width: 100% !important; }
}

</style>
</head>
<body>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
  </div>

  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- LOGIN -->
  <div id="loginView" class="container">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card card-ghost mt-5 p-3">
          <h4 class="text-center mb-3">تسجيل الدخول - نظام WESAM</h4>
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">البريد الإلكتروني</label>
              <input id="loginEmail" type="email" required class="form-control" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">كلمة المرور</label>
              <input id="loginPassword" type="password" required class="form-control" placeholder="admin123" value="admin123">
            </div>
            
            <!-- Error Message -->
            <div id="loginError" class="login-error text-center mb-3">
              <i class="bi bi-exclamation-triangle"></i> خطأ في البريد الإلكتروني أو كلمة المرور
            </div>
            
            <div class="d-grid">
              <button class="btn btn-primary" type="submit" id="loginBtn">
                <span id="loginText">دخول</span>
                <span id="loginSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
              </button>
            </div>
            
            <div class="mt-3 text-center">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="rememberMe" checked>
                <label class="form-check-label" for="rememberMe">تذكرني</label>
              </div>
              
              <button type="button" class="btn btn-sm btn-outline-info mt-2" id="testConnectionFromLogin">
                <i class="bi bi-wifi"></i> اختبار اتصال Firebase
              </button>
              
              <button type="button" class="btn btn-sm btn-outline-warning mt-2" id="useLocalMode">
                <i class="bi bi-hdd"></i> استخدام النسخة المحلية
              </button>
            </div>
            
            <div class="mt-3 text-center">
              <div class="alert alert-info py-2">
                <small>
                  <i class="bi bi-info-circle"></i> المستخدم الافتراضي:<br>
                  البريد: <strong>admin@example.com</strong><br>
                  كلمة المرور: <strong>admin123</strong>
                </small>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <div class="sidebar p-3">
      <div class="text-center mb-3">
        <img src="https://via.placeholder.com/60" alt="" class="rounded-circle mb-2">
        <div id="sidebarUserName">مدير النظام</div>
        <small id="sidebarUserRole" class="tiny">مدير</small>
        <div id="storageBadge" class="badge bg-success mt-1">Firebase</div>
      </div>

      <nav class="nav flex-column gap-1">
        <a href="#" class="nav-link active" data-section="dashboard" id="navDashboard"><i class="bi bi-speedometer2 me-2"></i>لوحة التحكم</a>
        <a href="#" class="nav-link" data-section="customers" id="navCustomers"><i class="bi bi-people-fill me-2"></i>إدارة العملاء</a>
        <a href="#" class="nav-link" data-section="products" id="navProducts"><i class="bi bi-box-seam me-2"></i>المستودع (المنتجات)</a>
        <a href="#" class="nav-link" data-section="sales" id="navSales"><i class="bi bi-cart-check me-2"></i>نظام المبيعات</a>
        <a href="#" class="nav-link" data-section="maintenance" id="navMaintenance"><i class="bi bi-tools me-2"></i>نظام الصيانة</a>
        <a href="#" class="nav-link" data-section="parts" id="navParts"><i class="bi bi-gear me-2"></i>تجار القطع</a>
        <a href="#" class="nav-link" data-section="dealers" id="navDealers"><i class="bi bi-shop me-2"></i>إدارة التجار</a>
        <a href="#" class="nav-link" data-section="expenses" id="navExpenses"><i class="bi bi-cash-coin me-2"></i>المصاريف</a>
        <a href="#" class="nav-link" data-section="commitments" id="navCommitments"><i class="bi bi-calendar-check me-2"></i>الالتزامات الشهرية</a>
        <a href="#" class="nav-link" data-section="bank" id="navBank"><i class="bi bi-bank me-2"></i>البنك</a>
        <a href="#" class="nav-link" data-section="debts" id="navDebts"><i class="bi bi-credit-card me-2"></i>الديون</a>
        <a href="#" class="nav-link" data-section="reports" id="navReports"><i class="bi bi-graph-up me-2"></i>التقارير</a>
        <a href="#" class="nav-link" data-section="users" id="navUsers"><i class="bi bi-person-badge me-2"></i>إدارة المستخدمين</a>
        <a href="#" class="nav-link" data-section="backup" id="navBackup"><i class="bi bi-database me-2"></i>النسخ الاحتياطي</a>
      </nav>

      <div class="mt-4 border-top pt-3 text-center">
        <div class="position-relative mb-2">
          <button class="btn btn-sm btn-outline-light w-100 mb-2" id="notificationsBtn">
            <i class="bi bi-bell me-1"></i>الإشعارات
            <span id="notificationCount" class="badge bg-danger notification-badge" style="display:none;">0</span>
          </button>
        </div>
        <button class="btn btn-sm btn-outline-light w-100 mb-2" id="toggleThemeBtn"><i class="bi bi-moon-stars me-1"></i>وضع داكن</button>
        <button class="btn btn-sm btn-info w-100 mb-2" id="testConnectionBtn"><i class="bi bi-wifi me-1"></i>اختبار الاتصال</button>
        <button class="btn btn-sm btn-warning w-100 mb-2" id="syncToFirebaseBtn"><i class="bi bi-cloud-arrow-up me-1"></i>مزامنة مع Firebase</button>
        <button class="btn btn-sm btn-danger w-100" id="logoutBtn"><i class="bi bi-box-arrow-left me-1"></i>تسجيل الخروج</button>
      </div>
    </div>

    <div class="main">

  <!-- Mobile Topbar -->
  <div class="mobile-topbar d-flex justify-content-between align-items-center mb-3 no-print">
    <button class="btn btn-sm btn-primary mobile-sidebar-toggle" id="mobileSidebarToggle" type="button">
      <i class="bi bi-list"></i> القائمة
    </button>
    <div class="mobile-topbar-title fw-bold">نظام WESAM</div>
  </div>

      <!-- Dashboard -->
      <section id="dashboard" class="content-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>لوحة التحكم</h3>
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="refreshStats"><i class="bi bi-arrow-clockwise"></i> تحديث</button>
            <button class="btn btn-outline-secondary btn-sm no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Dashboard -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة البيانات حسب الفترة الزمنية</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last6Months">آخر 6 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الوقت</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="dashboardDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="dashboardDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyDashboardFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetDashboardFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">فواتير المبيعات</div>
                  <div class="stat-number" id="statInvoices">0</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-receipt-cutoff display-6 text-primary"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">أوامر الصيانة</div>
                  <div class="stat-number" id="statMaintenance">0</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-tools display-6 text-success"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">إجمالي العملاء</div>
                  <div class="stat-number" id="statCustomers">0</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-people display-6 text-warning"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">إجمالي الإيرادات</div>
                  <div class="stat-number" id="statRevenue">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-cash-coin display-6 text-danger"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Revenue Breakdown -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">صافي ربح المبيعات</div>
                  <div class="stat-number" id="statSalesProfit">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-cart-check display-6 text-primary"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">صافي ربح الصيانة</div>
                  <div class="stat-number" id="statMaintenanceProfit">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-tools display-6 text-success"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">صافي الربح الإجمالي</div>
                  <div class="stat-number" id="statNetProfit">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-graph-up display-6 text-info"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row mt-3 g-3">
          <div class="col-md-8">
            <div class="card card-ghost p-3">
              <h6>الإيرادات الشهرية</h6>
              <div class="chart-box"><canvas id="revenueChart"></canvas></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <h6>توزيع أنواع الصيانة</h6>
              <div class="chart-box small"><canvas id="maintenanceTypeChart"></canvas></div>
            </div>
          </div>
        </div>

        <!-- Prediction Chart -->
        <div class="row mt-3 g-3">
          <div class="col-md-12">
            <div class="card card-ghost p-3">
              <h6>التنبؤ بالمبيعات المستقبلية</h6>
              <div class="chart-box"><canvas id="predictionChart" class="prediction-chart"></canvas></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Customers -->
      <section id="customers" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>إدارة العملاء</h3>
          <div>
            <input id="searchCustomer" class="form-control form-control-sm d-inline-block" style="width:220px" placeholder="بحث...">
            <button class="btn btn-sm btn-primary" id="btnAddCustomer"><i class="bi bi-plus-circle"></i> إضافة عميل</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportCustomersCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Customers -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة العملاء حسب تاريخ التسجيل</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل العملاء</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="customersDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="customersDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyCustomersFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetCustomersFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>اسم العميل</th><th>نوع الجهاز</th><th>حجم الجهاز</th><th>الهاتف</th><th>العنوان</th><th>تاريخ التسجيل</th><th>الحالة</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="customersTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="customersPaginationInfo" class="text-muted"></div>
              <nav id="customersPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Products -->
      <section id="products" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>المستودع - إدارة المنتجات</h3>
          <div>
            <div class="d-inline-block me-3">
              <div class="bg-light p-2 rounded">
                <small class="d-block text-muted">مجموع سعر الشراء</small>
                <strong id="totalBuyPrice" class="text-danger">0 دينار</strong>
              </div>
            </div>
            <div class="d-inline-block me-3">
              <div class="bg-light p-2 rounded">
                <small class="d-block text-muted">عدد المنتجات</small>
                <strong id="totalProductsCount" class="text-primary">0</strong>
              </div>
            </div>
            
            <input id="searchProduct" class="form-control form-control-sm d-inline-block" style="width:220px" placeholder="بحث...">
            <button class="btn btn-sm btn-primary" id="btnAddProduct"><i class="bi bi-plus-circle"></i> إضافة منتج</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportProductsCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead><tr><th>#</th><th>اسم المنتج</th><th>سعر الشراء</th><th>سعر البيع</th><th>الكمية</th><th>الإجراءات</th></tr></thead>
                <tbody id="productsTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="productsPaginationInfo" class="text-muted"></div>
              <nav id="productsPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Sales -->
      <section id="sales" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>نظام المبيعات</h3>
          <div>
            <button class="btn btn-sm btn-primary" id="btnAddInvoice"><i class="bi bi-plus-circle"></i> إنشاء فاتورة بيع</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportInvoicesCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Sales -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة الفواتير حسب التاريخ</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الفواتير</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="salesDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="salesDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applySalesFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetSalesFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>رقم</th><th>العميل</th><th>المنتجات</th><th>الكمية الإجمالية</th><th>التاريخ</th><th>إجمالي سعر البيع</th><th>إجمالي سعر الشراء</th><th>صافي الفاتورة</th><th>طريقة الدفع</th><th>حالة الدفع</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="invoicesTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="invoicesPaginationInfo" class="text-muted"></div>
              <nav id="invoicesPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Maintenance -->
      <section id="maintenance" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>نظام الصيانة</h3>
          <div>
            <button class="btn btn-sm btn-primary" id="btnAddMaintenance"><i class="bi bi-plus-circle"></i> إضافة أمر صيانة</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportMaintenanceCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Maintenance -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة أوامر الصيانة حسب تاريخ الاستلام</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الأوامر</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="maintenanceDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="maintenanceDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyMaintenanceFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetMaintenanceFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>رقم</th><th>العميل</th><th>الجهاز</th><th>نوع الصيانة</th><th>تكلفة العمل</th><th>ثمن القطع</th><th>تاجر القطع</th><th>صافي</th><th>طريقة الدفع</th><th>الحالة</th><th>تاريخ الكفالة</th><th>حالة الدفع</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="maintenanceTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="maintenancePaginationInfo" class="text-muted"></div>
              <nav id="maintenancePagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Parts -->
      <section id="parts" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>تجار القطع</h3>
          <div>
            <input id="searchPart" class="form-control form-control-sm d-inline-block" style="width:220px" placeholder="بحث...">
            <button class="btn btn-sm btn-primary" id="btnAddPart"><i class="bi bi-plus-circle"></i> إضافة قطعة</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportPartsCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Parts -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة القطع حسب تاريخ الإضافة</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل القطع</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="partsDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="partsDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyPartsFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetPartsFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>اسم القطعة</th><th>النوع</th><th>سعر الشراء</th><th>سعر البيع</th><th>الكمية</th><th>المورد</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="partsTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="partsPaginationInfo" class="text-muted"></div>
              <nav id="partsPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Dealers -->
      <section id="dealers" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>إدارة التجار</h3>
          <div>
            <input id="searchDealer" class="form-control form-control-sm d-inline-block" style="width:220px" placeholder="بحث...">
            <button class="btn btn-sm btn-primary" id="btnAddDealer"><i class="bi bi-plus-circle"></i> إضافة تاجر</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportDealersCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Dealers Transactions -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة معاملات التجار حسب التاريخ</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل المعاملات</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="dealersDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="dealersDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyDealersFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetDealersFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>اسم التاجر</th><th>التخصص</th><th>الهاتف</th><th>العنوان</th><th>إجمالي المشتريات</th><th>إجمالي المدفوعات</th><th>الباقي</th><th>آخر معاملة</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="dealersTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="dealersPaginationInfo" class="text-muted"></div>
              <nav id="dealersPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Expenses -->
      <section id="expenses" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>إدارة المصاريف</h3>
          <div>
            <div class="d-inline-block me-3">
              <div class="bg-light p-2 rounded">
                <small class="d-block text-muted">مجموع المصاريف الشهري</small>
                <strong id="totalMonthlyExpenses" class="text-danger">0 دينار</strong>
              </div>
            </div>
            
            <input id="searchExpense" class="form-control form-control-sm d-inline-block" style="width:220px" placeholder="بحث...">
            <button class="btn btn-sm btn-primary" id="btnAddExpense"><i class="bi bi-plus-circle"></i> إضافة مصروف</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportExpensesCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Expenses -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة المصروفات حسب التاريخ</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل المصروفات</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="expensesDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="expensesDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyExpensesFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetExpensesFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>التاريخ</th><th>نوع المصروف</th><th>المبلغ</th><th>الوصف</th><th>طريقة الدفع</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="expensesTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="expensesPaginationInfo" class="text-muted"></div>
              <nav id="expensesPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Commitments -->
      <section id="commitments" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>الالتزامات الشهرية</h3>
          <div>
            <div class="d-inline-block me-3">
              <div class="bg-light p-2 rounded">
                <small class="d-block text-muted">مجموع الالتزامات الشهري</small>
                <strong id="totalMonthlyCommitments" class="text-danger">0 دينار</strong>
              </div>
            </div>
            
            <button class="btn btn-sm btn-primary" id="btnAddCommitment"><i class="bi bi-plus-circle"></i> إضافة التزام</button>
            <button class="btn btn-sm btn-outline-secondary" id="exportCommitmentsCsv"><i class="bi bi-file-earmark-arrow-down"></i> تصدير CSV</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Commitments -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة الالتزامات حسب تاريخ البدء</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الالتزامات</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="commitmentsDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="commitmentsDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyCommitmentsFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetCommitmentsFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>اسم الالتزام</th><th>المبلغ</th><th>تاريخ البدء</th><th>مدة الالتزام (شهر)</th><th>الحالة</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="commitmentsTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="commitmentsPaginationInfo" class="text-muted"></div>
              <nav id="commitmentsPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Bank -->
      <section id="bank" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>البنك</h3>
          <div>
            <select id="bankRange" class="form-select form-select-sm d-inline-block" style="width:150px">
              <option value="daily">اليومي</option>
              <option value="monthly" selected>الشهري</option>
              <option value="yearly">السنوي</option>
            </select>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Bank -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة بيانات البنك حسب التاريخ</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل البيانات</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="bankDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="bankDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyBankFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetBankFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">إجمالي النقدي</div>
                  <div class="stat-number" id="bankCash">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-cash-coin display-6 text-success"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">إجمالي الحوالات</div>
                  <div class="stat-number" id="bankTransfer">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-bank display-6 text-primary"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">إجمالي الأموال</div>
                  <div class="stat-number" id="bankTotal">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-wallet2 display-6 text-warning"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>تفاصيل المبيعات</h6>
              <ul>
                <li>إجمالي المبيعات النقدية: <strong id="bankSalesCash">0 دينار</strong></li>
                <li>إجمالي المبيعات بالحوالات: <strong id="bankSalesTransfer">0 دينار</strong></li>
                <li>إجمالي تكلفة المنتجات: <strong id="bankProductsCost">0 دينار</strong></li>
                <li>صافي ربح المبيعات: <strong id="bankSalesNet">0 دينار</strong></li>
              </ul>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>تفاصيل الصيانة</h6>
              <ul>
                <li>إجمالي الصيانة النقدية: <strong id="bankMaintenanceCash">0 دينار</strong></li>
                <li>إجمالي الصيانة بالحوالات: <strong id="bankMaintenanceTransfer">0 دينار</strong></li>
                <li>إجمالي تكلفة القطع: <strong id="bankPartsCost">0 دينار</strong></li>
                <li>صافي ربح الصيانة: <strong id="bankMaintenanceNet">0 دينار</strong></li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Debts -->
      <section id="debts" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>الديون</h3>
          <div>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Debts -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>فلترة الديون حسب التاريخ</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الديون</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="debtsDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="debtsDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyDebtsFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetDebtsFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">ديون المبيعات</div>
                  <div class="stat-number" id="debtsSales">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-cart-x display-6 text-danger"></i>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="tiny">ديون الصيانة</div>
                  <div class="stat-number" id="debtsMaintenance">0 دينار</div>
                </div>
                <div class="align-self-center">
                  <i class="bi bi-tools display-6 text-warning"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-header">
            <h5 class="mb-0">ديون المبيعات</h5>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>رقم الفاتورة</th><th>العميل</th><th>المنتج</th><th>المبلغ</th><th>تاريخ الفاتورة</th><th>حالة الدفع</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="debtsSalesTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="debtsSalesPaginationInfo" class="text-muted"></div>
              <nav id="debtsSalesPagination"></nav>
            </div>
          </div>
        </div>

        <div class="card card-ghost mt-3">
          <div class="card-header">
            <h5 class="mb-0">ديون الصيانة</h5>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th><th>رقم أمر الصيانة</th><th>العميل</th><th>الجهاز</th><th>المبلغ</th><th>تاريخ الاستلام</th><th>حالة الدفع</th><th>الإجراءات</th>
                  </tr>
                </thead>
                <tbody id="debtsMaintenanceTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="debtsMaintenancePaginationInfo" class="text-muted"></div>
              <nav id="debtsMaintenancePagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>التقارير</h3>
          <div>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <!-- Date Range Filter for Reports -->
        <div class="date-range-filter card-ghost mb-4">
          <h6><i class="bi bi-calendar-range me-2"></i>اختر الفترة الزمنية للتقارير</h6>
          <div class="quick-date-range">
            <button class="btn btn-sm btn-outline-primary" data-range="today">اليوم</button>
            <button class="btn btn-sm btn-outline-primary" data-range="yesterday">أمس</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisWeek">هذا الأسبوع</button>
            <button class="btn btn-sm btn-outline-primary active" data-range="thisMonth">هذا الشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastMonth">الشهر الماضي</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last3Months">آخر 3 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="last6Months">آخر 6 أشهر</button>
            <button class="btn btn-sm btn-outline-primary" data-range="thisYear">هذه السنة</button>
            <button class="btn btn-sm btn-outline-primary" data-range="lastYear">السنة الماضية</button>
            <button class="btn btn-sm btn-outline-primary" data-range="allTime">كل الوقت</button>
          </div>
          <div class="date-range-inputs">
            <label>من:</label>
            <input type="date" id="reportsDateFrom" class="form-control form-control-sm" style="width: 150px;">
            <label>إلى:</label>
            <input type="date" id="reportsDateTo" class="form-control form-control-sm" style="width: 150px;">
            <button class="btn btn-sm btn-primary" id="applyReportsFilter">
              <i class="bi bi-filter"></i> تطبيق الفلترة
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="resetReportsFilter">
              <i class="bi bi-x-circle"></i> إعادة تعيين
            </button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>تقارير الصيانة</h6>
              <div class="mb-2">
                <select id="maintenanceRange" class="form-select form-select-sm">
                  <option value="daily">اليومي</option>
                  <option value="weekly">الأسبوعي</option>
                  <option value="monthly" selected>الشهري</option>
                  <option value="yearly">السنوي</option>
                </select>
              </div>
              <ul>
                <li>مجموع تكاليف الصيانة: <strong id="r_maint_total">0 دينار</strong></li>
                <li>مجموع ثمن القطع: <strong id="r_maint_parts">0 دينار</strong></li>
                <li>مجموع الصافي: <strong id="r_maint_net">0 دينار</strong></li>
                <li>مجموع مدفوعات تجار القطع: <strong id="r_maint_dealers">0 دينار</strong></li>
              </ul>
              <h6 class="mt-3">تفصيل حسب طريقة الدفع</h6>
              <ul>
                <li>إجمالي الكاش: <strong id="r_maint_cash">0 دينار</strong></li>
                <li>إجمالي الحوالات: <strong id="r_maint_transfer">0 دينار</strong></li>
              </ul>
              <h6 class="mt-3">تفصيل حسب نوع الصيانة</h6>
              <ul>
                <li>صيانة في المحل: <strong id="r_maint_in_shop">0 دينار</strong></li>
                <li>صيانة توصيل: <strong id="r_maint_delivery">0 دينار</strong></li>
              </ul>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>تقارير المبيعات / رأس المال</h6>
              <div class="mb-2">
                <select id="salesRange" class="form-select form-select-sm">
                  <option value="daily">اليومي</option>
                  <option value="monthly" selected>الشهري</option>
                  <option value="yearly">السنوي</option>
                </select>
              </div>
              <ul>
                <li>إجمالي المبيعات (سعر البيع): <strong id="r_sales_total">0 دينار</strong></li>
                <li>إجمالي تكلفة الشراء (رأس المال المبذول): <strong id="r_sales_buy">0 دينار</strong></li>
                <li>صافي البيع (ربح): <strong id="r_sales_net">0 دينار</strong></li>
              </ul>
              <h6 class="mt-3">تفصيل حسب طريقة الدفع</h6>
              <ul>
                <li>إجمالي الكاش: <strong id="r_sales_cash">0 دينار</strong></li>
                <li>إجمالي الحوالات: <strong id="r_sales_transfer">0 دينار</strong></li>
              </ul>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>تقارير المصاريف</h6>
              <div class="mb-2">
                <select id="expensesRange" class="form-select form-select-sm">
                  <option value="daily">اليومي</option>
                  <option value="monthly" selected>الشهري</option>
                  <option value="yearly">السنوي</option>
                </select>
              </div>
              <ul>
                <li>إجمالي المصاريف: <strong id="r_expenses_total">0 دينار</strong></li>
                <li>إجمالي الالتزامات الشهرية: <strong id="r_commitments_total">0 دينار</strong></li>
                <li>صافي الربح بعد المصاريف: <strong id="r_net_after_expenses">0 دينار</strong></li>
              </ul>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost p-3">
              <h6>التقارير المالية الشاملة</h6>
              <div class="mb-3">
                <select id="comprehensiveRange" class="form-select form-select-sm">
                  <option value="daily">اليومي</option>
                  <option value="monthly" selected>الشهري</option>
                  <option value="yearly">السنوي</option>
                </select>
              </div>
              <ul>
                <li>مجموع صافي الصيانة: <strong id="r_total_maint_net">0 دينار</strong></li>
                <li>مجموع صافي البيع: <strong id="r_total_sales_net">0 دينار</strong></li>
                <li>مجموع المصاريف: <strong id="r_total_expenses_comprehensive">0 دينار</strong></li>
                <li>مجموع الالتزامات الشهرية: <strong id="r_total_commitments_comprehensive">0 دينار</strong></li>
                <li>الأرباح بعد المصاريف والالتزامات: <strong id="r_final_profit">0 دينار</strong></li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Users -->
      <section id="users" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>إدارة المستخدمين</h3>
          <div>
            <button class="btn btn-sm btn-primary" id="btnAddUser"><i class="bi bi-plus-circle"></i> إضافة مستخدم</button>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <div class="card card-ghost">
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead><tr><th>#</th><th>الاسم</th><th>البريد</th><th>الدور</th><th>الحالة</th><th>الإجراءات</th></tr></thead>
                <tbody id="usersTable"></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div id="usersPaginationInfo" class="text-muted"></div>
              <nav id="usersPagination"></nav>
            </div>
          </div>
        </div>
      </section>

      <!-- Backup -->
      <section id="backup" class="content-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>النسخ الاحتياطي والاستعادة</h3>
          <div>
            <button class="btn btn-sm btn-outline-secondary no-print" onclick="window.print()"><i class="bi bi-printer"></i> طباعة</button>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card card-ghost backup-card p-3">
              <h6 class="text-primary"><i class="bi bi-download me-2"></i>إنشاء نسخة احتياطية</h6>
              <p class="text-muted mb-3">حفظ نسخة احتياطية من جميع بيانات النظام لاستعادتها لاحقاً.</p>
              
              <div class="mb-3">
                <label class="form-label">نوع النسخ الاحتياطي:</label>
                <select id="backupType" class="form-select">
                  <option value="full">نسخة كاملة (جميع البيانات)</option>
                  <option value="custom">نسخة مخصصة</option>
                </select>
              </div>
              
              <div id="customBackupOptions" class="mb-3" style="display:none;">
                <label class="form-label">اختر الجداول المراد نسخها:</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupCustomers" checked>
                  <label class="form-check-label" for="backupCustomers">العملاء</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupProducts" checked>
                  <label class="form-check-label" for="backupProducts">المنتجات</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupInvoices" checked>
                  <label class="form-check-label" for="backupInvoices">الفواتير</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupMaintenance" checked>
                  <label class="form-check-label" for="backupMaintenance">الصيانة</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupParts" checked>
                  <label class="form-check-label" for="backupParts">القطع</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupDealers" checked>
                  <label class="form-check-label" for="backupDealers">التجار</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupExpenses" checked>
                  <label class="form-check-label" for="backupExpenses">المصاريف</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupCommitments" checked>
                  <label class="form-check-label" for="backupCommitments">الالتزامات</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="backupUsers" checked>
                  <label class="form-check-label" for="backupUsers">المستخدمين</label>
                </div>
              </div>
              
              <div class="d-grid">
                <button class="btn btn-primary" id="btnCreateBackup">
                  <i class="bi bi-database me-1"></i> إنشاء وتنزيل نسخة احتياطية
                </button>
              </div>
              
              <div class="mt-3">
                <small class="text-muted">سيتم تنزيل ملف JSON يحتوي على جميع البيانات المحددة.</small>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card card-ghost restore-card p-3">
              <h6 class="text-success"><i class="bi bi-upload me-2"></i>استعادة من نسخة احتياطية</h6>
              <p class="text-muted mb-3">استعادة بيانات النظام من ملف نسخ احتياطي سابق.</p>
              
              <div class="mb-3">
                <label class="form-label">اختر ملف النسخ الاحتياطي:</label>
                <input type="file" id="backupFile" class="form-control" accept=".json,.txt">
              </div>
              
              <div class="mb-3">
                <label class="form-label">نوع الاستعادة:</label>
                <select id="restoreType" class="form-select">
                  <option value="full">استعادة كاملة (استبدال جميع البيانات)</option>
                  <option value="merge">دمج البيانات (إضافة دون حذف)</option>
                </select>
              </div>
              
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>تحذير:</strong> الاستعادة الكاملة ستحل محل جميع البيانات الحالية. يوصى بإنشاء نسخة احتياطية أولاً.
              </div>
              
              <div class="d-grid">
                <button class="btn btn-success" id="btnRestoreBackup">
                  <i class="bi bi-arrow-counterclockwise me-1"></i> استعادة البيانات
                </button>
              </div>
              
              <div class="mt-3">
                <small class="text-muted">يجب أن يكون الملف بتنسيق JSON من نسخة احتياطية سابقة.</small>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card card-ghost p-3">
              <h6><i class="bi bi-clock-history me-2"></i>النسخ الاحتياطي التلقائي</h6>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">تفعيل النسخ الاحتياطي التلقائي:</label>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="autoBackupToggle">
                      <label class="form-check-label" for="autoBackupToggle">مفعل</label>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">الفترة الزمنية:</label>
                    <select id="autoBackupInterval" class="form-select" disabled>
                      <option value="weekly">أسبوعي</option>
                      <option value="monthly">شهري</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>معلومات:</strong> سيتم تخزين النسخ الاحتياطيات التلقائية في قاعدة البيانات.
              </div>
              
              <div class="d-grid">
                <button class="btn btn-outline-info" id="btnManualBackup">
                  <i class="bi bi-save me-1"></i> إنشاء نسخة احتياطية يدوية الآن
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- جميع الـ Modals -->
  <!-- Customer Modal -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="customerForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="customerModalTitle">إضافة عميل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="custId" />
            <div class="row g-2">
              <div class="col-md-6"><label>الاسم</label><input id="custName" required class="form-control"></div>
              <div class="col-md-6"><label>نوع الجهاز</label><input id="custDeviceType" class="form-control"></div>
              <div class="col-md-6"><label>حجم الجهاز</label><input id="custDeviceSize" class="form-control"></div>
              <div class="col-md-6"><label>الهاتف</label><input id="custPhone" class="form-control"></div>
              <div class="col-12"><label>العنوان</label><input id="custAddress" class="form-control"></div>
              <div class="col-12"><label>ملاحظات</label><textarea id="custNotes" class="form-control" rows="2"></textarea></div>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="productForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="productModalTitle">إضافة منتج</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="prodId" />
            <div class="mb-2"><label>اسم المنتج</label><input id="prodName" class="form-control" required></div>
            <div class="row g-2">
              <div class="col-md-4"><label>سعر الشراء</label><input id="prodBuy" type="number" step="0.01" class="form-control" required></div>
              <div class="col-md-4"><label>سعر البيع</label><input id="prodSell" type="number" step="0.01" class="form-control" required></div>
              <div class="col-md-4"><label>الكمية</label><input id="prodStock" type="number" step="1" class="form-control" required></div>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ المنتج</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="invoiceForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="invoiceModalTitle">إنشاء فاتورة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="invId" />
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label>العميل</label>
                <select id="invCustomer" class="form-select">
                  <option value="">-- اختر العميل --</option>
                  <option value="anonymous">عميل بدون اسم</option>
                </select>
              </div>
              <div class="col-md-3">
                <label>التاريخ</label>
                <input id="invDate" type="date" class="form-control">
              </div>
              <div class="col-md-3">
                <label>رقم الفاتورة</label>
                <input id="invNumber" class="form-control" readonly>
              </div>
            </div>
            
            <div class="card mb-3">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">المنتجات</h6>
                <button type="button" class="btn btn-sm btn-primary" id="btnAddItem"><i class="bi bi-plus-circle"></i> إضافة صنف</button>
              </div>
              <div class="card-body invoice-items" id="invoiceItemsContainer">
                <!-- المنتجات ستضاف هنا ديناميكياً -->
              </div>
            </div>
            
            <div class="row g-2">
              <div class="col-md-4">
                <label>إجمالي سعر البيع</label>
                <input id="invTotalSell" class="form-control" readonly>
              </div>
              <div class="col-md-4">
                <label>إجمالي سعر الشراء</label>
                <input id="invTotalBuy" class="form-control" readonly>
              </div>
              <div class="col-md-4">
                <label>صافي الفاتورة</label>
                <input id="invNet" class="form-control" readonly>
              </div>
              <div class="col-md-4">
                <label>طريقة الدفع</label>
                <select id="invPaymentMethod" class="form-select" required>
                  <option value="cash">كاش</option>
                  <option value="transfer">حوالة بنكية</option>
                </select>
              </div>
              <div class="col-md-4">
                <label>حالة الدفع</label>
                <select id="invPaymentStatus" class="form-select" required>
                  <option value="paid">مدفوع</option>
                  <option value="pending">غير مدفوع</option>
                </select>
              </div>
              <div class="col-12">
                <label>ملاحظات</label>
                <textarea id="invNotes" class="form-control" rows="2"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ الفاتورة</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Maintenance Modal -->
  <div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="maintenanceForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="maintenanceModalTitle">أمر صيانة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="mntId" />
            <div class="row g-2">
              <div class="col-md-6"><label>العميل</label><select id="mntCustomer" class="form-select" required></select></div>
              <div class="col-md-6"><label>الجهاز</label><input id="mntDevice" class="form-control"></div>
              <div class="col-md-4"><label>تكلفة العمل</label><input id="mntCost" type="number" step="0.01" class="form-control" required></div>
              <div class="col-md-4"><label>ثمن القطع</label><input id="mntParts" type="number" step="0.01" class="form-control" value="0"></div>
              <div class="col-md-4"><label>تاجر القطع</label><select id="mntPartsDealer" class="form-select"><option value="">-- اختر التاجر --</option></select></div>
              <div class="col-md-4"><label>نوع الصيانة</label>
                <select id="mntType" class="form-select" required>
                  <option value="in_shop">في المحل</option>
                  <option value="delivery">توصيل</option>
                </select>
              </div>
              <div class="col-md-4"><label>صافي</label><input id="mntNet" class="form-control" readonly></div>
              <div class="col-md-4"><label>تاريخ الاستلام</label><input id="mntReceived" type="date" class="form-control"></div>
              <div class="col-md-4"><label>تاريخ التسليم</label><input id="mntDelivery" type="date" class="form-control"></div>
              <div class="col-md-4"><label>تاريخ الكفالة</label><input id="mntWarranty" type="date" class="form-control"></div>
              <div class="col-md-4"><label>طريقة الدفع</label>
                <select id="mntPaymentMethod" class="form-select" required>
                  <option value="cash">كاش</option>
                  <option value="transfer">حوالة بنكية</option>
                </select>
              </div>
              <div class="col-md-4"><label>حالة الدفع</label>
                <select id="mntPaymentStatus" class="form-select" required>
                  <option value="paid">مدفوع</option>
                  <option value="pending">غير مدفوع</option>
                </select>
              </div>
              <div class="col-md-4"><label>الحالة</label>
                <select id="mntStatus" class="form-select"><option value="new">جديد</option><option value="in_progress">قيد التنفيذ</option><option value="completed">مكتمل</option><option value="cancelled">ملغاة</option></select>
              </div>
              <div class="col-12"><label>ملاحظات</label><textarea id="mntNotes" class="form-control" rows="2"></textarea></div>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Part Modal -->
  <div class="modal fade" id="partModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="partForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="partModalTitle">إضافة قطعة</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="partId" />
            <div class="mb-2"><label>اسم القطعة</label><input id="partName" class="form-control" required></div>
            <div class="mb-2"><label>النوع</label><input id="partType" class="form-control" required></div>
            <div class="row g-2">
              <div class="col-md-4"><label>سعر الشراء</label><input id="partBuy" type="number" step="0.01" class="form-control" required></div>
              <div class="col-md-4"><label>سعر البيع</label><input id="partSell" type="number" step="0.01" class="form-control" required></div>
              <div class="col-md-4"><label>الكمية</label><input id="partStock" type="number" step="1" class="form-control" required></div>
            </div>
            <div class="mb-2"><label>المورد</label><select id="partSupplier" class="form-select"><option value="">-- اختر التاجر --</option></select></div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ القطعة</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Dealer Modal -->
  <div class="modal fade" id="dealerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="dealerForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="dealerModalTitle">إضافة تاجر</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="dealerId" />
            <div class="mb-2"><label>اسم التاجر</label><input id="dealerName" class="form-control" required></div>
            <div class="mb-2"><label>التخصص</label><input id="dealerSpecialty" class="form-control" required></div>
            <div class="mb-2"><label>الهاتف</label><input id="dealerPhone" class="form-control"></div>
            <div class="mb-2"><label>العنوان</label><input id="dealerAddress" class="form-control"></div>
            <div class="mb-2"><label>الرصيد الابتدائي</label><input id="dealerBalance" type="number" step="0.01" class="form-control" value="0" readonly></div>
            <div class="mb-2"><label>إجمالي المدفوعات</label><input id="dealerTotalPayments" type="number" step="0.01" class="form-control" value="0" readonly></div>
            <div class="mb-2">
              <label>الباقي</label>
              <input id="dealerRemaining" type="number" step="0.01" class="form-control" readonly>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ التاجر</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Expense Modal -->
  <div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="expenseForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="expenseModalTitle">إضافة مصروف</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="expenseId" />
            <div class="mb-2"><label>نوع المصروف</label>
              <select id="expenseType" class="form-select" required>
                <option value="rent">إيجار</option>
                <option value="salaries">رواتب</option>
                <option value="utilities">مرافق</option>
                <option value="supplies">مستلزمات</option>
                <option value="marketing">تسويق</option>
                <option value="transportation">مواصلات</option>
                <option value="maintenance">صيانة</option>
                <option value="other">أخرى</option>
              </select>
            </div>
            <div class="mb-2"><label>المبلغ</label><input id="expenseAmount" type="number" step="0.01" class="form-control" required></div>
            <div class="mb-2"><label>التاريخ</label><input id="expenseDate" type="date" class="form-control"></div>
            <div class="mb-2"><label>طريقة الدفع</label>
              <select id="expensePaymentMethod" class="form-select" required>
                <option value="cash">كاش</option>
                <option value="transfer">حوالة بنكية</option>
              </select>
            </div>
            <div class="mb-2"><label>الوصف</label><textarea id="expenseDescription" class="form-control" rows="2"></textarea></div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ المصروف</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Commitment Modal -->
  <div class="modal fade" id="commitmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="commitmentForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="commitmentModalTitle">إضافة التزام</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="commitmentId" />
            <div class="mb-2"><label>اسم الالتزام</label><input id="commitmentName" class="form-control" required></div>
            <div class="mb-2"><label>المبلغ الشهري</label><input id="commitmentAmount" type="number" step="0.01" class="form-control" required></div>
            <div class="mb-2"><label>تاريخ البدء</label><input id="commitmentStartDate" type="date" class="form-control"></div>
            <div class="mb-2"><label>مدة الالتزام (شهر)</label><input id="commitmentDuration" type="number" class="form-control" min="1" value="12"></div>
            <div class="mb-2"><label>الحالة</label>
              <select id="commitmentStatus" class="form-select">
                <option value="active">نشط</option>
                <option value="inactive">غير نشط</option>
              </select>
            </div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ الالتزام</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="userForm" class="p-3">
          <div class="modal-header"><h5 class="modal-title" id="userModalTitle">إضافة مستخدم</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="uId" />
            <div class="mb-2"><label>الاسم</label><input id="uName" class="form-control" required></div>
            <div class="mb-2"><label>البريد</label><input id="uEmail" type="email" class="form-control" required></div>
            <div class="mb-2"><label>كلمة المرور</label><input id="uPassword" type="password" class="form-control"></div>
            <div class="mb-2"><label>الدور</label>
              <select id="uRole" class="form-select">
                <option value="admin">مدير</option><option value="supervisor">مشرف</option><option value="sales">موظف مبيعات</option><option value="maintenance">موظف صيانة</option>
              </select>
            </div>
            <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="uActive" checked><label class="form-check-label">حساب نشط</label></div>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button class="btn btn-primary">حفظ المستخدم</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">الإشعارات</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="notificationsList"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger me-auto" id="clearNotifications">حذف جميع الإشعارات</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
          <button type="button" class="btn btn-primary" id="markAllAsRead">تحديد الكل كمقروء</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dealer Payment Modal -->
  <div class="modal fade" id="dealerPaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
      <div class="modal-content">
        <form id="dealerPaymentForm" class="p-3">
          <div class="modal-header">
            <h5 class="modal-title" id="dealerPaymentModalTitle">إضافة دفعة للتاجر</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="dealerPaymentId" />
            <input type="hidden" id="paymentDealerId" />
            <div class="mb-2">
              <label>اسم التاجر</label>
              <input id="paymentDealerName" class="form-control" readonly>
            </div>
            <div class="mb-2">
              <label>إجمالي المشتريات</label>
              <input id="paymentTotalPurchases" class="form-control" readonly>
            </div>
            <div class="mb-2">
              <label>إجمالي المدفوعات</label>
              <input id="paymentCurrentPayments" class="form-control" readonly>
            </div>
            <div class="mb-2">
              <label>الباقي الحالي</label>
              <input id="paymentCurrentRemaining" class="form-control" readonly>
            </div>
            <div class="mb-2">
              <label>مبلغ الدفعة <span class="text-danger">*</span></label>
              <input id="paymentAmount" type="number" step="0.01" class="form-control" required>
            </div>
            <div class="mb-2">
              <label>تاريخ الدفعة</label>
              <input id="paymentDate" type="date" class="form-control">
            </div>
            <div class="mb-2">
              <label>طريقة الدفع</label>
              <select id="paymentMethod" class="form-select" required>
                <option value="cash">كاش</option>
                <option value="transfer">حوالة بنكية</option>
              </select>
            </div>
            <div class="mb-2">
              <label>ملاحظات</label>
              <textarea id="paymentNotes" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
            <button type="submit" class="btn btn-primary">حفظ الدفعة</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /******************************************************************
   * WESAM - Enhanced System with All Improvements
   * مع إضافة نظام فلترة التاريخ المتقدم لكل الأقسام
   ******************************************************************/

  // ---------- Configuration ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCqEeXe2NOjzLeyns7IaPczxhCDUDg88Kc",
    authDomain: "wesamapp-790c1.firebaseapp.com",
    projectId: "wesamapp-790c1",
    storageBucket: "wesamapp-790c1.firebasestorage.app",
    messagingSenderId: "624654723290",
    appId: "1:624654723290:web:55fb3a4ca01781fed95de3",
    measurementId: "G-BGT9BR9QKS",
    databaseURL: "https://wesamapp-790c1-default-rtdb.firebaseio.com/"
  };

  // ---------- Global Variables ----------
  let useFirebase = true;
  let app, auth, database;
  let currentModal = null;
  let charts = {
    revenue: null,
    maintenanceType: null,
    prediction: null
  };
  
  // Cache system with LRU
  let cache = {
    data: {},
    timestamps: {},
    TTL: 5 * 60 * 1000, // 5 minutes
    maxSize: 50, // Maximum items in cache
    usage: {} // Track usage for LRU
  };
  
  // Pagination configuration
  const paginationConfig = {
    pageSize: 10,
    currentPage: 1
  };
  
  // Notifications system
  const NOTIFICATIONS_MAX_AGE_DAYS = 30; // حذف تلقائي للإشعارات الأقدم من 30 يوماً
  let notifications = [];
  
  // Search debouncing
  let searchTimeout = null;
  const DEBOUNCE_DELAY = 300; // 300ms
  
  // تعريف المتغيرات المفقودة
  let invoiceItemCount = 0;
  
  // Date Range System
  let currentDateRange = {
    dashboard: { from: null, to: null },
    customers: { from: null, to: null },
    sales: { from: null, to: null },
    maintenance: { from: null, to: null },
    parts: { from: null, to: null },
    dealers: { from: null, to: null },
    expenses: { from: null, to: null },
    commitments: { from: null, to: null },
    bank: { from: null, to: null },
    debts: { from: null, to: null },
    reports: { from: null, to: null }
  };

  // ---------- Initialize Firebase ----------
  function initializeFirebase() {
    try {
      if (firebase.apps.length === 0) {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        console.log('✅ Firebase initialized');
        return true;
      } else {
        app = firebase.app();
        auth = firebase.auth();
        database = firebase.database();
        console.log('✅ Firebase already initialized');
        return true;
      }
    } catch (error) {
      console.error('❌ Firebase initialization failed:', error);
      useFirebase = false;
      return false;
    }
  }

  // ---------- Helper Functions ----------
  function uid(){ 
    return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  function nowISO(){ return new Date().toISOString(); }
  function currency(n){ 
    const num = Number(n||0);
    return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' دينار';
  }
  function toNumber(v){ 
    if (v === null || v === undefined || v === '') return 0;
    const num = Number(v);
    return isNaN(num) ? 0 : num;
  }
  function dateOnly(d){ 
    if(!d) return ''; 
    const D = new Date(d); 
    if (isNaN(D)) return ''; 
    return D.toISOString().slice(0,10); 
  }

  function escapeHtml(s) { 
    if(!s) return ''; 
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  // ---------- Date Range Functions ----------
  function getDateRange(rangeType) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    let from, to;
    
    switch(rangeType) {
      case 'today':
        from = new Date(today);
        to = new Date(today);
        to.setDate(to.getDate() + 1);
        break;
      case 'yesterday':
        from = new Date(today);
        from.setDate(from.getDate() - 1);
        to = new Date(today);
        break;
      case 'thisWeek':
        from = new Date(today);
        const day = today.getDay() || 7; // Get day of week (1 = Monday, 7 = Sunday)
        from.setDate(today.getDate() - day + 1); // Start from Monday
        to = new Date(today);
        to.setDate(to.getDate() + (7 - day) + 1);
        break;
      case 'thisMonth':
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        to.setDate(to.getDate() + 1); // Include last day
        break;
      case 'lastMonth':
        from = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        to = new Date(now.getFullYear(), now.getMonth(), 0);
        to.setDate(to.getDate() + 1);
        break;
      case 'last3Months':
        from = new Date(now.getFullYear(), now.getMonth() - 3, 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        to.setDate(to.getDate() + 1);
        break;
      case 'last6Months':
        from = new Date(now.getFullYear(), now.getMonth() - 6, 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        to.setDate(to.getDate() + 1);
        break;
      case 'thisYear':
        from = new Date(now.getFullYear(), 0, 1);
        to = new Date(now.getFullYear() + 1, 0, 0);
        to.setDate(to.getDate() + 1);
        break;
      case 'lastYear':
        from = new Date(now.getFullYear() - 1, 0, 1);
        to = new Date(now.getFullYear(), 0, 0);
        to.setDate(to.getDate() + 1);
        break;
      case 'allTime':
        from = null;
        to = null;
        break;
      default:
        from = new Date(now.getFullYear(), now.getMonth(), 1);
        to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        to.setDate(to.getDate() + 1);
    }
    
    return { from, to };
  }

  function setDateRangeInputs(section, range) {
    const { from, to } = getDateRange(range);
    const fromInput = document.getElementById(`${section}DateFrom`);
    const toInput = document.getElementById(`${section}DateTo`);
    
    if (fromInput && from) {
      fromInput.value = dateOnly(from);
    }
    if (toInput && to) {
      toInput.value = dateOnly(to);
    }
    
    // Update active button
    document.querySelectorAll(`#${section} .quick-date-range .btn`).forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-range') === range) {
        btn.classList.add('active');
      }
    });
    
    // Save to currentDateRange
    currentDateRange[section].from = from;
    currentDateRange[section].to = to;
  }

  function getCurrentDateRange(section) {
    return currentDateRange[section];
  }

  function filterByDateRange(data, dateField, section, allowNullDates = false) {
    const range = getCurrentDateRange(section);
    
    if (!range.from && !range.to) {
      return data; // No filter
    }
    
    return data.filter(item => {
      const itemDateStr = item[dateField] || item.createdAt;
      if (!itemDateStr && allowNullDates) {
        return true; // Include items without date if allowed
      }
      if (!itemDateStr) {
        return false; // Exclude items without date
      }
      
      const itemDate = new Date(itemDateStr);
      if (isNaN(itemDate.getTime())) {
        return false; // Invalid date
      }
      
      let withinRange = true;
      
      if (range.from) {
        const fromDate = new Date(range.from);
        withinRange = withinRange && itemDate >= fromDate;
      }
      
      if (range.to) {
        const toDate = new Date(range.to);
        withinRange = withinRange && itemDate <= toDate;
      }
      
      return withinRange;
    });
  }

  function initializeDateRangeFilters() {
    // Initialize all date range filters
    const sections = ['dashboard', 'customers', 'sales', 'maintenance', 'parts', 'dealers', 'expenses', 'commitments', 'bank', 'debts', 'reports'];
    
    sections.forEach(section => {
      // Set default range (this month)
      setDateRangeInputs(section, 'thisMonth');
      
// في initializeDateRangeFilters، أضف بعد setDateRangeInputs
// تهيئة خاصة للالتزامات
setTimeout(() => {
    // جعل فلترة "هذا الشهر" هي الافتراضية للالتزامات
    const commitmentsSection = document.getElementById('commitments');
    if (commitmentsSection) {
        const quickRangeBtns = commitmentsSection.querySelectorAll('.quick-date-range .btn');
        quickRangeBtns.forEach(btn => {
            if (btn.getAttribute('data-range') === 'thisMonth') {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
}, 100);
      // Add event listeners for quick range buttons
      const container = document.getElementById(section);
      if (container) {
        const quickRangeBtns = container.querySelectorAll('.quick-date-range .btn');
        quickRangeBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            const range = this.getAttribute('data-range');
            setDateRangeInputs(section, range);
            
            // Trigger filter based on section
            switch(section) {
              case 'dashboard':
                loadDashboard();
                break;
              case 'customers':
                loadCustomers();
                break;
              case 'sales':
                loadInvoices();
                break;
              case 'maintenance':
                loadMaintenance();
                break;
              case 'parts':
                loadParts();
                break;
              case 'dealers':
                loadDealers();
                break;
              case 'expenses':
                loadExpenses();
                break;
              case 'commitments':
                loadCommitments();
                break;
              case 'bank':
                loadBank();
                break;
              case 'debts':
                loadDebts();
                break;
              case 'reports':
                loadReports();
                break;
            }
          });
        });
        
        // Add event listeners for custom date inputs
        const applyBtn = container.querySelector('#apply' + section.charAt(0).toUpperCase() + section.slice(1) + 'Filter');
        const resetBtn = container.querySelector('#reset' + section.slice(1) + 'Filter');
        
        if (applyBtn) {
          applyBtn.addEventListener('click', function() {
            const fromInput = document.getElementById(`${section}DateFrom`);
            const toInput = document.getElementById(`${section}DateTo`);
            
            currentDateRange[section].from = fromInput.value ? new Date(fromInput.value) : null;
            currentDateRange[section].to = toInput.value ? new Date(toInput.value) : null;
            
            // Trigger filter based on section
            switch(section) {
              case 'dashboard':
                loadDashboard();
                break;
              case 'customers':
                loadCustomers();
                break;
              case 'sales':
                loadInvoices();
                break;
              case 'maintenance':
                loadMaintenance();
                break;
              case 'parts':
                loadParts();
                break;
              case 'dealers':
                loadDealers();
                break;
              case 'expenses':
                loadExpenses();
                break;
              case 'commitments':
                loadCommitments();
                break;
              case 'bank':
                loadBank();
                break;
              case 'debts':
                loadDebts();
                break;
              case 'reports':
                loadReports();
                break;
            }
          });
        }
        
        if (resetBtn) {
          resetBtn.addEventListener('click', function() {
            setDateRangeInputs(section, 'thisMonth');
            
            // Trigger filter based on section
            switch(section) {
              case 'dashboard':
                loadDashboard();
                break;
              case 'customers':
                loadCustomers();
                break;
              case 'sales':
                loadInvoices();
                break;
              case 'maintenance':
                loadMaintenance();
                break;
              case 'parts':
                loadParts();
                break;
              case 'dealers':
                loadDealers();
                break;
              case 'expenses':
                loadExpenses();
                break;
              case 'commitments':
                loadCommitments();
                break;
              case 'bank':
                loadBank();
                break;
              case 'debts':
                loadDebts();
                break;
              case 'reports':
                loadReports();
                break;
            }
          });
        }
      }
    });
  }

  // ---------- Encryption Functions ----------
  function encryptPassword(password) {
    // Simple hash function (in production, use bcrypt or similar)
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
      const char = password.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash.toString(16);
  }

  // ---------- Cache System with LRU ----------
  function getFromCache(key) {
    const item = cache.data[key];
    const timestamp = cache.timestamps[key];
    
    if (item && timestamp && (Date.now() - timestamp) < cache.TTL) {
      // Update usage for LRU
      cache.usage[key] = Date.now();
      console.log('📦 Cache hit:', key);
      return item;
    }
    
    return null;
  }

  function setToCache(key, value) {
    // Check if cache is full (LRU)
    const keys = Object.keys(cache.data);
    if (keys.length >= cache.maxSize) {
      // Find least recently used item
      let lruKey = null;
      let lruTime = Infinity;
      
      for (const k of keys) {
        if (cache.usage[k] < lruTime) {
          lruTime = cache.usage[k];
          lruKey = k;
        }
      }
      
      // Remove LRU item
      if (lruKey) {
        delete cache.data[lruKey];
        delete cache.timestamps[lruKey];
        delete cache.usage[lruKey];
        console.log('🗑️ Removed LRU item:', lruKey);
      }
    }
    
    cache.data[key] = value;
    cache.timestamps[key] = Date.now();
    cache.usage[key] = Date.now();
    console.log('💾 Cache set:', key);
  }

  function clearCache(key = null) {
    if (key) {
      delete cache.data[key];
      delete cache.timestamps[key];
      delete cache.usage[key];
    } else {
      cache.data = {};
      cache.timestamps = {};
      cache.usage = {};
    }
    console.log('🗑️ Cache cleared:', key || 'all');
  }

  // ---------- Advanced Cache Statistics ----------
  function getCacheStats() {
    const keys = Object.keys(cache.data);
    const now = Date.now();
    let expired = 0;
    let used = 0;
    
    for (const key of keys) {
      const timestamp = cache.timestamps[key];
      if (now - timestamp >= cache.TTL) {
        expired++;
      } else {
        used++;
      }
    }
    
    return {
      total: keys.length,
      used: used,
      expired: expired,
      maxSize: cache.maxSize,
      hitRate: (used / (keys.length || 1)).toFixed(2)
    };
  }

  // ---------- Lazy Loading ----------
  const lazyLoaders = new Map();

  function registerLazyLoader(section, loaderFunction, dependencies = []) {
    lazyLoaders.set(section, {
      loader: loaderFunction,
      dependencies: dependencies,
      loaded: false
    });
  }

  function lazyLoadSection(section) {
    const loader = lazyLoaders.get(section);
    if (loader && !loader.loaded) {
      console.log('📥 Lazy loading:', section);
      loader.loader();
      loader.loaded = true;
    }
  }

  // ---------- Debouncing ----------
  function debounce(func, delay) {
    return function(...args) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // ---------- Pagination Functions ----------
  function paginateData(data, page, pageSize) {
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    return {
      items: data.slice(start, end),
      total: data.length,
      pages: Math.ceil(data.length / pageSize),
      currentPage: page,
      pageSize: pageSize
    };
  }

  function createPagination(totalPages, currentPage, elementId, callback) {
    const pagination = document.getElementById(elementId);
    if (!pagination) return;
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    const ul = document.createElement('ul');
    ul.className = 'pagination justify-content-center';
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    const prevLink = document.createElement('a');
    prevLink.className = 'page-link';
    prevLink.href = '#';
    prevLink.innerHTML = '&laquo;';
    prevLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentPage > 1) callback(currentPage - 1);
    });
    prevLi.appendChild(prevLink);
    ul.appendChild(prevLi);
    
    // Page numbers
    const maxVisible = 5;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);
    
    if (end - start + 1 < maxVisible) {
      start = Math.max(1, end - maxVisible + 1);
    }
    
    for (let i = start; i <= end; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === currentPage ? 'active' : ''}`;
      const link = document.createElement('a');
      link.className = 'page-link';
      link.href = '#';
      link.textContent = i;
      link.addEventListener('click', (e) => {
        e.preventDefault();
        callback(i);
      });
      li.appendChild(link);
      ul.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    const nextLink = document.createElement('a');
    nextLink.className = 'page-link';
    nextLink.href = '#';
    nextLink.innerHTML = '&raquo;';
    nextLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentPage < totalPages) callback(currentPage + 1);
    });
    nextLi.appendChild(nextLink);
    ul.appendChild(nextLi);
    
    pagination.appendChild(ul);
  }

  function updatePaginationInfo(elementId, paginatedData) {
    const info = document.getElementById(elementId);
    if (!info) return;
    
    const start = ((paginatedData.currentPage - 1) * paginatedData.pageSize) + 1;
    const end = Math.min(start + paginatedData.pageSize - 1, paginatedData.total);
    
    info.textContent = `عرض ${start}-${end} من ${paginatedData.total}`;
  }

  // ---------- Advanced Search Indexing ----------
  const searchIndex = new Map();

  function buildSearchIndex(collection, data, fields) {
    const indexKey = `${collection}_index`;
    
    if (!searchIndex.has(indexKey)) {
      searchIndex.set(indexKey, {
        data: data,
        fields: fields,
        lastUpdated: Date.now()
      });
    }
    
    return searchIndex.get(indexKey);
  }

  function searchInIndex(collection, query) {
    const index = searchIndex.get(`${collection}_index`);
    if (!index || !query) return index ? index.data : [];
    
    const lowerQuery = query.toLowerCase();
    return index.data.filter(item => {
      return index.fields.some(field => {
        const value = item[field];
        return value && value.toString().toLowerCase().includes(lowerQuery);
      });
    });
  }

  // ---------- UI Helpers ----------
  function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'block';
  }

  function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
  }

  function showToast(msg, type = 'info') {
    const colors = {
      'info': '#3498db',
      'success': '#28a745',
      'warning': '#ffc107',
      'error': '#dc3545'
    };
    
    // إزالة أي رسائل سابقة
    const existingToasts = document.querySelectorAll('.toast-container');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = 'toast-container position-fixed bottom-0 start-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
      <div class="toast show" role="alert">
        <div class="toast-header" style="background-color: ${colors[type] || '#3498db'}; color: white;">
          <strong class="me-auto">نظام WESAM</strong>
          <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
        </div>
        <div class="toast-body">
          ${msg}
        </div>
      </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      if (toast.parentNode) toast.remove();
    }, 3000);
  }

  // ---------- Modal Functions ----------
  function showModal(modalId, title) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
      const modal = new bootstrap.Modal(modalElement);
      if (title) {
        const modalTitle = modalElement.querySelector('.modal-title');
        if (modalTitle) modalTitle.textContent = title;
      }
      modal.show();
      currentModal = modal;
    }
  }

  function hideModal(modalId) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
      const modal = bootstrap.Modal.getInstance(modalElement);
      if (modal) {
        modal.hide();
      }
    }
    currentModal = null;
  }

  // ---------- Storage System with Advanced Cache ----------
  async function save(key, value) {
    try {
      showLoading();
      
      // Update cache with LRU
      setToCache(key, value);
      
      // Update search index if applicable
      if (key === 'customers') {
        buildSearchIndex('customers', value, ['name', 'phone', 'deviceType', 'address']);
      } else if (key === 'products') {
        buildSearchIndex('products', value, ['name']);
      } else if (key === 'parts') {
        buildSearchIndex('parts', value, ['name', 'type']);
      } else if (key === 'dealers') {
        buildSearchIndex('dealers', value, ['name', 'specialty', 'phone']);
      } else if (key === 'expenses') {
        buildSearchIndex('expenses', value, ['description', 'type']);
      }
      
      if (useFirebase && database) {
        try {
          await database.ref(key).set(value);
          console.log('💾 Saved to Firebase:', key);
        } catch (firebaseError) {
          console.error('Firebase save error:', firebaseError);
          useFirebase = false;
          showToast('⚠️ تم حفظ البيانات محلياً فقط', 'warning');
        }
      }
      
      // Always save to localStorage as backup
      localStorage.setItem('wesam_' + key, JSON.stringify(value));
      console.log('💾 Saved to localStorage:', key);
      
      return true;
      
    } catch (error) {
      console.error('Save error:', error);
      showToast('❌ خطأ في حفظ البيانات', 'error');
      return false;
    } finally {
      hideLoading();
    }
  }

  async function load(key, useCache = true) {
    try {
      // Check cache first
      if (useCache) {
        const cached = getFromCache(key);
        if (cached) {
          console.log('📥 Loaded from cache:', key);
          return cached;
        }
      }
      
      showLoading();
      
      let data = null;
      
      // Try Firebase first
      if (useFirebase && database) {
        try {
          const snapshot = await database.ref(key).once('value');
          data = snapshot.val();
          if (data !== null) {
            console.log('📥 Loaded from Firebase:', key);
            // Update cache and localStorage
            setToCache(key, data);
            localStorage.setItem('wesam_' + key, JSON.stringify(data));
          }
        } catch (firebaseError) {
          console.error('Firebase load error:', firebaseError);
          useFirebase = false;
        }
      }
      
      // If no data from Firebase, try localStorage
      if (data === null || data === undefined) {
        const stored = localStorage.getItem('wesam_' + key);
        if (stored) {
          try {
            data = JSON.parse(stored);
            console.log('📥 Loaded from localStorage:', key);
            // Update cache
            setToCache(key, data);
          } catch (e) {
            console.error('Error parsing localStorage data:', e);
            data = [];
          }
        }
      }
      
      return data || [];
      
    } catch (error) {
      console.error('Load error:', error);
      showToast('❌ خطأ في تحميل البيانات', 'error');
      return [];
    } finally {
      hideLoading();
    }
  }

  // ---------- Advanced Permissions System ----------
  const permissions = {
    admin: {
      customers: ['create', 'read', 'update', 'delete', 'export'],
      products: ['create', 'read', 'update', 'delete', 'export'],
      invoices: ['create', 'read', 'update', 'delete', 'export'],
      maintenance: ['create', 'read', 'update', 'delete', 'export'],
      parts: ['create', 'read', 'update', 'delete', 'export'],
      dealers: ['create', 'read', 'update', 'delete', 'export'],
      expenses: ['create', 'read', 'update', 'delete', 'export'],
      commitments: ['create', 'read', 'update', 'delete', 'export'],
      users: ['create', 'read', 'update', 'delete'],
      reports: ['read', 'export'],
      backup: ['create', 'restore']
    },
    supervisor: {
      customers: ['create', 'read', 'update', 'export'],
      products: ['create', 'read', 'update', 'export'],
      invoices: ['create', 'read', 'update', 'export'],
      maintenance: ['create', 'read', 'update', 'export'],
      parts: ['create', 'read', 'update', 'export'],
      dealers: ['create', 'read', 'update', 'export'],
      expenses: ['create', 'read', 'update', 'export'],
      commitments: ['create', 'read', 'update', 'export'],
      users: ['read'],
      reports: ['read', 'export'],
      backup: ['create']
    },
    sales: {
      customers: ['create', 'read', 'update'],
      products: ['read'],
      invoices: ['create', 'read'],
      maintenance: ['read'],
      parts: ['read'],
      dealers: ['read'],
      expenses: ['read'],
      commitments: ['read'],
      users: [],
      reports: ['read'],
      backup: []
    },
    maintenance: {
      customers: ['read'],
      products: ['read'],
      invoices: ['read'],
      maintenance: ['create', 'read', 'update'],
      parts: ['create', 'read', 'update'],
      dealers: ['create', 'read', 'update'],
      expenses: ['read'],
      commitments: ['read'],
      users: [],
      reports: ['read'],
      backup: []
    }
  };

  function checkPermission(resource, action) {
    const user = currentUser();
    if (!user) return false;
    
    const userPermissions = permissions[user?.role];
    if (!userPermissions) return false;
    
    const resourcePermissions = userPermissions[resource];
    if (!resourcePermissions) return false;
    
    return resourcePermissions.includes(action);
  }

  // ---------- Test Connection ----------
  async function testFirebaseConnection() {
    try {
      showLoading();
      
      if (!useFirebase || !database) {
        hideLoading();
        return {
          success: false,
          message: '⚠️ جاري استخدام التخزين المحلي',
          storage: 'LocalStorage'
        };
      }
      
      // Test connection
      const testRef = database.ref('connectionTest');
      await testRef.set({ test: true, timestamp: Date.now() });
      const snapshot = await testRef.once('value');
      await testRef.remove();
      
      hideLoading();
      return {
        success: true,
        message: '✅ الاتصال بـ Firebase يعمل بشكل صحيح',
        storage: 'Firebase'
      };
      
    } catch (error) {
      hideLoading();
      console.error('Connection test failed:', error);
      return {
        success: false,
        message: '❌ خطأ في الاتصال: ' + error.message,
        storage: 'LocalStorage'
      };
    }
  }

  // ---------- Authentication System with Advanced Features ----------
  async function login(email, password) {
    try {
      // Show loading
      document.getElementById('loginText').style.display = 'none';
      document.getElementById('loginSpinner').style.display = 'inline-block';
      document.getElementById('loginError').style.display = 'none';
      
      // Load users
      let users = await load('users');
      
      // Check if users exist
      if (!users || users.length === 0) {
        console.log('No users found, creating default user...');
        
        // Create default users with encrypted passwords
        const defaultUsers = [
          { 
            id: uid(), 
            name: 'مدير النظام', 
            email: 'admin@example.com', 
            password: encryptPassword('admin123'), 
            role: 'admin', 
            active: true, 
            createdAt: nowISO(),
            lastLogin: null,
            loginAttempts: 0
          },
          { 
            id: uid(), 
            name: 'موظف مبيعات', 
            email: 'sales@example.com', 
            password: encryptPassword('sales123'), 
            role: 'sales', 
            active: true, 
            createdAt: nowISO(),
            lastLogin: null,
            loginAttempts: 0
          }
        ];
        
        await save('users', defaultUsers);
        users = defaultUsers;
      }
      
      // Find user with encrypted password check
      const encryptedPassword = encryptPassword(password);
      const user = users.find(u => 
        u.email === email && (u.password === encryptedPassword || u.password === password)
      );
      
      if (user) {
        if (!user.active) {
          document.getElementById('loginError').style.display = 'block';
          document.getElementById('loginError').textContent = 'الحساب غير نشط';
          return null;
        }
        
        // Update last login and reset login attempts
        const userIndex = users.findIndex(u => u.id === user.id);
        // If old data stored plain password, upgrade to encrypted once
        if (user.password === password) {
          users[userIndex] = { ...users[userIndex], password: encryptedPassword };
        }

        if (userIndex !== -1) {
          users[userIndex].lastLogin = nowISO();
          users[userIndex].loginAttempts = 0;
          await save('users', users);
        }
        
        localStorage.setItem('currentUser', JSON.stringify(user));
        if (document.getElementById('rememberMe').checked) {
          localStorage.setItem('rememberedEmail', email);
        } else {
          localStorage.removeItem('rememberedEmail');
        }
        return user;
      } else {
        // Track failed login attempts
        const userIndex = users.findIndex(u => u.email === email);
        if (userIndex !== -1) {
          users[userIndex].loginAttempts = (users[userIndex].loginAttempts || 0) + 1;
          await save('users', users);
        }
        
        document.getElementById('loginError').style.display = 'block';
        return null;
      }
      
    } catch (error) {
      console.error('Login error:', error);
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('loginError').textContent = 'خطأ في تسجيل الدخول';
      return null;
    } finally {
      // Hide loading
      document.getElementById('loginText').style.display = 'inline';
      document.getElementById('loginSpinner').style.display = 'none';
    }
  }

  function logout() {
    localStorage.removeItem('currentUser');
    window.location.reload();
  }

  function currentUser() {
    const userStr = localStorage.getItem('currentUser');
    return userStr ? JSON.parse(userStr) : null;
  }

  function hasPermission(requiredRole) {
    const user = currentUser();
    if (!user) return false;
    
    // Role hierarchy
    const roleHierarchy = {
      'admin': ['admin', 'supervisor', 'sales', 'maintenance'],
      'supervisor': ['supervisor', 'sales', 'maintenance'],
      'sales': ['sales'],
      'maintenance': ['maintenance']
    };
    
    return roleHierarchy[user?.role]?.includes(requiredRole) || false;
  }

  // ---------- Initialize Default Data ----------
  async function ensureSeed() {
    try {
      // Initialize collections
      const collections = [
        'customers', 'products', 'invoices', 'maintenance',
        'parts', 'dealers', 'expenses', 'commitments', 'users',
        'dealerPayments' // إضافة مجموعة مدفوعات التجار
      ];
      
      for (const collection of collections) {
        const data = await load(collection);
        if (!Array.isArray(data)) {
          await save(collection, []);
        }
      }
      
      // Initialize counters
      let counters = await load('counters');
      if (!counters || typeof counters !== 'object') {
        counters = {
          invoice: 1000,
          maintenance: 2000,
          customer: 3000,
          product: 4000
        };
        await save('counters', counters);
      }
      
    } catch (error) {
      console.error('Seed error:', error);
    }
  }

  // ---------- Advanced Notifications System ----------
  
  async function pruneOldNotifications(list, maxDays = NOTIFICATIONS_MAX_AGE_DAYS) {
    try {
      if (!Array.isArray(list) || list.length === 0) {
        return list || [];
      }

      const now = Date.now();
      const maxAgeMs = maxDays * 24 * 60 * 60 * 1000;

      const filtered = list.filter(n => {
        if (!n || !n.createdAt) return true;
        const t = new Date(n.createdAt).getTime();
        if (isNaN(t)) return true;
        return (now - t) <= maxAgeMs;
      });

      if (filtered.length !== list.length) {
        await save('notifications', filtered);
      }

      return filtered;
    } catch (error) {
      console.error('Error pruning notifications:', error);
      return list || [];
    }
  }

async function loadNotifications() {
    try {
      notifications = await load('notifications') || [];
      if (!Array.isArray(notifications)) {
        notifications = [];
      }

      // حذف الإشعارات القديمة تلقائياً
      notifications = await pruneOldNotifications(notifications, NOTIFICATIONS_MAX_AGE_DAYS);

      // Filter unread notifications
      const unreadNotifications = notifications.filter(n => !n.read);

      // Update notification badge
      const badge = document.getElementById('notificationCount');
      if (badge) {
        if (unreadNotifications.length > 0) {
          badge.textContent = unreadNotifications.length;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }

      return notifications;
    } catch (error) {
      console.error('Error loading notifications:', error);
      return [];
    }
  }


async function createNotification(title, message, type = 'info', priority = 'medium') {
    try {
      const notification = {
        id: uid(),
        title,
        message,
        type,
        priority,
        read: false,
        createdAt: nowISO()
      };

      notifications.unshift(notification); // Add to beginning

      // حذف الإشعارات الأقدم من المدة المحددة قبل الحفظ
      notifications = await pruneOldNotifications(notifications, NOTIFICATIONS_MAX_AGE_DAYS);
      await save('notifications', notifications);

      // Reload notifications
      await loadNotifications();

      // Show toast notification
      showToast(message, type);

      return notification;
    } catch (error) {
      console.error('Error creating notification:', error);
    }
  }

  // Smart notifications monitoring
// Smart notifications monitoring
  async function monitorNotifications() {
    try {
      const [products, invoices, maintenance] = await Promise.all([
        load('products'),
        load('invoices'),
        load('maintenance')
      ]);
      
      // Check for out of stock only
      products.forEach(product => {
        if (toNumber(product.stock) === 0) {
          createNotification(
            'نفاذ المخزون',
            `المنتج ${product.name} نفذ من المخزون`,
            'error',
            'high'
          );
        }
      });
      
      // Check for overdue invoices (more than 30 days)
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      invoices.forEach(invoice => {
        if (invoice.paymentStatus === 'pending') {
          const invoiceDate = new Date(invoice.date || invoice.createdAt);
          if (invoiceDate < thirtyDaysAgo) {
            createNotification(
              'فاتورة متأخرة',
              `فاتورة ${invoice.number} متأخرة أكثر من 30 يوم`,
              'warning',
              'high'
            );
          }
        }
      });
      
      // Check for high-value sales (more than 1000)
      invoices.forEach(invoice => {
        if (toNumber(invoice.totalSell) > 1000) {
          createNotification(
            'مبيعات عالية القيمة',
            `فاتورة ${invoice.number} بقيمة ${currency(invoice.totalSell)}`,
            'success',
            'medium'
          );
        }
      });
      
    } catch (error) {
      console.error('Error monitoring notifications:', error);
    }
  }

  function showNotifications() {
    const modal = document.getElementById('notificationsModal');
    const list = document.getElementById('notificationsList');
    
    if (!modal || !list) return;
    
    // Sort by priority and date (newest first)
    const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
    const sortedNotifications = [...notifications].sort((a, b) => {
      if (a.priority !== b.priority) {
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      }
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    list.innerHTML = '';
    
    if (sortedNotifications.length === 0) {
      list.innerHTML = '<div class="text-center text-muted py-3">لا توجد إشعارات</div>';
    } else {
      sortedNotifications.forEach(notification => {
        const item = document.createElement('div');
        item.className = `alert alert-${getNotificationTypeClass(notification.type)} d-flex justify-content-between align-items-start mb-2 ${notification.read ? '' : 'alert-primary'}`;
        item.innerHTML = `
          <div>
            <strong>${escapeHtml(notification.title)}</strong><br>
            <small>${escapeHtml(notification.message)}</small><br>
            <small class="text-muted">${dateOnly(notification.createdAt)}</small>
          </div>
          <div>
            ${!notification.read ? '<span class="badge bg-danger me-2">جديد</span>' : ''}
            <span class="badge bg-${getPriorityBadge(notification.priority)}">${getPriorityText(notification.priority)}</span>
          </div>
        `;
        list.appendChild(item);
      });
    }
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
  }

  function getNotificationTypeClass(type) {
    const types = {
      'info': 'info',
      'success': 'success',
      'warning': 'warning',
      'error': 'danger'
    };
    return types[type] || 'info';
  }

  function getPriorityBadge(priority) {
    const badges = {
      'high': 'danger',
      'medium': 'warning',
      'low': 'info'
    };
    return badges[priority] || 'info';
  }

  function getPriorityText(priority) {
    const texts = {
      'high': 'عالية',
      'medium': 'متوسطة',
      'low': 'منخفضة'
    };
    return texts[priority] || 'متوسطة';
  }

  async function markAllNotificationsAsRead() {
    try {
      notifications.forEach(notification => {
        notification.read = true;
      });
      
      await save('notifications', notifications);
      await loadNotifications();
      
      // Refresh notifications list if modal is open
      const modal = document.getElementById('notificationsModal');
      if (modal && modal.classList.contains('show')) {
        showNotifications();
      }
      
      showToast('✅ تم تحديد جميع الإشعارات كمقروءة', 'success');
    } catch (error) {
      console.error('Error marking notifications as read:', error);
    }
  }


  async function clearAllNotifications() {
    try {
      if (!notifications || notifications.length === 0) {
        showToast('لا توجد إشعارات لحذفها', 'info');
        return;
      }

      if (!confirm('هل تريد حذف جميع الإشعارات السابقة؟')) {
        return;
      }

      notifications = [];
      await save('notifications', notifications);
      await loadNotifications();

      const list = document.getElementById('notificationsList');
      if (list) {
        list.innerHTML = '<div class="text-center text-muted py-3">لا توجد إشعارات</div>';
      }

      showToast('تم حذف جميع الإشعارات بنجاح', 'success');
    } catch (error) {
      console.error('Error clearing notifications:', error);
      showToast('حدث خطأ أثناء حذف الإشعارات', 'error');
    }
  }

  // ---------- Advanced Prediction System ----------
  function predictSales(data, months = 6) {
    // Simple linear regression for prediction
    if (data.length < 3) {
      return Array(months).fill(0);
    }
    
    // Convert data to numeric values
    const values = data.map((value, index) => ({
      x: index + 1,
      y: value
    }));
    
    // Calculate linear regression
    const n = values.length;
    let sumX = 0;
    let sumY = 0;
    let sumXY = 0;
    let sumX2 = 0;
    
    values.forEach(point => {
      sumX += point.x;
      sumY += point.y;
      sumXY += point.x * point.y;
      sumX2 += point.x * point.x;
    });
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    // Predict future values
    const predictions = [];
    for (let i = 1; i <= months; i++) {
      const prediction = slope * (n + i) + intercept;
      predictions.push(Math.max(0, prediction)); // Ensure non-negative
    }
    
    return predictions;
  }

  function calculateKPIs() {
    try {
      const kpis = {
        revenueGrowth: 0,
        profitMargin: 0,
        customerRetention: 0,
        inventoryTurnover: 0,
        debtToIncome: 0
      };
      
      // Calculate from dashboard data
      const salesProfit = toNumber(document.getElementById('statSalesProfit').textContent.replace(/[^\d.-]/g, ''));
      const maintenanceProfit = toNumber(document.getElementById('statMaintenanceProfit').textContent.replace(/[^\d.-]/g, ''));
      const totalRevenue = toNumber(document.getElementById('statRevenue').textContent.replace(/[^\d.-]/g, ''));
      
      if (totalRevenue > 0) {
        kpis.profitMargin = ((salesProfit + maintenanceProfit) / totalRevenue * 100).toFixed(2);
      }
      
      return kpis;
    } catch (error) {
      console.error('Error calculating KPIs:', error);
      return {};
    }
  }

  // ---------- Business Analytics ----------
  function analyzeProfitability() {
    // Analyze profitability by product/service
    // This would require detailed data analysis
    // For now, we'll just show a placeholder
    return {
      topProducts: [],
      topServices: [],
      profitabilityTrends: []
    };
  }

  function compareReports(period1, period2, type) {
    // Compare reports between two periods
    // This is a simplified version
    return {
      growth: 0,
      change: 0,
      trend: 'stable'
    };
  }

  // ---------- Basic UI Functions ----------
  function showSection(name) {
    // Check permissions
    if (name === 'users' && !checkPermission('users', 'read')) {
      showToast('❌ لا تملك صلاحية الوصول إلى إدارة المستخدمين', 'error');
      return;
    }
    
    if (name === 'backup' && !checkPermission('backup', 'create')) {
      showToast('❌ لا تملك صلاحية الوصول إلى النسخ الاحتياطي', 'error');
      return;
    }
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
      section.style.display = 'none';
    });
    
    // Show selected section
    const section = document.getElementById(name);
    if (section) {
      section.style.display = 'block';
      
      // Reset pagination for section
      paginationConfig.currentPage = 1;
      
      // Lazy load section
      lazyLoadSection(name);
      
      // Load section data
      switch(name) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'customers':
          loadCustomers();
          break;
        case 'products':
          loadProducts();
          break;
        case 'sales':
          loadInvoices();
          break;
        case 'maintenance':
          loadMaintenance();
          break;
        case 'parts':
          loadParts();
          break;
        case 'dealers':
          loadDealers();
          break;
        case 'expenses':
          loadExpenses();
          break;
        case 'commitments':
          loadCommitments();
          break;
        case 'bank':
          loadBank();
          break;
        case 'debts':
          loadDebts();
          break;
        case 'reports':
          loadReports();
          break;
        case 'users':
          loadUsers();
          break;
        case 'backup':
          setupBackup();
          break;
      }
    }
    
    // Update active nav
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
      link.classList.remove('active');
      if (link.getAttribute('data-section') === name) {
        link.classList.add('active');
      }
    });
  }

  function updateStorageBadge() {
    const badge = document.getElementById('storageBadge');
    if (badge) {
      badge.className = 'badge ' + (useFirebase ? 'bg-success' : 'bg-warning');
      badge.textContent = useFirebase ? 'Firebase' : 'Local';
      badge.title = useFirebase ? 'متصل بـ Firebase' : 'يستخدم التخزين المحلي';
    }
  }

  // ---------- Dashboard Functions ----------
  async function loadDashboard() {
    try {
      // Load all data
      const [customers, invoices, maintenance, products] = await Promise.all([
        load('customers'),
        load('invoices'),
        load('maintenance'),
        load('products')
      ]);
      
      // Apply date range filter
      const range = getCurrentDateRange('dashboard');
      let filteredInvoices = invoices;
      let filteredMaintenance = maintenance;
      let filteredCustomers = customers;
      
      if (range.from || range.to) {
        filteredInvoices = filterByDateRange(invoices, 'date', 'dashboard');
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dashboard');
        filteredCustomers = filterByDateRange(customers, 'createdAt', 'dashboard');
      }
      
      // Update stats
      document.getElementById('statCustomers').textContent = filteredCustomers.length;
      document.getElementById('statInvoices').textContent = filteredInvoices.length;
      document.getElementById('statMaintenance').textContent = filteredMaintenance.length;
      
      // Calculate revenues and profits
      let salesRevenue = 0;
      let salesCost = 0;
      filteredInvoices.forEach(inv => {
        salesRevenue += toNumber(inv.totalSell);
        salesCost += toNumber(inv.totalBuy);
      });
      
      let maintenanceRevenue = 0;
      let maintenanceCost = 0;
      filteredMaintenance.forEach(mnt => {
        maintenanceRevenue += toNumber(mnt.cost);
        maintenanceCost += toNumber(mnt.parts);
      });
      
      const totalRevenue = salesRevenue + maintenanceRevenue;
      const salesProfit = salesRevenue - salesCost;
      const maintenanceProfit = maintenanceRevenue - maintenanceCost;
      const totalProfit = salesProfit + maintenanceProfit;
      
      document.getElementById('statRevenue').textContent = currency(totalRevenue);
      document.getElementById('statSalesProfit').textContent = currency(salesProfit);
      document.getElementById('statMaintenanceProfit').textContent = currency(maintenanceProfit);
      document.getElementById('statNetProfit').textContent = currency(totalProfit);
      
      // Create charts with filtered data
      createCharts(filteredInvoices, filteredMaintenance, range);
      
      // Calculate KPIs
      const kpis = calculateKPIs();
      
      // Show KPI alerts
      if (kpis.profitMargin < 10) {
        createNotification('انخفاض الربحية', `هامش الربح الحالي ${kpis.profitMargin}% منخفض`, 'warning', 'high');
      }
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  }

  function createCharts(invoices, maintenance, range = null) {
    // Revenue Chart
    const ctx1 = document.getElementById('revenueChart');
    if (ctx1) {
      if (charts.revenue) charts.revenue.destroy();
      
      // Group by month based on date range
      let startDate, endDate;
      
      if (range && range.from && range.to) {
        startDate = new Date(range.from);
        endDate = new Date(range.to);
      } else {
        // Default: last 6 months
        const now = new Date();
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        startDate = new Date(now.getFullYear(), now.getMonth() - 5, 1);
      }
      
      const monthlyData = {};
      let currentDate = new Date(startDate);
      
      while (currentDate <= endDate) {
        const month = currentDate.getMonth() + 1;
        const year = currentDate.getFullYear();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        monthlyData[key] = { sales: 0, maintenance: 0 };
        
        // Move to next month
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
      
      invoices.forEach(inv => {
        const date = new Date(inv.date || inv.createdAt);
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        
        if (monthlyData[key]) {
          monthlyData[key].sales += toNumber(inv.totalSell);
        }
      });
      
      maintenance.forEach(mnt => {
        const date = new Date(mnt.received || mnt.createdAt);
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        
        if (monthlyData[key]) {
          monthlyData[key].maintenance += toNumber(mnt.cost);
        }
      });
      
      const labels = Object.keys(monthlyData).sort();
      const salesData = labels.map(key => monthlyData[key].sales);
      const maintData = labels.map(key => monthlyData[key].maintenance);
      
      charts.revenue = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: labels.map(label => {
            const [year, month] = label.split('-');
            return `${month}/${year}`;
          }),
          datasets: [
            {
              label: 'المبيعات',
              data: salesData,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.3,
              fill: true
            },
            {
              label: 'الصيانة',
              data: maintData,
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              rtl: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' دينار';
                }
              }
            }
          }
        }
      });
    }
    
    // Maintenance Type Chart
    const ctx2 = document.getElementById('maintenanceTypeChart');
    if (ctx2) {
      if (charts.maintenanceType) charts.maintenanceType.destroy();
      
      const maintenanceTypes = {
        in_shop: 0,
        delivery: 0
      };
      
      maintenance.forEach(mnt => {
        if (mnt.type === 'in_shop') {
          maintenanceTypes.in_shop += toNumber(mnt.cost);
        } else if (mnt.type === 'delivery') {
          maintenanceTypes.delivery += toNumber(mnt.cost);
        } else {
          // Default to in_shop for old records
          maintenanceTypes.in_shop += toNumber(mnt.cost);
        }
      });
      
      charts.maintenanceType = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['في المحل', 'توصيل'],
          datasets: [{
            data: [maintenanceTypes.in_shop, maintenanceTypes.delivery],
            backgroundColor: ['#3498db', '#2ecc71']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              rtl: true
            }
          }
        }
      });
    }
    
    // Prediction Chart
    const ctx3 = document.getElementById('predictionChart');
    if (ctx3) {
      if (charts.prediction) charts.prediction.destroy();
      
      // Get monthly sales data
      const now = new Date();
      const monthlySales = {};
      
      for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        monthlySales[key] = 0;
      }
      
      invoices.forEach(inv => {
        const date = new Date(inv.date || inv.createdAt);
        const month = date.getMonth() + 1;
        const year = date.getFullYear();
        const key = `${year}-${month.toString().padStart(2, '0')}`;
        
        if (monthlySales[key] !== undefined) {
          monthlySales[key] += toNumber(inv.totalSell);
        }
      });
      
      const historicalData = Object.values(monthlySales);
      const predictions = predictSales(historicalData, 3);
      
      // Create labels for historical and predicted data
      const historicalLabels = Object.keys(monthlySales).map(label => {
        const [year, month] = label.split('-');
        return `${month}/${year}`;
      });
      
      const predictionLabels = [];
      for (let i = 1; i <= 3; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        predictionLabels.push(`${date.getMonth() + 1}/${date.getFullYear()}`);
      }
      
      charts.prediction = new Chart(ctx3, {
        type: 'line',
        data: {
          labels: [...historicalLabels, ...predictionLabels],
          datasets: [
            {
              label: 'المبيعات الفعلية',
              data: [...historicalData, ...Array(3).fill(null)],
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.3,
              fill: false
            },
            {
              label: 'التنبؤ بالمبيعات',
              data: [...Array(historicalData.length - 1).fill(null), historicalData[historicalData.length - 1], ...predictions],
              borderColor: '#ffc107',
              borderDash: [5, 5],
              backgroundColor: 'rgba(255, 193, 7, 0.1)',
              tension: 0.3,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              rtl: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' دينار';
                }
              }
            }
          }
        }
      });
    }
  }

  // ---------- Advanced Customers Management ----------
  async function loadCustomers(page = 1) {
    try {
      const customers = await load('customers');
      const table = document.getElementById('customersTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredCustomers = filterByDateRange(customers, 'createdAt', 'customers');
      
      // Build search index
      buildSearchIndex('customers', filteredCustomers, ['name', 'phone', 'deviceType', 'address']);
      
      // Apply search filter if any
      const searchTerm = document.getElementById('searchCustomer')?.value.toLowerCase() || '';
      
      if (searchTerm) {
        filteredCustomers = searchInIndex('customers', searchTerm);
      }
      
      // Sort by date (newest first)
      filteredCustomers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      // Paginate data
      const paginated = paginateData(filteredCustomers, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="9" class="text-center text-muted py-3">لا توجد عملاء في الفترة المحددة</td>`;
        table.appendChild(row);
      } else {
        paginated.items.forEach((customer, index) => {
          const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${globalIndex}</td>
            <td>${escapeHtml(customer.name || '')}</td>
            <td>${escapeHtml(customer.deviceType || '')}</td>
            <td>${escapeHtml(customer.deviceSize || '')}</td>
            <td>${escapeHtml(customer.phone || '')}</td>
            <td>${escapeHtml(customer.address || '')}</td>
            <td>${dateOnly(customer.createdAt)}</td>
            <td><span class="badge bg-success">نشط</span></td>
            <td>
              <div class="action-btns">
                ${checkPermission('customers', 'update') ? `
                  <button class="btn btn-sm btn-outline-primary edit-customer" data-id="${customer.id}">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
                ${checkPermission('customers', 'delete') ? `
                  <button class="btn btn-sm btn-outline-danger delete-customer" data-id="${customer.id}">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          `;
          table.appendChild(row);
        });
      }
      
      // Create pagination
      createPagination(paginated.pages, page, 'customersPagination', loadCustomers);
      updatePaginationInfo('customersPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-customer').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editCustomer(id);
          });
        });
        
        document.querySelectorAll('.delete-customer').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteCustomer(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading customers:', error);
    }
  }

  async function editCustomer(id) {
    try {
      if (!checkPermission('customers', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل العملاء', 'error');
        return;
      }
      
      const customers = await load('customers');
      const customer = customers.find(c => c.id === id);
      if (!customer) return;
      
      document.getElementById('custId').value = customer.id;
      document.getElementById('custName').value = customer.name || '';
      document.getElementById('custDeviceType').value = customer.deviceType || '';
      document.getElementById('custDeviceSize').value = customer.deviceSize || '';
      document.getElementById('custPhone').value = customer.phone || '';
      document.getElementById('custAddress').value = customer.address || '';
      document.getElementById('custNotes').value = customer.notes || '';
      document.getElementById('customerModalTitle').textContent = 'تعديل عميل';
      
      showModal('customerModal');
      
    } catch (error) {
      console.error('Error editing customer:', error);
      showToast('❌ خطأ في تحميل بيانات العميل', 'error');
    }
  }

  async function deleteCustomer(id) {
    if (!checkPermission('customers', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف العملاء', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
      try {
        const customers = await load('customers');
        const filtered = customers.filter(c => c.id !== id);
        await save('customers', filtered);
        clearCache('customers');
        showToast('✅ تم حذف العميل بنجاح', 'success');
        loadCustomers();
      } catch (error) {
        console.error('Error deleting customer:', error);
        showToast('❌ خطأ في حذف العميل', 'error');
      }
    }
  }

  // ---------- Advanced Products Management ----------

  // ✅ Fix: Product CRUD (Add / Edit / Delete) wiring
  // NOTE: This block only touches Products behavior and uses the existing save/load storage layer.

  function openProductModal(mode, product = null) {
    const modalEl = document.getElementById('productModal');
    const form = document.getElementById('productForm');
    const titleEl = document.getElementById('productModalTitle');

    if (!modalEl || !form) return;

    // Reset form
    form.reset();

    // Fill
    const idEl = document.getElementById('prodId');
    const nameEl = document.getElementById('prodName');
    const buyEl = document.getElementById('prodBuy');
    const sellEl = document.getElementById('prodSell');
    const stockEl = document.getElementById('prodStock');

    if (mode === 'edit' && product) {
      if (titleEl) titleEl.textContent = 'تعديل المنتج';
      if (idEl) idEl.value = product.id || '';
      if (nameEl) nameEl.value = product.name || '';
      if (buyEl) buyEl.value = product.buyPrice ?? product.buy ?? '';
      if (sellEl) sellEl.value = product.sellPrice ?? product.sell ?? '';
      if (stockEl) stockEl.value = product.stock ?? '';
    } else {
      if (titleEl) titleEl.textContent = 'إضافة منتج';
      if (idEl) idEl.value = '';
    }

    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function readProductForm() {
    const id = (document.getElementById('prodId')?.value || '').trim();
    const name = (document.getElementById('prodName')?.value || '').trim();
    const buyPrice = parseFloat(document.getElementById('prodBuy')?.value || '0') || 0;
    const sellPrice = parseFloat(document.getElementById('prodSell')?.value || '0') || 0;
    const stock = parseInt(document.getElementById('prodStock')?.value || '0', 10) || 0;

    return { id, name, buyPrice, sellPrice, stock };
  }

  function newProductId() {
    // Simple stable ID (string) to match existing patterns
    return String(Date.now());
  }

  async function addOrUpdateProductFromForm() {
    const data = readProductForm();

    if (!data.name) {
      showToast('❌ يرجى إدخال اسم المنتج', 'error');
      return;
    }

    let products = await load('products', false);
    if (!Array.isArray(products)) products = [];

    if (data.id) {
      // Update existing
      const idx = products.findIndex(p => String(p.id) === String(data.id));
      if (idx === -1) {
        // If not found, treat as new (edge case)
        data.id = data.id || newProductId();
        products.push({ ...data });
      } else {
        products[idx] = { ...products[idx], ...data };
      }
      await save('products', products);
      showToast('✅ تم تعديل المنتج', 'success');
    } else {
      // Add new
      data.id = newProductId();
      products.push({ ...data });
      await save('products', products);
      showToast('✅ تم إضافة المنتج', 'success');
    }

    // Close modal
    const modalEl = document.getElementById('productModal');
    const modal = modalEl ? bootstrap.Modal.getInstance(modalEl) : null;
    if (modal) modal.hide();

    // Refresh list (keep current page 1 to avoid empty page after delete/add)
    loadProducts(1);
  }

  async function editProduct(id) {
    try {
      let products = await load('products', false);
      if (!Array.isArray(products)) products = [];
      const product = products.find(p => String(p.id) === String(id));
      if (!product) {
        showToast('❌ لم يتم العثور على المنتج', 'error');
        return;
      }
      openProductModal('edit', product);
    } catch (e) {
      console.error('editProduct error:', e);
      showToast('❌ حدث خطأ أثناء فتح التعديل', 'error');
    }
  }

  async function deleteProduct(id) {
    try {
      const ok = confirm('هل تريد حذف هذا المنتج؟');
      if (!ok) return;

      let products = await load('products', false);
      if (!Array.isArray(products)) products = [];

      const before = products.length;
      products = products.filter(p => String(p.id) !== String(id));

      if (products.length === before) {
        showToast('⚠️ المنتج غير موجود', 'warning');
        return;
      }

      await save('products', products);
      showToast('✅ تم حذف المنتج', 'success');
      loadProducts(1);
    } catch (e) {
      console.error('deleteProduct error:', e);
      showToast('❌ حدث خطأ أثناء الحذف', 'error');
    }
  }

  // Optional: safe view (does not affect other features)
  async function viewProduct(id) {
    try {
      let products = await load('products', false);
      if (!Array.isArray(products)) products = [];
      const product = products.find(p => String(p.id) === String(id));
      if (!product) return showToast('❌ لم يتم العثور على المنتج', 'error');

      const msg = `المنتج: ${product.name || ''}\nسعر الشراء: ${product.buyPrice ?? ''}\nسعر البيع: ${product.sellPrice ?? ''}\nالكمية: ${product.stock ?? ''}`;
      alert(msg);
    } catch (e) {
      console.error('viewProduct error:', e);
    }
  }

  // Wire "Add Product" button + form submit
  (function wireProductsUI(){
    const btn = document.getElementById('btnAddProduct');
    if (btn && !btn.__wired) {
      btn.__wired = true;
      btn.addEventListener('click', () => openProductModal('add'));
    }

    const form = document.getElementById('productForm');
    if (form && !form.__wired) {
      form.__wired = true;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        addOrUpdateProductFromForm();
      });
    }
  })();


async function loadProducts(page = 1) {
    console.log('🔄 بدء تحميل وعرض المنتجات - الصفحة:', page);
    
    try {
        // إظهار حالة التحميل
        const table = document.getElementById('productsTable');
        if (table) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                        جاري تحميل المنتجات...
                    </td>
                </tr>
            `;
        }
        
        // تحميل البيانات مع إجبار التحميل الجديد
        let products = [];
        
        // الطريقة المباشرة - تجاوز الكاش
        const localData = localStorage.getItem('wesam_products');
        if (localData) {
            try {
                products = JSON.parse(localData);
                console.log('📥 تم تحميل', products.length, 'منتج من localStorage');
            } catch (e) {
                console.error('❌ خطأ في تحليل بيانات المنتجات:', e);
                products = [];
            }
        }
        
        // إذا لم توجد بيانات، أنشئ بيانات افتراضية
        if (!products || !Array.isArray(products) || products.length === 0) {
            console.log('⚠️ لا توجد بيانات، سيتم إنشاء بيانات افتراضية...');
            products = createSampleProducts();
            await save('products', products);
        }
        
        console.log('📊 بيانات المنتجات المحملة:', products);
        
        // تطبيق فلترة البحث إذا وجدت
        const searchTerm = document.getElementById('searchProduct')?.value.toLowerCase() || '';
        let filteredProducts = [...products];
        
        if (searchTerm) {
            filteredProducts = products.filter(product => 
                product.name && product.name.toLowerCase().includes(searchTerm)
            );
            console.log('🔍 نتائج البحث:', filteredProducts.length, 'منتج');
        }
        
        // ترتيب المنتجات (الأحدث أولاً)
        filteredProducts.sort((a, b) => {
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        // التقطيع
        const pageSize = paginationConfig.pageSize;
        const totalItems = filteredProducts.length;
        const totalPages = Math.ceil(totalItems / pageSize);
        const startIndex = (page - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalItems);
        const currentItems = filteredProducts.slice(startIndex, endIndex);
        
        console.log('📄 التقطيع:', {
            totalItems,
            totalPages,
            currentPage: page,
            startIndex,
            endIndex,
            currentItemsCount: currentItems.length
        });
        
        // تحديث الجدول
        if (table) {
            if (currentItems.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                            ${searchTerm ? 'لا توجد منتجات تطابق البحث' : 'لا توجد منتجات في المستودع'}
                            <br>
                            <button class="btn btn-sm btn-primary mt-2" onclick="addSampleProducts()">
                                <i class="bi bi-plus-circle"></i> إضافة منتجات نموذجية
                            </button>
                        </td>
                    </tr>
                `;
            } else {
                let html = '';
                let totalBuyValue = 0;
                let totalStockCount = 0;
                
                currentItems.forEach((product, index) => {
                    const globalIndex = startIndex + index + 1;
                    const buyPrice = toNumber(product.buy);
                    const sellPrice = toNumber(product.sell);
                    const stock = toNumber(product.stock);
                    
                    totalBuyValue += buyPrice * stock;
                    totalStockCount += stock;
                    
                    html += `
                    <tr>
                        <td class="text-center">${globalIndex}</td>
                        <td>
                            <strong class="d-block">${escapeHtml(product.name || 'بدون اسم')}</strong>
                            <small class="text-muted">ID: ${product.id.substring(0, 8)}...</small>
                        </td>
                        <td class="text-end text-danger fw-bold">${currency(buyPrice)}</td>
                        <td class="text-end text-success fw-bold">${currency(sellPrice)}</td>
                        <td class="text-center">
                            <span class="badge ${stock <= 5 ? 'bg-danger' : stock <= 15 ? 'bg-warning' : 'bg-success'}">
                                <i class="bi bi-box"></i> ${stock} قطعة
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary edit-product" 
                                        data-id="${product.id}" title="تعديل">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-product" 
                                        data-id="${product.id}" title="حذف">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-outline-info view-product" 
                                        data-id="${product.id}" title="عرض التفاصيل">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                });
                
                table.innerHTML = html;
                
                // تحديث الإحصائيات
                document.getElementById('totalBuyPrice').textContent = currency(totalBuyValue);
                document.getElementById('totalProductsCount').textContent = totalStockCount.toLocaleString();
                
                console.log('✅ تم تحديث الجدول بـ', currentItems.length, 'صف');
                
                // إضافة المستمعين للأحداث
                setTimeout(() => {
                    // مستمعين للتعديل
                    document.querySelectorAll('.edit-product').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id');
                            console.log('تعديل المنتج:', id);
                            editProduct(id);
                        });
                    });
                    
                    // مستمعين للحذف
                    document.querySelectorAll('.delete-product').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id');
                            console.log('حذف المنتج:', id);
                            deleteProduct(id);
                        });
                    });
                    
                    // مستمعين للعرض
                    document.querySelectorAll('.view-product').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id');
                            console.log('عرض المنتج:', id);
                            viewProductDetails(id);
                        });
                    });
                }, 100);
            }
        }
        
        // تحديث التقطيع
        createPagination(totalPages, page, 'productsPagination', (newPage) => {
            console.log('📄 تغيير الصفحة إلى:', newPage);
            loadProducts(newPage);
        });
        
        // تحديث معلومات التقطيع
        updatePaginationInfo('productsPaginationInfo', {
            total: totalItems,
            currentPage: page,
            pageSize: pageSize
        });
        
        console.log('✅ تم تحميل وعرض المنتجات بنجاح');
        
    } catch (error) {
        console.error('❌ خطأ فادح في تحميل المنتجات:', error);
        
        const table = document.getElementById('productsTable');
        if (table) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                        <strong>خطأ في تحميل المنتجات</strong>
                        <div class="small mt-1">${error.message}</div>
                        <button class="btn btn-sm btn-warning mt-3" onclick="forceReloadProducts()">
                            <i class="bi bi-arrow-clockwise"></i> إعادة المحاولة بقوة
                        </button>
                    </td>
                </tr>
            `;
        }
    }
}

// دالة مساعدة لإنشاء منتجات نموذجية
function createSampleProducts() {
    return [
        {
            id: 'prod_' + Date.now() + '_1',
            name: 'لابتوب ديل إكس بي إس 13',
            buy: 4500,
            sell: 5800,
            stock: 7,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_2',
            name: 'ماوس لوجيتك إم إكس ماستر 3',
            buy: 120,
            sell: 180,
            stock: 22,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_3',
            name: 'شاشة سامسونج أوديسي جي 7 32 بوصة',
            buy: 2200,
            sell: 2900,
            stock: 5,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_4',
            name: 'كيبورد كوريغير كي 70',
            buy: 350,
            sell: 480,
            stock: 12,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_5',
            name: 'سماعات سوني وايرلس',
            buy: 180,
            sell: 250,
            stock: 18,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_6',
            name: 'كاميرا لوجيتك برو 9000',
            buy: 420,
            sell: 550,
            stock: 9,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_7',
            name: 'ماسح ضوئي كانون LiDE 400',
            buy: 280,
            sell: 380,
            stock: 6,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_8',
            name: 'طابعة ليزر إتش بي 107a',
            buy: 650,
            sell: 850,
            stock: 4,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_9',
            name: 'راوتر تي بي-لينك آرتشر AX73',
            buy: 320,
            sell: 450,
            stock: 11,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 'prod_' + Date.now() + '_10',
            name: 'هارد ديسك ويسترن ديجيتال 2TB',
            buy: 280,
            sell: 380,
            stock: 15,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        }
    ];
}

// دالة عرض تفاصيل المنتج
async function viewProductDetails(productId) {
    try {
        const products = await load('products');
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            showToast('❌ المنتج غير موجود', 'error');
            return;
        }
        
        const modalContent = `
            <div class="product-details">
                <h5 class="border-bottom pb-2 mb-3">${escapeHtml(product.name)}</h5>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th>سعر الشراء:</th>
                                <td class="text-danger fw-bold">${currency(product.buy)}</td>
                            </tr>
                            <tr>
                                <th>سعر البيع:</th>
                                <td class="text-success fw-bold">${currency(product.sell)}</td>
                            </tr>
                            <tr>
                                <th>الربح لكل قطعة:</th>
                                <td class="text-info fw-bold">${currency(toNumber(product.sell) - toNumber(product.buy))}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th>الكمية في المخزون:</th>
                                <td>
                                    <span class="badge ${toNumber(product.stock) <= 5 ? 'bg-danger' : 'bg-success'} fs-6">
                                        ${product.stock} قطعة
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>إجمالي قيمة الشراء:</th>
                                <td>${currency(toNumber(product.buy) * toNumber(product.stock))}</td>
                            </tr>
                            <tr>
                                <th>تاريخ الإضافة:</th>
                                <td>${dateOnly(product.createdAt)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                ${product.notes ? `
                <div class="mt-3">
                    <h6>ملاحظات:</h6>
                    <div class="alert alert-light">${escapeHtml(product.notes)}</div>
                </div>
                ` : ''}
            </div>
        `;
        
        // إنشاء مودال ديناميكي
        const modalId = 'productDetailsModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">تفاصيل المنتج</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="${modalId}Body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            <button type="button" class="btn btn-primary" onclick="editProduct('${productId}')" data-bs-dismiss="modal">
                                <i class="bi bi-pencil"></i> تعديل
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById(modalId + 'Body').innerHTML = modalContent;
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
    } catch (error) {
        console.error('خطأ في عرض تفاصيل المنتج:', error);
        showToast('❌ خطأ في عرض التفاصيل', 'error');
    }
}

// دالة لإعادة التحميل القسري
async function forceReloadProducts() {
    console.log('🔄 إعادة تحميل المنتجات بقوة...');
    
    // مسح الكاش
    clearCache('products');
    
    // إعادة تحميل البيانات من المصدر مباشرة
    const localData = localStorage.getItem('wesam_products');
    if (localData) {
        try {
            const products = JSON.parse(localData);
            console.log('✅ تم تحميل', products.length, 'منتج مباشرة من localStorage');
            
            // تحديث الكاش
            cache.data['products'] = products;
            cache.timestamps['products'] = Date.now();
            cache.usage['products'] = Date.now();
            
            // إعادة تحميل الجدول
            loadProducts();
            
            showToast('✅ تم إعادة تحميل المنتجات بنجاح', 'success');
            
        } catch (error) {
            console.error('❌ خطأ في تحليل البيانات:', error);
            showToast('❌ بيانات المنتجات تالفة', 'error');
        }
    } else {
        console.log('⚠️ لا توجد بيانات محلية');
        showToast('⚠️ لا توجد بيانات محلية للمنتجات', 'warning');
    }
}

// جعل الدوال متاحة عالمياً
// ... جميع الدوال السابقة ...



window.viewProductDetails = viewProductDetails;
window.forceReloadProducts = forceReloadProducts;
window.addSampleProducts = async function() {
    const sampleProducts = createSampleProducts();
    const currentProducts = await load('products');
    const updatedProducts = [...currentProducts, ...sampleProducts];
    
    await save('products', updatedProducts);
    showToast('✅ تم إضافة 10 منتجات نموذجية', 'success');
    loadProducts();
};
  // ---------- Advanced Invoices Management ----------
  async function loadInvoices(page = 1) {
    try {
      const invoices = await load('invoices');
      const customers = await load('customers');
      const table = document.getElementById('invoicesTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredInvoices = filterByDateRange(invoices, 'date', 'sales');
      
      // Sort by date (newest first)
      filteredInvoices.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
      
      // Paginate data
      const paginated = paginateData(filteredInvoices, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="12" class="text-center text-muted py-3">لا توجد فواتير في الفترة المحددة</td>`;
        table.appendChild(row);
        return;
      }
      
      paginated.items.forEach((invoice, index) => {
        const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
        const customer = customers.find(c => c.id === invoice.customerId);
        const customerName = invoice.customerId === 'anonymous' ? 'عميل بدون اسم' : (customer ? customer.name : 'غير معروف');
        const itemsCount = invoice.items ? invoice.items.length : 0;
        const totalQuantity = invoice.items ? invoice.items.reduce((sum, item) => sum + toNumber(item.quantity), 0) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${invoice.number || 'N/A'}</td>
          <td>${escapeHtml(customerName)}</td>
          <td>${itemsCount} منتجات</td>
          <td>${totalQuantity}</td>
          <td>${dateOnly(invoice.date)}</td>
          <td>${currency(invoice.totalSell)}</td>
          <td>${currency(invoice.totalBuy)}</td>
          <td>${currency(invoice.net)}</td>
          <td>${invoice.paymentMethod === 'cash' ? 'كاش' : 'حوالة'}</td>
          <td>
            <span class="badge ${invoice.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning'}">
              ${invoice.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع'}
            </span>
          </td>
          <td>
            <div class="action-btns">
              <button class="btn btn-sm btn-outline-info view-invoice" data-id="${invoice.id}">
                <i class="bi bi-eye"></i>
              </button>
              ${checkPermission('invoices', 'delete') ? `
                <button class="btn btn-sm btn-outline-danger delete-invoice" data-id="${invoice.id}">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        `;
        table.appendChild(row);
      });
      
      // Create pagination
      createPagination(paginated.pages, page, 'invoicesPagination', loadInvoices);
      updatePaginationInfo('invoicesPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.view-invoice').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            viewInvoice(id);
          });
        });
        
        document.querySelectorAll('.delete-invoice').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteInvoice(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading invoices:', error);
    }
  }

  async function viewInvoice(id) {
    try {
      const invoices = await load('invoices');
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) return;
      
      const customers = await load('customers');
      const customer = customers.find(c => c.id === invoice.customerId);
      const products = await load('products');
      
      let invoiceDetails = `
        <div class="invoice-details">
          <h5>فاتورة رقم: ${invoice.number || 'N/A'}</h5>
          <p><strong>العميل:</strong> ${invoice.customerId === 'anonymous' ? 'عميل بدون اسم' : (customer ? customer.name : 'غير معروف')}</p>
          <p><strong>التاريخ:</strong> ${dateOnly(invoice.date)}</p>
          <p><strong>طريقة الدفع:</strong> ${invoice.paymentMethod === 'cash' ? 'كاش' : 'حوالة بنكية'}</p>
          <p><strong>حالة الدفع:</strong> ${invoice.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع'}</p>
          <hr>
          <h6>المنتجات:</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>المنتج</th>
                <th>الكمية</th>
                <th>سعر الشراء</th>
                <th>سعر البيع</th>
                <th>المجموع</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      if (invoice.items) {
        invoice.items.forEach(item => {
          const product = products.find(p => p.id === item.productId);
          const productName = product ? product.name : 'غير معروف';
          invoiceDetails += `
            <tr>
              <td>${escapeHtml(productName)}</td>
              <td>${item.quantity}</td>
              <td>${currency(item.buy)}</td>
              <td>${currency(item.sell)}</td>
              <td>${currency(item.quantity * item.sell)}</td>
            </tr>
          `;
        });
      }
      
      invoiceDetails += `
            </tbody>
          </table>
          <hr>
          <p><strong>إجمالي سعر البيع:</strong> ${currency(invoice.totalSell)}</p>
          <p><strong>إجمالي سعر الشراء:</strong> ${currency(invoice.totalBuy)}</p>
          <p><strong>صافي الفاتورة:</strong> ${currency(invoice.net)}</p>
          ${invoice.notes ? `<p><strong>ملاحظات:</strong> ${escapeHtml(invoice.notes)}</p>` : ''}
        </div>
      `;
      
      // Show in modal instead of alert
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'invoiceDetailsModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">تفاصيل الفاتورة</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              ${invoiceDetails}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
              <button type="button" class="btn btn-primary" onclick="window.print()">طباعة</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
      });
      
    } catch (error) {
      console.error('Error viewing invoice:', error);
      showToast('❌ خطأ في عرض الفاتورة', 'error');
    }
  }

  async function deleteInvoice(id) {
    if (!checkPermission('invoices', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف الفواتير', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
      try {
        const invoices = await load('invoices');
        const filtered = invoices.filter(i => i.id !== id);
        await save('invoices', filtered);
        clearCache('invoices');
        showToast('✅ تم حذف الفاتورة بنجاح', 'success');
        loadInvoices();
      } catch (error) {
        console.error('Error deleting invoice:', error);
        showToast('❌ خطأ في حذف الفاتورة', 'error');
      }
    }
  }

  // ---------- Advanced Maintenance Management ----------
  async function loadMaintenance(page = 1) {
    try {
      const maintenance = await load('maintenance');
      const customers = await load('customers');
      const dealers = await load('dealers');
      const table = document.getElementById('maintenanceTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredMaintenance = filterByDateRange(maintenance, 'received', 'maintenance');
      
      // Sort by date (newest first)
      filteredMaintenance.sort((a, b) => new Date(b.received || b.createdAt) - new Date(a.received || a.createdAt));
      
      // Paginate data
      const paginated = paginateData(filteredMaintenance, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="14" class="text-center text-muted py-3">لا توجد أوامر صيانة في الفترة المحددة</td>`;
        table.appendChild(row);
        return;
      }
      
      paginated.items.forEach((order, index) => {
        const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
        const customer = customers.find(c => c.id === order.customerId);
        const dealer = dealers.find(d => d.id === order.partsDealerId);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${order.number || 'N/A'}</td>
          <td>${escapeHtml(customer ? customer.name : 'غير معروف')}</td>
          <td>${escapeHtml(order.device || '')}</td>
          <td>${getMaintenanceTypeText(order.type)}</td>
          <td>${currency(order.cost)}</td>
          <td>${currency(order.parts)}</td>
          <td>${escapeHtml(dealer ? dealer.name : '')}</td>
          <td>${currency(order.net)}</td>
          <td>${order.paymentMethod === 'cash' ? 'كاش' : 'حوالة'}</td>
          <td>
            <span class="badge ${getStatusBadge(order.status)}">
              ${getStatusText(order.status)}
            </span>
          </td>
          <td>${dateOnly(order.warranty)}</td>
          <td>
            <span class="badge ${order.paymentStatus === 'paid' ? 'bg-success' : 'bg-warning'}">
              ${order.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع'}
            </span>
          </td>
          <td>
            <div class="action-btns">
              ${checkPermission('maintenance', 'update') ? `
                <button class="btn btn-sm btn-outline-primary edit-maintenance" data-id="${order.id}">
                  <i class="bi bi-pencil"></i>
                </button>
              ` : ''}
              ${checkPermission('maintenance', 'delete') ? `
                <button class="btn btn-sm btn-outline-danger delete-maintenance" data-id="${order.id}">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        `;
        table.appendChild(row);
      });
      
      // Create pagination
      createPagination(paginated.pages, page, 'maintenancePagination', loadMaintenance);
      updatePaginationInfo('maintenancePaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-maintenance').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editMaintenance(id);
          });
        });
        
        document.querySelectorAll('.delete-maintenance').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteMaintenance(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading maintenance:', error);
    }
  }

  function getMaintenanceTypeText(type) {
    const types = {
      'in_shop': 'في المحل',
      'delivery': 'توصيل'
    };
    return types[type] || 'في المحل';
  }

  function getStatusBadge(status) {
    switch(status) {
      case 'new': return 'bg-primary';
      case 'in_progress': return 'bg-warning';
      case 'completed': return 'bg-success';
      case 'cancelled': return 'bg-danger';
      default: return 'bg-secondary';
    }
  }

  function getStatusText(status) {
    switch(status) {
      case 'new': return 'جديد';
      case 'in_progress': return 'قيد التنفيذ';
      case 'completed': return 'مكتمل';
      case 'cancelled': return 'ملغاة';
      default: return status;
    }
  }

  async function editMaintenance(id) {
    try {
      if (!checkPermission('maintenance', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل الصيانة', 'error');
        return;
      }
      
      const maintenance = await load('maintenance');
      const order = maintenance.find(m => m.id === id);
      if (!order) return;
      
      document.getElementById('mntId').value = order.id;
      document.getElementById('mntCost').value = order.cost || '';
      document.getElementById('mntParts').value = order.parts || '';
      document.getElementById('mntNet').value = order.net || '';
      document.getElementById('mntDevice').value = order.device || '';
      document.getElementById('mntType').value = order.type || 'in_shop';
      document.getElementById('mntReceived').value = dateOnly(order.received);
      document.getElementById('mntDelivery').value = dateOnly(order.delivery);
      document.getElementById('mntWarranty').value = dateOnly(order.warranty);
      document.getElementById('mntPaymentMethod').value = order.paymentMethod || 'cash';
      document.getElementById('mntPaymentStatus').value = order.paymentStatus || 'pending';
      document.getElementById('mntStatus').value = order.status || 'new';
      document.getElementById('mntNotes').value = order.notes || '';
      document.getElementById('maintenanceModalTitle').textContent = 'تعديل أمر صيانة';
      
      // Load customers and dealers into select
      await populateSelects();
      document.getElementById('mntCustomer').value = order.customerId || '';
      document.getElementById('mntPartsDealer').value = order.partsDealerId || '';
      
      showModal('maintenanceModal');
      
    } catch (error) {
      console.error('Error editing maintenance:', error);
      showToast('❌ خطأ في تحميل بيانات الصيانة', 'error');
    }
  }

  async function deleteMaintenance(id) {
    if (!checkPermission('maintenance', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف الصيانة', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف أمر الصيانة هذا؟')) {
      try {
        const maintenance = await load('maintenance');
        const filtered = maintenance.filter(m => m.id !== id);
        await save('maintenance', filtered);
        clearCache('maintenance');
        showToast('✅ تم حذف أمر الصيانة بنجاح', 'success');
        loadMaintenance();
      } catch (error) {
        console.error('Error deleting maintenance:', error);
        showToast('❌ خطأ في حذف أمر الصيانة', 'error');
      }
    }
  }

  // ---------- Advanced Parts Management ----------
  async function loadParts(page = 1) {
    try {
      const parts = await load('parts');
      const dealers = await load('dealers');
      const table = document.getElementById('partsTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredParts = filterByDateRange(parts, 'createdAt', 'parts', true);
      
      // Build search index
      buildSearchIndex('parts', filteredParts, ['name', 'type']);
      
      // Apply search filter if any (with debouncing)
      const searchTerm = document.getElementById('searchPart')?.value.toLowerCase() || '';
      
      if (searchTerm) {
        filteredParts = searchInIndex('parts', searchTerm);
      }
      
      // Paginate data
      const paginated = paginateData(filteredParts, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" class="text-center text-muted py-3">لا توجد قطع في الفترة المحددة</td>`;
        table.appendChild(row);
        return;
      }
      
      paginated.items.forEach((part, index) => {
        const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
        const dealer = dealers.find(d => d.id === part.supplierId);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${escapeHtml(part.name || '')}</td>
          <td>${escapeHtml(part.type || '')}</td>
          <td>${currency(part.buy)}</td>
          <td>${currency(part.sell)}</td>
          <td>
            <span class="${toNumber(part.stock) <= 5 ? 'text-danger fw-bold' : ''}">
              ${part.stock}
            </span>
          </td>
          <td>${escapeHtml(dealer ? dealer.name : '')}</td>
          <td>
            <div class="action-btns">
              ${checkPermission('parts', 'update') ? `
                <button class="btn btn-sm btn-outline-primary edit-part" data-id="${part.id}">
                  <i class="bi bi-pencil"></i>
                </button>
              ` : ''}
              ${checkPermission('parts', 'delete') ? `
                <button class="btn btn-sm btn-outline-danger delete-part" data-id="${part.id}">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        `;
        table.appendChild(row);
      });
      
      // Create pagination
      createPagination(paginated.pages, page, 'partsPagination', loadParts);
      updatePaginationInfo('partsPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-part').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editPart(id);
          });
        });
        
        document.querySelectorAll('.delete-part').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deletePart(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading parts:', error);
    }
  }

  async function editPart(id) {
    try {
      if (!checkPermission('parts', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل القطع', 'error');
        return;
      }
      
      const parts = await load('parts');
      const part = parts.find(p => p.id === id);
      if (!part) return;
      
      document.getElementById('partId').value = part.id;
      document.getElementById('partName').value = part.name || '';
      document.getElementById('partType').value = part.type || '';
      document.getElementById('partBuy').value = part.buy || '';
      document.getElementById('partSell').value = part.sell || '';
      document.getElementById('partStock').value = part.stock || '';
      document.getElementById('partModalTitle').textContent = 'تعديل قطعة';
      
      // Load dealers into select
      const dealers = await load('dealers');
      const supplierSelect = document.getElementById('partSupplier');
      supplierSelect.innerHTML = '<option value="">-- اختر التاجر --</option>';
      dealers.forEach(dealer => {
        const option = document.createElement('option');
        option.value = dealer.id;
        option.textContent = dealer.name;
        supplierSelect.appendChild(option);
      });
      supplierSelect.value = part.supplierId || '';
      
      showModal('partModal');
      
    } catch (error) {
      console.error('Error editing part:', error);
      showToast('❌ خطأ في تحميل بيانات القطعة', 'error');
    }
  }

  async function deletePart(id) {
    if (!checkPermission('parts', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف القطع', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذه القطعة؟')) {
      try {
        const parts = await load('parts');
        const filtered = parts.filter(p => p.id !== id);
        await save('parts', filtered);
        clearCache('parts');
        showToast('✅ تم حذف القطعة بنجاح', 'success');
        loadParts();
      } catch (error) {
        console.error('Error deleting part:', error);
        showToast('❌ خطأ في حذف القطعة', 'error');
      }
    }
  }

  // ---------- Advanced Dealers Management ----------
  async function loadDealers(page = 1) {
    try {
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      // Apply date range filter to transactions
      const range = getCurrentDateRange('dealers');
      let filteredMaintenance = maintenance;
      let filteredParts = parts;
      let filteredPayments = dealerPayments;
      
      if (range.from || range.to) {
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dealers');
        filteredParts = filterByDateRange(parts, 'createdAt', 'dealers', true);
        filteredPayments = filterByDateRange(dealerPayments, 'date', 'dealers');
      }
      
      // Build search index
      buildSearchIndex('dealers', dealers, ['name', 'specialty', 'phone']);
      
      // Apply search filter if any (with debouncing)
      const searchTerm = document.getElementById('searchDealer')?.value.toLowerCase() || '';
      let filteredDealers = dealers;
      
      if (searchTerm) {
        filteredDealers = searchInIndex('dealers', searchTerm);
      }
      
      // Calculate dealer balances and payments based on filtered transactions
      filteredDealers = filteredDealers.map(dealer => {
        let totalPurchases = 0;
        let totalPayments = 0;
        
        // Calculate total purchases from maintenance
        filteredMaintenance.forEach(mnt => {
          if (mnt.partsDealerId === dealer.id) {
            totalPurchases += toNumber(mnt.parts);
          }
        });
        
        // Calculate total purchases from parts inventory
        filteredParts.forEach(part => {
          if (part.supplierId === dealer.id) {
            totalPurchases += toNumber(part.buy) * toNumber(part.stock);
          }
        });
        
        // Calculate total payments from dealerPayments
        const dealerPaymentRecords = filteredPayments.filter(payment => payment.dealerId === dealer.id);
        dealerPaymentRecords.forEach(payment => {
          totalPayments += toNumber(payment.amount);
        });
        
        // Calculate remaining balance (المشتريات - المدفوعات)
        const remaining = totalPurchases - totalPayments;
        
        // Find last transaction date
        let lastTransaction = dealer.lastTransaction || null;
        
        // Check from maintenance
        const lastMaintenance = filteredMaintenance
          .filter(mnt => mnt.partsDealerId === dealer.id)
          .sort((a, b) => new Date(b.received || b.createdAt) - new Date(a.received || a.createdAt))[0];
        
        if (lastMaintenance && (!lastTransaction || new Date(lastMaintenance.received || lastMaintenance.createdAt) > new Date(lastTransaction))) {
          lastTransaction = lastMaintenance.received || lastMaintenance.createdAt;
        }
        
        // Check from payments
        const lastPayment = filteredPayments
          .filter(payment => payment.dealerId === dealer.id)
          .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        
        if (lastPayment && (!lastTransaction || new Date(lastPayment.date) > new Date(lastTransaction))) {
          lastTransaction = lastPayment.date;
        }
        
        return { ...dealer,
          totalPurchases,
          totalPayments,
          remaining,
          lastTransaction
        };
      });
      
      // Paginate data
      const paginated = paginateData(filteredDealers, page, paginationConfig.pageSize);
      
      const table = document.getElementById('dealersTable');
      if (!table) return;
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="10" class="text-center text-muted py-3">لا توجد تجار في الفترة المحددة</td>`;
        table.appendChild(row);
      } else {
        paginated.items.forEach((dealer, index) => {
          const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${globalIndex}</td>
            <td>${escapeHtml(dealer.name || '')}</td>
            <td>${escapeHtml(dealer.specialty || '')}</td>
            <td>${escapeHtml(dealer.phone || '')}</td>
            <td>${escapeHtml(dealer.address || '')}</td>
            <td>${currency(dealer.totalPurchases)}</td>
            <td>${currency(dealer.totalPayments)}</td>
            <td class="${dealer.remaining > 0 ? 'text-danger' : 'text-success'}">
              ${currency(dealer.remaining)}
            </td>
            <td>${dealer.lastTransaction ? dateOnly(dealer.lastTransaction) : 'لا توجد معاملات'}</td>
            <td>
              <div class="action-btns">
                ${checkPermission('dealers', 'update') ? `
                  <button class="btn btn-sm btn-outline-primary edit-dealer" data-id="${dealer.id}">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
                ${checkPermission('dealers', 'delete') ? `
                  <button class="btn btn-sm btn-outline-danger delete-dealer" data-id="${dealer.id}">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
                <button class="btn btn-sm btn-outline-info view-dealer-transactions" data-id="${dealer.id}" title="عرض المعاملات">
                  <i class="bi bi-list"></i>
                </button>
                ${checkPermission('dealers', 'update') ? `
                  <button class="btn btn-sm btn-outline-success add-dealer-payment" data-id="${dealer.id}" title="إضافة دفعة">
                    <i class="bi bi-cash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          `;
          table.appendChild(row);
        });
      }
      
      // Create pagination
      createPagination(paginated.pages, page, 'dealersPagination', loadDealers);
      updatePaginationInfo('dealersPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-dealer').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editDealer(id);
          });
        });
        
        document.querySelectorAll('.delete-dealer').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteDealer(id);
          });
        });
        
        document.querySelectorAll('.view-dealer-transactions').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            viewDealerTransactions(id);
          });
        });
        
        document.querySelectorAll('.add-dealer-payment').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            addDealerPayment(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading dealers:', error);
    }
  }

  async function viewDealerTransactions(dealerId) {
    try {
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      const dealer = dealers.find(d => d.id === dealerId);
      if (!dealer) return;
      
      // Apply date range filter
      const range = getCurrentDateRange('dealers');
      let filteredMaintenance = maintenance;
      let filteredParts = parts;
      let filteredPayments = dealerPayments;
      
      if (range.from || range.to) {
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dealers');
        filteredParts = filterByDateRange(parts, 'createdAt', 'dealers', true);
        filteredPayments = filterByDateRange(dealerPayments, 'date', 'dealers');
      }
      
      let transactions = [];
      let totalPurchases = 0;
      let totalPayments = 0;
      
      // Collect maintenance transactions
      filteredMaintenance.forEach(mnt => {
        if (mnt.partsDealerId === dealerId && toNumber(mnt.parts) > 0) {
          transactions.push({
            type: 'صيانة',
            description: `أمر صيانة #${mnt.number} - ${mnt.device || ''}`,
            date: mnt.received || mnt.createdAt,
            amount: toNumber(mnt.parts),
            isCredit: true // زيادة في الدين (مشتريات)
          });
          totalPurchases += toNumber(mnt.parts);
        }
      });
      
      // Collect parts inventory transactions
      filteredParts.forEach(part => {
        if (part.supplierId === dealerId) {
          const cost = toNumber(part.buy) * toNumber(part.stock);
          if (cost > 0) {
            transactions.push({
              type: 'مخزون',
              description: `${part.name} - ${part.stock} قطعة`,
              date: part.createdAt,
              amount: cost,
              isCredit: true // زيادة في الدين (مشتريات)
            });
            totalPurchases += cost;
          }
        }
      });
      
      // Collect payment transactions
      const dealerPaymentRecords = filteredPayments.filter(payment => payment.dealerId === dealerId);
      dealerPaymentRecords.forEach(payment => {
        transactions.push({
          type: 'دفعة',
          description: payment.notes || 'دفعة نقدية',
          date: payment.date,
          amount: toNumber(payment.amount),
          isCredit: false, // تخفيض في الدين (مدفوعات)
          paymentId: payment.id
        });
        totalPayments += toNumber(payment.amount);
      });
      
      // Sort by date (newest first)
      transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Create transaction details
      let transactionDetails = `
        <div class="dealer-transactions">
          <h5>معاملات التاجر: ${escapeHtml(dealer.name)}</h5>
          <p><strong>الفترة المحددة:</strong> ${range.from ? dateOnly(range.from) : 'بدون بداية'} - ${range.to ? dateOnly(range.to) : 'بدون نهاية'}</p>
          <p><strong>إجمالي المشتريات في الفترة:</strong> ${currency(totalPurchases)}</p>
          <p><strong>إجمالي المدفوعات في الفترة:</strong> ${currency(totalPayments)}</p>
          <p><strong>الباقي في الفترة:</strong> ${currency(totalPurchases - totalPayments)}</p>
          <hr>
          <h6>تفاصيل المعاملات في الفترة المحددة:</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>النوع</th>
                <th>الوصف</th>
                <th>التاريخ</th>
                <th>المبلغ</th>
                <th>الرصيد المتراكم</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      let runningBalance = 0;
      let transactionNumber = 1;
      
      transactions.forEach((trans) => {
        if (trans.isCredit) {
          runningBalance += trans.amount;
        } else {
          runningBalance -= trans.amount;
        }
        
        transactionDetails += `
          <tr>
            <td>${trans.type}</td>
            <td>
              ${escapeHtml(trans.description)}
              ${trans.paymentId ? `
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="editDealerPayment('${"${trans.paymentId}"}')">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="deleteDealerPayment('${"${trans.paymentId}"}')">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </td>
            <td>${dateOnly(trans.date)}</td>
            <td class="${trans.isCredit ? 'text-danger' : 'text-success'}">
              ${trans.isCredit ? '+' : '-'}${currency(trans.amount)}
            </td>
            <td>${currency(runningBalance)}</td>
          </tr>
        `;
        transactionNumber++;
      });
      
      transactionDetails += `
            </tbody>
          </table>
        </div>
      `;
      
      // Show in modal
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'dealerTransactionsModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">معاملات التاجر</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              ${transactionDetails}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
      });
      
    } catch (error) {
      console.error('Error viewing dealer transactions:', error);
      showToast('❌ خطأ في عرض معاملات التاجر', 'error');
    }
  }

  async function addDealerPayment(dealerId) {
    try {
      if (!checkPermission('dealers', 'update')) {
        showToast('❌ لا تملك صلاحية إضافة دفعات', 'error');
        return;
      }
      
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      const dealer = dealers.find(d => d.id === dealerId);
      if (!dealer) return;
      
      // Apply date range filter for calculation
      const range = getCurrentDateRange('dealers');
      let filteredMaintenance = maintenance;
      let filteredParts = parts;
      let filteredPayments = dealerPayments;
      
      if (range.from || range.to) {
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dealers');
        filteredParts = filterByDateRange(parts, 'createdAt', 'dealers', true);
        filteredPayments = filterByDateRange(dealerPayments, 'date', 'dealers');
      }
      
      // Calculate current balances within the date range
      let totalPurchases = 0;
      let totalPayments = 0;
      
      // Calculate total purchases from maintenance
      filteredMaintenance.forEach(mnt => {
        if (mnt.partsDealerId === dealerId) {
          totalPurchases += toNumber(mnt.parts);
        }
      });
      
      // Calculate total purchases from parts inventory
      filteredParts.forEach(part => {
        if (part.supplierId === dealerId) {
          totalPurchases += toNumber(part.buy) * toNumber(part.stock);
        }
      });
      
      // Calculate total payments from dealerPayments
      const dealerPaymentRecords = filteredPayments.filter(payment => payment.dealerId === dealerId);
      dealerPaymentRecords.forEach(payment => {
        totalPayments += toNumber(payment.amount);
      });
      
      const remaining = totalPurchases - totalPayments;
      
      // Fill the payment form
      document.getElementById('dealerPaymentId').value = '';
      document.getElementById('paymentDealerId').value = dealerId;
      document.getElementById('paymentDealerName').value = dealer.name;
      document.getElementById('paymentTotalPurchases').value = totalPurchases;
      document.getElementById('paymentCurrentPayments').value = totalPayments;
      document.getElementById('paymentCurrentRemaining').value = remaining;
      document.getElementById('paymentAmount').value = '';
      document.getElementById('paymentDate').value = dateOnly(new Date());
      document.getElementById('paymentMethod').value = 'cash';
      document.getElementById('paymentNotes').value = '';
      
      const modal = new bootstrap.Modal(document.getElementById('dealerPaymentModal'));
      modal.show();
      
    } catch (error) {
      console.error('Error opening dealer payment modal:', error);
      showToast('❌ خطأ في فتح نموذج الدفعة', 'error');
    }
  }

  
  async function editDealerPayment(paymentId) {
    try {
      if (!checkPermission('dealers', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل دفعات', 'error');
        return;
      }
      
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      // تأكد من صحة البيانات
      if (!Array.isArray(dealerPayments)) {
        showToast('❌ لا توجد بيانات دفعات', 'error');
        return;
      }
      
      const payment = dealerPayments.find(p => p.id === paymentId);
      if (!payment) {
        showToast('❌ تعذر العثور على هذه الدفعة', 'error');
        return;
      }
      
      const dealerId = payment.dealerId;
      const dealer = dealers.find(d => d.id === dealerId);
      if (!dealer) {
        showToast('❌ تعذر العثور على التاجر المرتبط بهذه الدفعة', 'error');
        return;
      }
      
      // Apply date range filter for calculation (نفس منطق إضافة الدفعة)
      const range = getCurrentDateRange('dealers');
      let filteredMaintenance = maintenance;
      let filteredParts = parts;
      let filteredPayments = dealerPayments;
      
      if (range.from || range.to) {
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dealers');
        filteredParts = filterByDateRange(parts, 'createdAt', 'dealers', true);
        filteredPayments = filterByDateRange(dealerPayments, 'date', 'dealers');
      }
      
      // Calculate current balances within the date range
      let totalPurchases = 0;
      let totalPayments = 0;
      
      filteredMaintenance.forEach(mnt => {
        if (mnt.partsDealerId === dealerId) {
          totalPurchases += toNumber(mnt.parts);
        }
      });
      
      filteredParts.forEach(part => {
        if (part.supplierId === dealerId) {
          totalPurchases += toNumber(part.buy) * toNumber(part.stock);
        }
      });
      
      filteredPayments
        .filter(p => p.dealerId === dealerId)
        .forEach(p => {
          totalPayments += toNumber(p.amount);
        });
      
      const remaining = totalPurchases - totalPayments;
      
      // تعبئة النموذج
      document.getElementById('dealerPaymentId').value = payment.id;
      document.getElementById('paymentDealerId').value = dealerId;
      document.getElementById('paymentDealerName').value = dealer.name || '';
      document.getElementById('paymentTotalPurchases').value = totalPurchases;
      document.getElementById('paymentCurrentPayments').value = totalPayments;
      document.getElementById('paymentCurrentRemaining').value = remaining;
      document.getElementById('paymentAmount').value = payment.amount;
      document.getElementById('paymentDate').value = payment.date || dateOnly(new Date());
      document.getElementById('paymentMethod').value = payment.paymentMethod || 'cash';
      document.getElementById('paymentNotes').value = payment.notes || '';
      
      const titleEl = document.getElementById('dealerPaymentModalTitle');
      if (titleEl) {
        titleEl.textContent = 'تعديل دفعة للتاجر';
      }
      
      const modal = new bootstrap.Modal(document.getElementById('dealerPaymentModal'));
      modal.show();
      
    } catch (error) {
      console.error('Error editing dealer payment:', error);
      showToast('❌ خطأ في فتح نموذج تعديل الدفعة', 'error');
    }
  }
  async function deleteDealerPayment(paymentId) {
    try {
      if (!checkPermission('dealers', 'delete')) {
        showToast('❌ لا تملك صلاحية حذف الدفعات', 'error');
        return;
      }

      if (!confirm('هل أنت متأكد من حذف هذه الدفعة؟')) {
        return;
      }

      let dealerPayments = await load('dealerPayments');

      if (!Array.isArray(dealerPayments)) {
        showToast('❌ لا توجد بيانات دفعات', 'error');
        return;
      }

      const payment = dealerPayments.find(p => p.id === paymentId);
      if (!payment) {
        showToast('❌ تعذر العثور على هذه الدفعة', 'error');
        return;
      }

      dealerPayments = dealerPayments.filter(p => p.id !== paymentId);
      await save('dealerPayments', dealerPayments);
      clearCache('dealerPayments');

      const dealers = await load('dealers');
      const dealer = dealers.find(d => d.id === payment.dealerId);
      const dealerName = dealer ? (dealer.name || '') : '';

      createNotification(
        'حذف دفعة',
        `تم حذف دفعة بقيمة ${currency(payment.amount)} للتاجر ${dealerName}`,
        'warning'
      );
      showToast('✅ تم حذف الدفعة بنجاح', 'success');

      if (dealer && typeof viewDealerTransactions === 'function') {
        const modalEl = document.getElementById('dealerTransactionsModal');
        if (modalEl) {
          const instance = bootstrap.Modal.getInstance(modalEl);
          if (instance) {
            instance.hide();
          }
        }
        setTimeout(() => {
          viewDealerTransactions(dealer.id);
        }, 300);
      }
    } catch (error) {
      console.error('Error deleting dealer payment:', error);
      showToast('❌ خطأ في حذف الدفعة', 'error');
    }
  }




  async function editDealer(id) {
    try {
      if (!checkPermission('dealers', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل التجار', 'error');
        return;
      }
      
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      const dealer = dealers.find(d => d.id === id);
      if (!dealer) return;
      
      // Apply date range filter for calculation
      const range = getCurrentDateRange('dealers');
      let filteredMaintenance = maintenance;
      let filteredParts = parts;
      let filteredPayments = dealerPayments;
      
      if (range.from || range.to) {
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'dealers');
        filteredParts = filterByDateRange(parts, 'createdAt', 'dealers', true);
        filteredPayments = filterByDateRange(dealerPayments, 'date', 'dealers');
      }
      
      // Calculate actual balances within the date range
      let totalPurchases = 0;
      let totalPayments = 0;
      
      // Calculate total purchases from maintenance
      filteredMaintenance.forEach(mnt => {
        if (mnt.partsDealerId === dealer.id) {
          totalPurchases += toNumber(mnt.parts);
        }
      });
      
      // Calculate total purchases from parts inventory
      filteredParts.forEach(part => {
        if (part.supplierId === dealer.id) {
          totalPurchases += toNumber(part.buy) * toNumber(part.stock);
        }
      });
      
      // Calculate total payments from dealerPayments
      const dealerPaymentRecords = filteredPayments.filter(payment => payment.dealerId === dealer.id);
      dealerPaymentRecords.forEach(payment => {
        totalPayments += toNumber(payment.amount);
      });
      
      const remaining = totalPurchases - totalPayments;
      
      document.getElementById('dealerId').value = dealer.id;
      document.getElementById('dealerName').value = dealer.name || '';
      document.getElementById('dealerSpecialty').value = dealer.specialty || '';
      document.getElementById('dealerPhone').value = dealer.phone || '';
      document.getElementById('dealerAddress').value = dealer.address || '';
      document.getElementById('dealerBalance').value = totalPurchases; // Auto-calculated within date range
      document.getElementById('dealerTotalPayments').value = totalPayments; // Auto-calculated within date range
      document.getElementById('dealerRemaining').value = remaining;
      
      document.getElementById('dealerModalTitle').textContent = 'تعديل تاجر';
      
      showModal('dealerModal');
      
    } catch (error) {
      console.error('Error editing dealer:', error);
      showToast('❌ خطأ في تحميل بيانات التاجر', 'error');
    }
  }

  async function deleteDealer(id) {
    if (!checkPermission('dealers', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف التجار', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا التاجر؟')) {
      try {
        const dealers = await load('dealers');
        const filtered = dealers.filter(d => d.id !== id);
        await save('dealers', filtered);
        clearCache('dealers');
        showToast('✅ تم حذف التاجر بنجاح', 'success');
        loadDealers();
      } catch (error) {
        console.error('Error deleting dealer:', error);
        showToast('❌ خطأ في حذف التاجر', 'error');
      }
    }
  }

  // ---------- Advanced Expenses Management ----------
  async function loadExpenses(page = 1) {
    try {
      const expenses = await load('expenses');
      const table = document.getElementById('expensesTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredExpenses = filterByDateRange(expenses, 'date', 'expenses');
      
      // Build search index
      buildSearchIndex('expenses', filteredExpenses, ['description', 'type']);
      
      // Apply search filter if any
      const searchTerm = document.getElementById('searchExpense')?.value.toLowerCase() || '';
      
      if (searchTerm) {
        filteredExpenses = searchInIndex('expenses', searchTerm);
      }
      
      // Sort by date (newest first)
      filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Paginate data
      const paginated = paginateData(filteredExpenses, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      let monthlyTotal = 0;
      const currentMonth = new Date().getMonth() + 1;
      const currentYear = new Date().getFullYear();
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" class="text-center text-muted py-3">لا توجد مصروفات في الفترة المحددة</td>`;
        table.appendChild(row);
      } else {
        paginated.items.forEach((expense, index) => {
          const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
          const date = new Date(expense.date);
          if (date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear) {
            monthlyTotal += toNumber(expense.amount);
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${globalIndex}</td>
            <td>${dateOnly(expense.date)}</td>
            <td>${getExpenseTypeText(expense.type)}</td>
            <td>${currency(expense.amount)}</td>
            <td>${escapeHtml(expense.description || '')}</td>
            <td>${expense.paymentMethod === 'cash' ? 'كاش' : 'حوالة'}</td>
            <td>
              <div class="action-btns">
                ${checkPermission('expenses', 'update') ? `
                  <button class="btn btn-sm btn-outline-primary edit-expense" data-id="${expense.id}">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
                ${checkPermission('expenses', 'delete') ? `
                  <button class="btn btn-sm btn-outline-danger delete-expense" data-id="${expense.id}">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          `;
          table.appendChild(row);
        });
      }
      
      // Update monthly total (within date range)
      const range = getCurrentDateRange('expenses');
      let rangeTotal = 0;
      if (range.from || range.to) {
        filteredExpenses.forEach(expense => {
          rangeTotal += toNumber(expense.amount);
        });
        document.getElementById('totalMonthlyExpenses').textContent = currency(rangeTotal);
      } else {
        document.getElementById('totalMonthlyExpenses').textContent = currency(monthlyTotal);
      }
      
      // Create pagination
      createPagination(paginated.pages, page, 'expensesPagination', loadExpenses);
      updatePaginationInfo('expensesPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-expense').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editExpense(id);
          });
        });
        
        document.querySelectorAll('.delete-expense').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteExpense(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading expenses:', error);
    }
  }

  function getExpenseTypeText(type) {
    const types = {
      'rent': 'إيجار',
      'salaries': 'رواتب',
      'utilities': 'مرافق',
      'supplies': 'مستلزمات',
      'marketing': 'تسويق',
      'transportation': 'مواصلات',
      'maintenance': 'صيانة',
      'other': 'أخرى'
    };
    return types[type] || type;
  }

  async function editExpense(id) {
    try {
      if (!checkPermission('expenses', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل المصروفات', 'error');
        return;
      }
      
      const expenses = await load('expenses');
      const expense = expenses.find(e => e.id === id);
      if (!expense) return;
      
      document.getElementById('expenseId').value = expense.id;
      document.getElementById('expenseType').value = expense.type || 'other';
      document.getElementById('expenseAmount').value = expense.amount || '';
      document.getElementById('expenseDate').value = dateOnly(expense.date);
      document.getElementById('expensePaymentMethod').value = expense.paymentMethod || 'cash';
      document.getElementById('expenseDescription').value = expense.description || '';
      document.getElementById('expenseModalTitle').textContent = 'تعديل مصروف';
      
      showModal('expenseModal');
      
    } catch (error) {
      console.error('Error editing expense:', error);
      showToast('❌ خطأ في تحميل بيانات المصروف', 'error');
    }
  }

  async function deleteExpense(id) {
    if (!checkPermission('expenses', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف المصروفات', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
      try {
        const expenses = await load('expenses');
        const filtered = expenses.filter(e => e.id !== id);
        await save('expenses', filtered);
        clearCache('expenses');
        showToast('✅ تم حذف المصروف بنجاح', 'success');
        loadExpenses();
      } catch (error) {
        console.error('Error deleting expense:', error);
        showToast('❌ خطأ في حذف المصروف', 'error');
      }
    }
  }

  // ---------- Advanced Commitments Management ----------
  /*async function loadCommitments(page = 1) {
    try {
      const commitments = await load('commitments');
      const table = document.getElementById('commitmentsTable');
      if (!table) return;
      
      // Apply date range filter
      let filteredCommitments = filterByDateRange(commitments, 'startDate', 'commitments');
      
      // Sort by status (active first) then by name
      const sortedCommitments = [...filteredCommitments].sort((a, b) => {
        if (a.status === b.status) {
          return a.name?.localeCompare(b.name);
        }
        return a.status === 'active' ? -1 : 1;
      });
      
      // Paginate data
      const paginated = paginateData(sortedCommitments, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      let monthlyTotal = 0;
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" class="text-center text-muted py-3">لا توجد التزامات في الفترة المحددة</td>`;
        table.appendChild(row);
      } else {
        paginated.items.forEach((commitment, index) => {
          const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
          if (commitment.status === 'active') {
            monthlyTotal += toNumber(commitment.amount);
          }
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${globalIndex}</td>
            <td>${escapeHtml(commitment.name || '')}</td>
            <td>${currency(commitment.amount)}</td>
            <td>${dateOnly(commitment.startDate)}</td>
            <td>${commitment.duration} شهر</td>
            <td>
              <span class="badge ${commitment.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                ${commitment.status === 'active' ? 'نشط' : 'غير نشط'}
              </span>
            </td>
            <td>
              <div class="action-btns">
                ${checkPermission('commitments', 'update') ? `
                  <button class="btn btn-sm btn-outline-primary edit-commitment" data-id="${commitment.id}">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
                ${checkPermission('commitments', 'delete') ? `
                  <button class="btn btn-sm btn-outline-danger delete-commitment" data-id="${commitment.id}">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          `;
          table.appendChild(row);
        });
      }
      
      // Update monthly total (within date range)
      const range = getCurrentDateRange('commitments');
      let rangeTotal = 0;
      if (range.from || range.to) {
        const activeInRange = filteredCommitments.filter(c => c.status === 'active');
        activeInRange.forEach(commitment => {
          rangeTotal += toNumber(commitment.amount);
        });
        document.getElementById('totalMonthlyCommitments').textContent = currency(rangeTotal);
      } else {
        document.getElementById('totalMonthlyCommitments').textContent = currency(monthlyTotal);
      }
      
      // Create pagination
      createPagination(paginated.pages, page, 'commitmentsPagination', loadCommitments);
      updatePaginationInfo('commitmentsPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-commitment').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editCommitment(id);
          });
        });
        
        document.querySelectorAll('.delete-commitment').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteCommitment(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading commitments:', error);
    }
  }

  async function editCommitment(id) {
    try {
      if (!checkPermission('commitments', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل الالتزامات', 'error');
        return;
      }
      
      const commitments = await load('commitments');
      const commitment = commitments.find(c => c.id === id);
      if (!commitment) return;
      
      document.getElementById('commitmentId').value = commitment.id;
      document.getElementById('commitmentName').value = commitment.name || '';
      document.getElementById('commitmentAmount').value = commitment.amount || '';
      document.getElementById('commitmentStartDate').value = dateOnly(commitment.startDate);
      document.getElementById('commitmentDuration').value = commitment.duration || 12;
      document.getElementById('commitmentStatus').value = commitment.status || 'active';
      document.getElementById('commitmentModalTitle').textContent = 'تعديل التزام';
      
      showModal('commitmentModal');
      
    } catch (error) {
      console.error('Error editing commitment:', error);
      showToast('❌ خطأ في تحميل بيانات الالتزام', 'error');
    }
  }

  async function deleteCommitment(id) {
    if (!checkPermission('commitments', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف الالتزامات', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا الالتزام؟')) {
      try {
        const commitments = await load('commitments');
        const filtered = commitments.filter(c => c.id !== id);
        await save('commitments', filtered);
        clearCache('commitments');
        showToast('✅ تم حذف الالتزام بنجاح', 'success');
        loadCommitments();
      } catch (error) {
        console.error('Error deleting commitment:', error);
        showToast('❌ خطأ في حذف الالتزام', 'error');
      }
    }
  }
*/

async function loadCommitments(page = 1) {
    console.log('🔄 بدء تحميل الالتزامات الشهرية - الصفحة:', page);
    
    try {
        const table = document.getElementById('commitmentsTable');
        if (table) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                        جاري تحميل الالتزامات...
                    </td>
                </tr>
            `;
        }
        
        // تحميل جميع الالتزامات
        const allCommitments = await load('commitments');
        console.log('📥 إجمالي الالتزامات المحملة:', allCommitments.length);
        
        if (!Array.isArray(allCommitments) || allCommitments.length === 0) {
            if (table) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                لا توجد التزامات مسجلة
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-primary" onclick="showModal('commitmentModal')">
                                        <i class="bi bi-plus-circle"></i> إضافة التزام جديد
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            document.getElementById('totalMonthlyCommitments').textContent = currency(0);
            return;
        }
        
        // تطبيق فلترة التاريخ
        const range = getCurrentDateRange('commitments');
        console.log('📅 نطاق الفلترة:', {
            from: range.from ? dateOnly(range.from) : 'بدون',
            to: range.to ? dateOnly(range.to) : 'بدون'
        });
        
        let filteredCommitments = [...allCommitments];
        
        if (range.from || range.to) {
            filteredCommitments = filterCommitmentsByDateRange(allCommitments, range);
            console.log('🔍 الالتزامات بعد الفلترة:', filteredCommitments.length);
        }
        
        // حساب إجمالي الالتزامات الشهرية (فقط النشطة)
        const activeCommitments = filteredCommitments.filter(c => c.status === 'active');
        let monthlyTotal = 0;
        
        activeCommitments.forEach(commitment => {
            // إذا كان الالتزام ضمن النطاق الزمني الحالي
            if (isCommitmentActiveInRange(commitment, range)) {
                monthlyTotal += toNumber(commitment.amount);
            }
        });
        
        // تحديث الإحصائيات
        document.getElementById('totalMonthlyCommitments').textContent = currency(monthlyTotal);
        console.log('💰 إجمالي الالتزامات الشهرية في النطاق:', monthlyTotal);
        
        // ترتيب الالتزامات (النشطة أولاً، ثم بالتاريخ)
        const sortedCommitments = [...filteredCommitments].sort((a, b) => {
            // النشطة أولاً
            if (a.status === 'active' && b.status !== 'active') return -1;
            if (a.status !== 'active' && b.status === 'active') return 1;
            
            // ثم بالتاريخ (الأحدث أولاً)
            const dateA = new Date(a.startDate || a.createdAt);
            const dateB = new Date(b.startDate || b.createdAt);
            return dateB - dateA;
        });
        
        // تطبيق التقطيع
        const pageSize = paginationConfig.pageSize;
        const totalItems = sortedCommitments.length;
        const totalPages = Math.ceil(totalItems / pageSize);
        const startIndex = (page - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalItems);
        const currentItems = sortedCommitments.slice(startIndex, endIndex);
        
        console.log('📄 تقطيع الالتزامات:', {
            totalItems,
            totalPages,
            currentPage: page,
            itemsInPage: currentItems.length
        });
        
        // تحديث الجدول
        if (table) {
            if (currentItems.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="alert alert-warning">
                                <i class="bi bi-calendar-x me-2"></i>
                                لا توجد التزامات في الفترة المحددة
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-secondary" onclick="resetCommitmentsFilter()">
                                        <i class="bi bi-x-circle"></i> إعادة تعيين الفلترة
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                let html = '';
                
                currentItems.forEach((commitment, index) => {
                    const globalIndex = startIndex + index + 1;
                    const startDate = new Date(commitment.startDate);
                    const endDate = calculateCommitmentEndDate(commitment);
                    const remainingMonths = calculateRemainingMonths(endDate);
                    const isActiveInRange = isCommitmentActiveInRange(commitment, range);
                    
                    html += `
                    <tr class="${isActiveInRange ? 'table-active' : ''}">
                        <td class="text-center">${globalIndex}</td>
                        <td>
                            <strong class="d-block">${escapeHtml(commitment.name || 'بدون اسم')}</strong>
                            <small class="text-muted">${commitment.id.substring(0, 8)}...</small>
                        </td>
                        <td class="text-end">
                            <span class="fw-bold ${isActiveInRange ? 'text-danger' : 'text-muted'}">
                                ${currency(commitment.amount)}
                            </span>
                            <div class="small text-muted">شهرياً</div>
                        </td>
                        <td>
                            <div>${dateOnly(commitment.startDate)}</div>
                            <div class="small text-muted">تاريخ البدء</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2">${commitment.duration || 12}</span>
                                <div>
                                    <div>شهر</div>
                                    <div class="small text-muted">
                                        ${remainingMonths > 0 ? `متبقي ${remainingMonths} شهر` : 'منتهي'}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            ${renderCommitmentStatus(commitment, endDate)}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary edit-commitment" 
                                        data-id="${commitment.id}" title="تعديل">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger delete-commitment" 
                                        data-id="${commitment.id}" title="حذف">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-outline-info view-commitment" 
                                        data-id="${commitment.id}" title="عرض التفاصيل">
                                    <i class="bi bi-eye"></i>
                                </button>
                                ${commitment.status === 'active' ? `
                                <button class="btn btn-outline-warning toggle-commitment" 
                                        data-id="${commitment.id}" title="تعطيل">
                                    <i class="bi bi-pause"></i>
                                </button>
                                ` : `
                                <button class="btn btn-outline-success toggle-commitment" 
                                        data-id="${commitment.id}" title="تفعيل">
                                    <i class="bi bi-play"></i>
                                </button>
                                `}
                            </div>
                        </td>
                    </tr>
                    `;
                });
                
                table.innerHTML = html;
                
                // إضافة المستمعين للأحداث
                setTimeout(() => {
                    document.querySelectorAll('.edit-commitment').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            editCommitment(id);
                        });
                    });
                    
                    document.querySelectorAll('.delete-commitment').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            deleteCommitment(id);
                        });
                    });
                    
                    document.querySelectorAll('.view-commitment').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            viewCommitmentDetails(id);
                        });
                    });
                    
                    document.querySelectorAll('.toggle-commitment').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            toggleCommitmentStatus(id);
                        });
                    });
                }, 100);
            }
        }
        
        // تحديث التقطيع
        createPagination(totalPages, page, 'commitmentsPagination', loadCommitments);
        
        // تحديث معلومات التقطيع
        updatePaginationInfo('commitmentsPaginationInfo', {
            total: totalItems,
            currentPage: page,
            pageSize: pageSize
        });
        
        console.log('✅ تم تحميل وعرض الالتزامات بنجاح');
        
    } catch (error) {
        console.error('❌ خطأ في تحميل الالتزامات:', error);
        
        if (table) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        خطأ في تحميل الالتزامات
                        <div class="small mt-1">${error.message}</div>
                        <button class="btn btn-sm btn-warning mt-2" onclick="loadCommitments()">
                            <i class="bi bi-arrow-clockwise"></i> إعادة المحاولة
                        </button>
                    </td>
                </tr>
            `;
        }
    }
}

// دالة مساعدة: فلترة الالتزامات حسب النطاق الزمني
function filterCommitmentsByDateRange(commitments, range) {
    if (!range.from && !range.to) return commitments;
    
    return commitments.filter(commitment => {
        const startDate = new Date(commitment.startDate);
        const duration = toNumber(commitment.duration || 12);
        const endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + duration);
        
        // تحقق إذا كان الالتزام يتقاطع مع النطاق الزمني
        if (range.from && endDate < range.from) return false; // انتهى قبل النطاق
        if (range.to && startDate > range.to) return false; // سيبدأ بعد النطاق
        
        return true;
    });
}

// دالة مساعدة: حساب تاريخ انتهاء الالتزام
function calculateCommitmentEndDate(commitment) {
    const startDate = new Date(commitment.startDate);
    const duration = toNumber(commitment.duration || 12);
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + duration);
    return endDate;
}

// دالة مساعدة: حساب الأشهر المتبقية
function calculateRemainingMonths(endDate) {
    const now = new Date();
    if (endDate <= now) return 0;
    
    const diffTime = endDate - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return Math.ceil(diffDays / 30); // تقريب للأشهر
}

// دالة مساعدة: التحقق إذا كان الالتزام نشطاً في النطاق الزمني
function isCommitmentActiveInRange(commitment, range) {
    if (commitment.status !== 'active') return false;
    
    const startDate = new Date(commitment.startDate);
    const endDate = calculateCommitmentEndDate(commitment);
    const now = new Date();
    
    // إذا كان الالتزام نشطاً الآن
    const isCurrentlyActive = startDate <= now && endDate >= now;
    
    // إذا لم يكن هناك نطاق زمني محدد
    if (!range.from && !range.to) return isCurrentlyActive;
    
    // التحقق من التقاطع مع النطاق الزمني
    let isActiveInRange = false;
    
    if (range.from && range.to) {
        // نطاق محدد: تحقق إذا كان الالتزام نشطاً في أي جزء من النطاق
        isActiveInRange = !(endDate < range.from || startDate > range.to);
    } else if (range.from) {
        // من تاريخ محدد إلى المستقبل
        isActiveInRange = endDate >= range.from;
    } else if (range.to) {
        // من الماضي إلى تاريخ محدد
        isActiveInRange = startDate <= range.to;
    }
    
    return isActiveInRange;
}

// دالة مساعدة: عرض حالة الالتزام
function renderCommitmentStatus(commitment, endDate) {
    const now = new Date();
    const isExpired = endDate < now;
    
    if (commitment.status === 'inactive') {
        return '<span class="badge bg-secondary">غير نشط</span>';
    }
    
    if (isExpired) {
        return '<span class="badge bg-danger">منتهي</span>';
    }
    
    const remainingMonths = calculateRemainingMonths(endDate);
    
    if (remainingMonths <= 3) {
        return `<span class="badge bg-warning">ينتهي خلال ${remainingMonths} شهر</span>`;
    }
    
    return '<span class="badge bg-success">نشط</span>';
}

// دالة مساعدة: إعادة تعيين فلترة الالتزامات
function resetCommitmentsFilter() {
    setDateRangeInputs('commitments', 'thisMonth');
    loadCommitments();
}

// دالة مساعدة: عرض تفاصيل الالتزام
async function viewCommitmentDetails(commitmentId) {
    try {
        const commitments = await load('commitments');
        const commitment = commitments.find(c => c.id === commitmentId);
        
        if (!commitment) {
            showToast('❌ الالتزام غير موجود', 'error');
            return;
        }
        
        const startDate = new Date(commitment.startDate);
        const endDate = calculateCommitmentEndDate(commitment);
        const totalAmount = toNumber(commitment.amount) * toNumber(commitment.duration || 12);
        const paidMonths = calculatePaidMonths(commitment);
        const remainingMonths = calculateRemainingMonths(endDate);
        
        const modalContent = `
            <div class="commitment-details">
                <h5 class="border-bottom pb-2 mb-3">${escapeHtml(commitment.name)}</h5>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th>المبلغ الشهري:</th>
                                <td class="text-danger fw-bold">${currency(commitment.amount)}</td>
                            </tr>
                            <tr>
                                <th>المدة:</th>
                                <td>${commitment.duration || 12} شهر</td>
                            </tr>
                            <tr>
                                <th>إجمالي القيمة:</th>
                                <td class="fw-bold">${currency(totalAmount)}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th>تاريخ البدء:</th>
                                <td>${dateOnly(startDate)}</td>
                            </tr>
                            <tr>
                                <th>تاريخ الانتهاء:</th>
                                <td>${dateOnly(endDate)}</td>
                            </tr>
                            <tr>
                                <th>الأشهر المتبقية:</th>
                                <td>
                                    <span class="badge ${remainingMonths <= 3 ? 'bg-warning' : 'bg-info'}">
                                        ${remainingMonths} شهر
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>تقدم الالتزام:</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${remainingMonths <= 3 ? 'bg-warning' : 'bg-success'}" 
                             role="progressbar" 
                             style="width: ${calculateProgressPercentage(commitment)}%">
                            ${calculateProgressPercentage(commitment)}% مكتمل
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small>بدأ: ${dateOnly(startDate)}</small>
                        <small>ينتهي: ${dateOnly(endDate)}</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert ${commitment.status === 'active' ? 'alert-success' : 'alert-secondary'}">
                        <i class="bi bi-info-circle me-2"></i>
                        الحالة: <strong>${commitment.status === 'active' ? 'نشط' : 'غير نشط'}</strong>
                        ${remainingMonths <= 3 && commitment.status === 'active' ? 
                            ' - <span class="text-warning">ينتهي قريباً</span>' : ''}
                    </div>
                </div>
                
                ${commitment.notes ? `
                <div class="mt-3">
                    <h6>ملاحظات:</h6>
                    <div class="alert alert-light">${escapeHtml(commitment.notes)}</div>
                </div>
                ` : ''}
            </div>
        `;
        
        // إنشاء مودال
        const modalId = 'commitmentDetailsModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = modalId;
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">تفاصيل الالتزام</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="${modalId}Body"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                            <button type="button" class="btn btn-primary" 
                                    onclick="editCommitment('${commitmentId}')" 
                                    data-bs-dismiss="modal">
                                <i class="bi bi-pencil"></i> تعديل
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById(modalId + 'Body').innerHTML = modalContent;
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
    } catch (error) {
        console.error('خطأ في عرض تفاصيل الالتزام:', error);
        showToast('❌ خطأ في عرض التفاصيل', 'error');
    }
}

// دالة مساعدة: حساب نسبة التقدم
function calculateProgressPercentage(commitment) {
    const startDate = new Date(commitment.startDate);
    const endDate = calculateCommitmentEndDate(commitment);
    const now = new Date();
    
    if (now >= endDate) return 100;
    if (now <= startDate) return 0;
    
    const totalDuration = endDate - startDate;
    const elapsedDuration = now - startDate;
    
    return Math.round((elapsedDuration / totalDuration) * 100);
}

// دالة مساعدة: تبديل حالة الالتزام
async function toggleCommitmentStatus(commitmentId) {
    try {
        const commitments = await load('commitments');
        const index = commitments.findIndex(c => c.id === commitmentId);
        
        if (index === -1) {
            showToast('❌ الالتزام غير موجود', 'error');
            return;
        }
        
        const currentStatus = commitments[index].status;
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        
        if (confirm(`هل تريد ${newStatus === 'active' ? 'تفعيل' : 'تعطيل'} هذا الالتزام؟`)) {
            commitments[index].status = newStatus;
            commitments[index].updatedAt = nowISO();
            
            await save('commitments', commitments);
            clearCache('commitments');
            
            showToast(`✅ تم ${newStatus === 'active' ? 'تفعيل' : 'تعطيل'} الالتزام`, 'success');
            loadCommitments();
        }
        
    } catch (error) {
        console.error('خطأ في تبديل حالة الالتزام:', error);
        showToast('❌ خطأ في تغيير الحالة', 'error');
    }
}

// دالة مساعدة: إنشاء التزامات نموذجية
function createSampleCommitments() {
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    
    return [
        {
            id: 'commit_' + Date.now() + '_1',
            name: 'إيجار المحل الرئيسي',
            amount: 1500,
            startDate: dateOnly(lastMonth),
            duration: 24,
            status: 'active',
            createdAt: nowISO(),
            updatedAt: nowISO()
        },
        {
            id: 'commit_' + Date.now() + '_2',
            name: 'اشتراك الإنترنت',
            amount: 120,
            startDate: dateOnly(new Date(now.getFullYear(), now.getMonth() - 6, 15)),
            duration: 12,
            status: 'active',
            createdAt: nowISO(),
            updatedAt: nowISO()
        },
        {
            id: 'commit_' + Date.now() + '_3',
            name: 'تأمين المركبات',
            amount: 300,
            startDate: dateOnly(new Date(now.getFullYear() - 1, now.getMonth(), 1)),
            duration: 36,
            status: 'active',
            createdAt: nowISO(),
            updatedAt: nowISO()
        },
        {
            id: 'commit_' + Date.now() + '_4',
            name: 'برنامج المحاسبة',
            amount: 200,
            startDate: dateOnly(nextMonth),
            duration: 12,
            status: 'inactive',
            createdAt: nowISO(),
            updatedAt: nowISO()
        },
        {
            id: 'commit_' + Date.now() + '_5',
            name: 'خدمات الاستضافة',
            amount: 80,
            startDate: dateOnly(new Date(now.getFullYear(), now.getMonth() - 2, 10)),
            duration: 6,
            status: 'active',
            createdAt: nowISO(),
            updatedAt: nowISO()
        }
    ];
}

// جعل الدوال متاحة عالمياً
window.viewCommitmentDetails = viewCommitmentDetails;
window.toggleCommitmentStatus = toggleCommitmentStatus;
window.resetCommitmentsFilter = resetCommitmentsFilter;
window.addSampleCommitments = async function() {
    const sampleCommitments = createSampleCommitments();
    const currentCommitments = await load('commitments');
    const updatedCommitments = [...currentCommitments, ...sampleCommitments];
    
    await save('commitments', updatedCommitments);
    showToast('✅ تم إضافة 5 التزامات نموذجية', 'success');
    loadCommitments(); };
  // ---------- Advanced Users Management ----------
  async function loadUsers(page = 1) {
    try {
      const users = await load('users');
      const table = document.getElementById('usersTable');
      if (!table) return;
      
      // Check permissions
      if (!checkPermission('users', 'read')) {
        table.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">❌ لا تملك صلاحية الوصول إلى إدارة المستخدمين</td></tr>';
        return;
      }
      
      // Paginate data
      const paginated = paginateData(users, page, paginationConfig.pageSize);
      
      table.innerHTML = '';
      
      if (paginated.items.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" class="text-center text-muted py-3">لا توجد مستخدمين</td>`;
        table.appendChild(row);
        return;
      }
      
      paginated.items.forEach((user, index) => {
        const globalIndex = ((page - 1) * paginationConfig.pageSize) + index + 1;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${escapeHtml(user.name || '')}</td>
          <td>${escapeHtml(user.email || '')}</td>
          <td>${getRoleText(user.role)}</td>
          <td>
            <span class="badge ${user.active ? 'bg-success' : 'bg-danger'}">
              ${user.active ? 'نشط' : 'غير نشط'}
            </span>
          </td>
          <td>
            <div class="action-btns">
              ${checkPermission('users', 'update') ? `
                <button class="btn btn-sm btn-outline-primary edit-user" data-id="${user.id}">
                  <i class="bi bi-pencil"></i>
                </button>
              ` : ''}
              ${checkPermission('users', 'delete') && user.email !== 'admin@example.com' ? `
                <button class="btn btn-sm btn-outline-danger delete-user" data-id="${user.id}">
                  <i class="bi bi-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        `;
        table.appendChild(row);
      });
      
      // Create pagination
      createPagination(paginated.pages, page, 'usersPagination', loadUsers);
      updatePaginationInfo('usersPaginationInfo', paginated);
      
      // Add event listeners
      setTimeout(() => {
        document.querySelectorAll('.edit-user').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            editUser(id);
          });
        });
        
        document.querySelectorAll('.delete-user').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').getAttribute('data-id');
            deleteUser(id);
          });
        });
      }, 100);
      
    } catch (error) {
      console.error('Error loading users:', error);
    }
  }

  function getRoleText(role) {
    const roles = {
      'admin': 'مدير',
      'supervisor': 'مشرف',
      'sales': 'موظف مبيعات',
      'maintenance': 'موظف صيانة'
    };
    return roles[role] || role;
  }

  async function editUser(id) {
    try {
      // Check permissions
      if (!checkPermission('users', 'update')) {
        showToast('❌ لا تملك صلاحية تعديل المستخدمين', 'error');
        return;
      }
      
      const users = await load('users');
      const user = users.find(u => u.id === id);
      if (!user) return;
      
      document.getElementById('uId').value = user.id;
      document.getElementById('uName').value = user.name || '';
      document.getElementById('uEmail').value = user.email || '';
      document.getElementById('uPassword').value = '';
      document.getElementById('uRole').value = user.role || 'sales';
      document.getElementById('uActive').checked = user.active !== false;
      document.getElementById('userModalTitle').textContent = 'تعديل مستخدم';
      
      showModal('userModal');
      
    } catch (error) {
      console.error('Error editing user:', error);
      showToast('❌ خطأ في تحميل بيانات المستخدم', 'error');
    }
  }

  async function deleteUser(id) {
    // Check permissions
    if (!checkPermission('users', 'delete')) {
      showToast('❌ لا تملك صلاحية حذف المستخدمين', 'error');
      return;
    }
    
    const users = await load('users');
    const user = users.find(u => u.id === id);
    
    if (user && user.email === 'admin@example.com') {
      showToast('❌ لا يمكن حذف المدير الرئيسي', 'error');
      return;
    }
    
    if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
      try {
        const filtered = users.filter(u => u.id !== id);
        await save('users', filtered);
        clearCache('users');
        showToast('✅ تم حذف المستخدم بنجاح', 'success');
        loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('❌ خطأ في حذف المستخدم', 'error');
      }
    }
  }

  // ---------- Advanced Bank Functions ----------
  async function loadBank() {
    try {
      const [invoices, maintenance] = await Promise.all([
        load('invoices'),
        load('maintenance')
      ]);
      
      // Apply date range filter
      const range = getCurrentDateRange('bank');
      let filteredInvoices = invoices;
      let filteredMaintenance = maintenance;
      
      if (range.from || range.to) {
        filteredInvoices = filterByDateRange(invoices, 'date', 'bank');
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'bank');
      }
      
      let cashTotal = 0;
      let transferTotal = 0;
      let salesCash = 0;
      let salesTransfer = 0;
      let salesCost = 0;
      let maintCash = 0;
      let maintTransfer = 0;
      let maintCost = 0;
      
      // Calculate from invoices
      filteredInvoices.forEach(inv => {
        if (inv.paymentMethod === 'cash') {
          cashTotal += toNumber(inv.totalSell);
          salesCash += toNumber(inv.totalSell);
        } else if (inv.paymentMethod === 'transfer') {
          transferTotal += toNumber(inv.totalSell);
          salesTransfer += toNumber(inv.totalSell);
        }
        salesCost += toNumber(inv.totalBuy);
      });
      
      // Calculate from maintenance
      filteredMaintenance.forEach(mnt => {
        if (mnt.paymentMethod === 'cash') {
          cashTotal += toNumber(mnt.cost);
          maintCash += toNumber(mnt.cost);
        } else if (mnt.paymentMethod === 'transfer') {
          transferTotal += toNumber(mnt.cost);
          maintTransfer += toNumber(mnt.cost);
        }
        maintCost += toNumber(mnt.parts);
      });
      
      const total = cashTotal + transferTotal;
      const salesNet = (salesCash + salesTransfer) - salesCost;
      const maintNet = (maintCash + maintTransfer) - maintCost;
      
      // Update UI
      document.getElementById('bankCash').textContent = currency(cashTotal);
      document.getElementById('bankTransfer').textContent = currency(transferTotal);
      document.getElementById('bankTotal').textContent = currency(total);
      document.getElementById('bankSalesCash').textContent = currency(salesCash);
      document.getElementById('bankSalesTransfer').textContent = currency(salesTransfer);
      document.getElementById('bankProductsCost').textContent = currency(salesCost);
      document.getElementById('bankSalesNet').textContent = currency(salesNet);
      document.getElementById('bankMaintenanceCash').textContent = currency(maintCash);
      document.getElementById('bankMaintenanceTransfer').textContent = currency(maintTransfer);
      document.getElementById('bankPartsCost').textContent = currency(maintCost);
      document.getElementById('bankMaintenanceNet').textContent = currency(maintNet);
      
      // Update range display
      const rangeDisplay = document.getElementById('bankRange');
      if (rangeDisplay) {
        if (range.from && range.to) {
          rangeDisplay.value = 'custom';
        } else {
          // Set based on actual range
          if (range.from && range.to) {
            const diffTime = Math.abs(range.to - range.from);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 1) {
              rangeDisplay.value = 'daily';
            } else if (diffDays <= 7) {
              rangeDisplay.value = 'weekly';
            } else if (diffDays <= 31) {
              rangeDisplay.value = 'monthly';
            } else {
              rangeDisplay.value = 'yearly';
            }
          }
        }
      }
      
    } catch (error) {
      console.error('Error loading bank data:', error);
    }
  }

  // ---------- Advanced Debts Functions ----------
  async function loadDebts() {
    try {
      const [invoices, maintenance, customers] = await Promise.all([
        load('invoices'),
        load('maintenance'),
        load('customers')
      ]);
      
      // Apply date range filter
      const range = getCurrentDateRange('debts');
      let filteredInvoices = invoices;
      let filteredMaintenance = maintenance;
      
      if (range.from || range.to) {
        filteredInvoices = filterByDateRange(invoices, 'date', 'debts');
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'debts');
      }
      
      // Calculate totals
      let salesDebts = 0;
      let maintDebts = 0;
      
      const unpaidInvoices = filteredInvoices.filter(inv => inv.paymentStatus === 'pending');
      const unpaidMaintenance = filteredMaintenance.filter(mnt => mnt.paymentStatus === 'pending');
      
      unpaidInvoices.forEach(inv => {
        salesDebts += toNumber(inv.totalSell);
      });
      
      unpaidMaintenance.forEach(mnt => {
        maintDebts += toNumber(mnt.cost);
      });
      
      // Update totals
      document.getElementById('debtsSales').textContent = currency(salesDebts);
      document.getElementById('debtsMaintenance').textContent = currency(maintDebts);
      
      // Load sales debts table
      await loadDebtsSalesTable(unpaidInvoices, customers);
      
      // Load maintenance debts table
      await loadDebtsMaintenanceTable(unpaidMaintenance, customers);
      
    } catch (error) {
      console.error('Error loading debts:', error);
    }
  }

  async function loadDebtsSalesTable(unpaidInvoices, customers, page = 1) {
    const table = document.getElementById('debtsSalesTable');
    if (!table) return;
    
    // Paginate data
    const paginated = paginateData(unpaidInvoices, page, 5); // Smaller page size for debts
    
    table.innerHTML = '';
    
    if (paginated.items.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="8" class="text-center text-muted py-3">لا توجد ديون مبيعات في الفترة المحددة</td>`;
      table.appendChild(row);
    } else {
      paginated.items.forEach((invoice, index) => {
        const globalIndex = ((page - 1) * 5) + index + 1;
        const customer = customers.find(c => c.id === invoice.customerId);
        const customerName = invoice.customerId === 'anonymous' ? 'عميل بدون اسم' : (customer ? customer.name : 'غير معروف');
        const productNames = invoice.items ? 
          invoice.items.map(item => {
            // In a real system, you would look up product names
            return 'منتج';
          }).join(', ') : 'غير معروف';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${invoice.number || 'N/A'}</td>
          <td>${escapeHtml(customerName)}</td>
          <td>${escapeHtml(productNames)}</td>
          <td>${currency(invoice.totalSell)}</td>
          <td>${dateOnly(invoice.date)}</td>
          <td><span class="badge bg-warning">غير مدفوع</span></td>
          <td>
            <button class="btn btn-sm btn-success mark-paid" data-type="invoice" data-id="${invoice.id}">
              <i class="bi bi-check-circle"></i> تسديد
            </button>
          </td>
        `;
        table.appendChild(row);
      });
    }
    
    // Create pagination
    createPagination(paginated.pages, page, 'debtsSalesPagination', (newPage) => {
      loadDebtsSalesTable(unpaidInvoices, customers, newPage);
    });
    updatePaginationInfo('debtsSalesPaginationInfo', paginated);
    
    // Add event listeners for mark as paid buttons
    setTimeout(() => {
      document.querySelectorAll('.mark-paid').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const type = e.target.closest('button').getAttribute('data-type');
          const id = e.target.closest('button').getAttribute('data-id');
          await markAsPaid(type, id);
        });
      });
    }, 100);
  }

  async function loadDebtsMaintenanceTable(unpaidMaintenance, customers, page = 1) {
    const table = document.getElementById('debtsMaintenanceTable');
    if (!table) return;
    
    // Paginate data
    const paginated = paginateData(unpaidMaintenance, page, 5); // Smaller page size for debts
    
    table.innerHTML = '';
    
    if (paginated.items.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="8" class="text-center text-muted py-3">لا توجد ديون صيانة في الفترة المحددة</td>`;
      table.appendChild(row);
    } else {
      paginated.items.forEach((order, index) => {
        const globalIndex = ((page - 1) * 5) + index + 1;
        const customer = customers.find(c => c.id === order.customerId);
        const customerName = customer ? customer.name : 'غير معروف';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${globalIndex}</td>
          <td>${order.number || 'N/A'}</td>
          <td>${escapeHtml(customerName)}</td>
          <td>${escapeHtml(order.device || '')}</td>
          <td>${currency(order.cost)}</td>
          <td>${dateOnly(order.received)}</td>
          <td><span class="badge bg-warning">غير مدفوع</span></td>
          <td>
            <button class="btn btn-sm btn-success mark-paid" data-type="maintenance" data-id="${order.id}">
              <i class="bi bi-check-circle"></i> تسديد
            </button>
          </td>
        `;
        table.appendChild(row);
      });
    }
    
    // Create pagination
    createPagination(paginated.pages, page, 'debtsMaintenancePagination', (newPage) => {
      loadDebtsMaintenanceTable(unpaidMaintenance, customers, newPage);
    });
    updatePaginationInfo('debtsMaintenancePaginationInfo', paginated);
  }

  async function markAsPaid(type, id) {
    try {
      if (confirm('هل تريد تسديد هذا المبلغ؟')) {
        if (type === 'invoice') {
          const invoices = await load('invoices');
          const invoiceIndex = invoices.findIndex(i => i.id === id);
          if (invoiceIndex !== -1) {
            invoices[invoiceIndex].paymentStatus = 'paid';
            await save('invoices', invoices);
            clearCache('invoices');
            createNotification('تسديد دين', `تم تسديد فاتورة ${invoices[invoiceIndex].number}`, 'success');
            showToast('✅ تم تسديد الفاتورة بنجاح', 'success');
            loadDebts();
          }
        } else if (type === 'maintenance') {
          const maintenance = await load('maintenance');
          const maintIndex = maintenance.findIndex(m => m.id === id);
          if (maintIndex !== -1) {
            maintenance[maintIndex].paymentStatus = 'paid';
            await save('maintenance', maintenance);
            clearCache('maintenance');
            createNotification('تسديد دين', `تم تسديد أمر صيانة ${maintenance[maintIndex].number}`, 'success');
            showToast('✅ تم تسديد أمر الصيانة بنجاح', 'success');
            loadDebts();
          }
        }
      }
    } catch (error) {
      console.error('Error marking as paid:', error);
      showToast('❌ خطأ في التسديد', 'error');
    }
  }

  // ---------- Advanced Reports Functions ----------
/*  async function loadReports() {
    try {
      const [invoices, maintenance, expenses, commitments] = await Promise.all([
        load('invoices'),
        load('maintenance'),
        load('expenses'),
        load('commitments')
      ]);

      // Apply date range filter
      const range = getCurrentDateRange('reports');
      let filteredInvoices = invoices;
      let filteredMaintenance = maintenance;
      let filteredExpenses = expenses;
      let filteredCommitments = commitments;

      if (range.from || range.to) {
        filteredInvoices = filterByDateRange(invoices, 'date', 'reports');
        filteredMaintenance = filterByDateRange(maintenance, 'received', 'reports');
        filteredExpenses = filterByDateRange(expenses, 'date', 'reports');
        filteredCommitments = filterByDateRange(commitments, 'startDate', 'reports');
      }

      // Maintenance reports
      let maintTotal = 0;
      let maintParts = 0;
      let maintCash = 0;
      let maintTransfer = 0;
      let maintDealers = 0;
      let maintInShop = 0;
      let maintDelivery = 0;

      filteredMaintenance.forEach(mnt => {
        maintTotal += toNumber(mnt.cost);
        maintParts += toNumber(mnt.parts);
        
        // Calculate dealer payments
        if (mnt.partsDealerId && toNumber(mnt.parts) > 0) {
          maintDealers += toNumber(mnt.parts);
        }
        
        // Calculate by type
        if (mnt.type === 'in_shop') {
          maintInShop += toNumber(mnt.cost);
        } else if (mnt.type === 'delivery') {
          maintDelivery += toNumber(mnt.cost);
        } else {
          // Default to in_shop for old records
          maintInShop += toNumber(mnt.cost);
        }
        
        if (mnt.paymentMethod === 'cash') {
          maintCash += toNumber(mnt.cost);
        } else if (mnt.paymentMethod === 'transfer') {
          maintTransfer += toNumber(mnt.cost);
        }
      });

      const maintNet = maintTotal - maintParts;

      // Sales reports
      let salesTotal = 0;
      let salesBuy = 0;
      let salesCash = 0;
      let salesTransfer = 0;

      filteredInvoices.forEach(inv => {
        salesTotal += toNumber(inv.totalSell);
        salesBuy += toNumber(inv.totalBuy);
        
        if (inv.paymentMethod === 'cash') {
          salesCash += toNumber(inv.totalSell);
        } else if (inv.paymentMethod === 'transfer') {
          salesTransfer += toNumber(inv.totalSell);
        }
      });

      const salesNet = salesTotal - salesBuy;

      // Expenses reports
      let expensesTotal = 0;
      filteredExpenses.forEach(exp => {
        expensesTotal += toNumber(exp.amount);
      });

      // Commitments reports
      let commitmentsTotal = 0;
      const activeCommitments = filteredCommitments.filter(com => com.status === 'active');
      activeCommitments.forEach(com => {
        commitmentsTotal += toNumber(com.amount);
      });

      // Comprehensive reports
      let totalMaintNet = maintNet;
      let totalSalesNet = salesNet;
      let totalExpensesComprehensive = expensesTotal;
      let totalCommitmentsComprehensive = commitmentsTotal;

      const finalProfit = (totalMaintNet + totalSalesNet) - (totalExpensesComprehensive + totalCommitmentsComprehensive);

      // Update UI
      document.getElementById('r_maint_total').textContent = currency(maintTotal);
      document.getElementById('r_maint_parts').textContent = currency(maintParts);
      document.getElementById('r_maint_net').textContent = currency(maintNet);
      document.getElementById('r_maint_dealers').textContent = currency(maintDealers);
      document.getElementById('r_maint_cash').textContent = currency(maintCash);
      document.getElementById('r_maint_transfer').textContent = currency(maintTransfer);
      document.getElementById('r_maint_in_shop').textContent = currency(maintInShop);
      document.getElementById('r_maint_delivery').textContent = currency(maintDelivery);
      
      document.getElementById('r_sales_total').textContent = currency(salesTotal);
      document.getElementById('r_sales_buy').textContent = currency(salesBuy);
      document.getElementById('r_sales_net').textContent = currency(salesNet);
      document.getElementById('r_sales_cash').textContent = currency(salesCash);
      document.getElementById('r_sales_transfer').textContent = currency(salesTransfer);
      
      document.getElementById('r_expenses_total').textContent = currency(expensesTotal);
      document.getElementById('r_commitments_total').textContent = currency(commitmentsTotal);
      document.getElementById('r_net_after_expenses').textContent = currency((maintNet + salesNet) - (expensesTotal + commitmentsTotal));
      
      document.getElementById('r_total_maint_net').textContent = currency(totalMaintNet);
      document.getElementById('r_total_sales_net').textContent = currency(totalSalesNet);
      document.getElementById('r_total_expenses_comprehensive').textContent = currency(totalExpensesComprehensive);
      document.getElementById('r_total_commitments_comprehensive').textContent = currency(totalCommitmentsComprehensive);
      document.getElementById('r_final_profit').textContent = currency(finalProfit);

      // Update range info
      const rangeInfo = document.getElementById('reportsRangeInfo');
      if (rangeInfo) {
        if (range.from && range.to) {
          rangeInfo.textContent = `الفترة: ${dateOnly(range.from)} إلى ${dateOnly(range.to)}`;
        } else {
          rangeInfo.textContent = 'كل الفترات';
        }
      }

    } catch (error) {
      console.error('Error loading reports:', error);
    }
  } */

async function loadReports() {
    console.log('📊 بدء تحميل التقارير...');
    
    try {
        const [invoices, maintenance, expenses, commitments] = await Promise.all([
            load('invoices'),
            load('maintenance'),
            load('expenses'),
            load('commitments')
        ]);

        console.log('📥 البيانات المحملة:', {
            فواتير: invoices.length,
            صيانة: maintenance.length,
            مصروفات: expenses.length,
            التزامات: commitments.length
        });

        // تطبيق فلترة التاريخ
        const range = getCurrentDateRange('reports');
        console.log('📅 نطاق الفلترة للتقرير:', {
            من: range.from ? dateOnly(range.from) : 'بدون',
            إلى: range.to ? dateOnly(range.to) : 'بدون'
        });

        let filteredInvoices = invoices;
        let filteredMaintenance = maintenance;
        let filteredExpenses = expenses;
        let filteredCommitments = commitments;

        if (range.from || range.to) {
            filteredInvoices = filterByDateRange(invoices, 'date', 'reports');
            filteredMaintenance = filterByDateRange(maintenance, 'received', 'reports');
            filteredExpenses = filterByDateRange(expenses, 'date', 'reports');
            filteredCommitments = filterCommitmentsByDateRangeForReports(commitments, range);
        }

        console.log('🔍 بعد الفلترة:', {
            فواتير: filteredInvoices.length,
            صيانة: filteredMaintenance.length,
            مصروفات: filteredExpenses.length,
            التزامات: filteredCommitments.length
        });

        // ========== تقارير الصيانة ==========
        let maintTotal = 0;
        let maintParts = 0;
        let maintCash = 0;
        let maintTransfer = 0;
        let maintDealers = 0;
        let maintInShop = 0;
        let maintDelivery = 0;

        filteredMaintenance.forEach(mnt => {
            const cost = toNumber(mnt.cost);
            const parts = toNumber(mnt.parts);
            
            maintTotal += cost;
            maintParts += parts;
            
            // Calculate dealer payments
            if (mnt.partsDealerId && parts > 0) {
                maintDealers += parts;
            }
            
            // Calculate by type
            if (mnt.type === 'in_shop') {
                maintInShop += cost;
            } else if (mnt.type === 'delivery') {
                maintDelivery += cost;
            } else {
                // Default to in_shop for old records
                maintInShop += cost;
            }
            
            if (mnt.paymentMethod === 'cash') {
                maintCash += cost;
            } else if (mnt.paymentMethod === 'transfer') {
                maintTransfer += cost;
            }
        });

        const maintNet = maintTotal - maintParts;

        // ========== تقارير المبيعات ==========
        let salesTotal = 0;
        let salesBuy = 0;
        let salesCash = 0;
        let salesTransfer = 0;

        filteredInvoices.forEach(inv => {
            const totalSell = toNumber(inv.totalSell);
            const totalBuy = toNumber(inv.totalBuy);
            
            salesTotal += totalSell;
            salesBuy += totalBuy;
            
            if (inv.paymentMethod === 'cash') {
                salesCash += totalSell;
            } else if (inv.paymentMethod === 'transfer') {
                salesTransfer += totalSell;
            }
        });

        const salesNet = salesTotal - salesBuy;

        // ========== تقارير المصاريف ==========
        let expensesTotal = 0;
        filteredExpenses.forEach(exp => {
            expensesTotal += toNumber(exp.amount);
        });

        // ========== تقارير الالتزامات ==========
        let commitmentsTotal = 0;
        
        // الحساب الصحيح للالتزامات الشهرية
        filteredCommitments.forEach(com => {
            if (com.status === 'active') {
                // التحقق إذا كان الالتزام نشطاً خلال النطاق الزمني
                if (isCommitmentActiveInRangeForReports(com, range)) {
                    commitmentsTotal += toNumber(com.amount);
                    console.log('➕ إضافة التزام:', com.name, toNumber(com.amount));
                }
            }
        });

        console.log('💰 إجمالي الالتزامات في النطاق:', commitmentsTotal);

        // ========== التقارير الشاملة ==========
        let totalMaintNet = maintNet;
        let totalSalesNet = salesNet;
        let totalExpensesComprehensive = expensesTotal;
        let totalCommitmentsComprehensive = commitmentsTotal;

        const finalProfit = (totalMaintNet + totalSalesNet) - 
                          (totalExpensesComprehensive + totalCommitmentsComprehensive);

        console.log('📈 النتائج النهائية:', {
            صافي_الصيانة: totalMaintNet,
            صافي_المبيعات: totalSalesNet,
            المصاريف: totalExpensesComprehensive,
            الالتزامات: totalCommitmentsComprehensive,
            الربح_النهائي: finalProfit
        });

        // تحديث واجهة المستخدم
        updateReportsUI({
            // تقارير الصيانة
            r_maint_total: maintTotal,
            r_maint_parts: maintParts,
            r_maint_net: maintNet,
            r_maint_dealers: maintDealers,
            r_maint_cash: maintCash,
            r_maint_transfer: maintTransfer,
            r_maint_in_shop: maintInShop,
            r_maint_delivery: maintDelivery,
            
            // تقارير المبيعات
            r_sales_total: salesTotal,
            r_sales_buy: salesBuy,
            r_sales_net: salesNet,
            r_sales_cash: salesCash,
            r_sales_transfer: salesTransfer,
            
            // تقارير المصاريف
            r_expenses_total: expensesTotal,
            r_commitments_total: commitmentsTotal,
            r_net_after_expenses: (maintNet + salesNet) - (expensesTotal + commitmentsTotal),
            
            // التقارير الشاملة
            r_total_maint_net: totalMaintNet,
            r_total_sales_net: totalSalesNet,
            r_total_expenses_comprehensive: totalExpensesComprehensive,
            r_total_commitments_comprehensive: totalCommitmentsComprehensive,
            r_final_profit: finalProfit
        });

        // عرض معلومات النطاق الزمني
        updateRangeInfo(range);

    } catch (error) {
        console.error('❌ خطأ في تحميل التقارير:', error);
        showToast('❌ خطأ في تحميل التقارير', 'error');
    }
}

// ========== الدوال المساعدة الجديدة ==========

// دالة مساعدة: فلترة الالتزامات للتقرير
function filterCommitmentsByDateRangeForReports(commitments, range) {
    if (!range.from && !range.to) return commitments;
    
    return commitments.filter(commitment => {
        return isCommitmentActiveInRangeForReports(commitment, range);
    });
}

// دالة مساعدة: التحقق إذا كان الالتزام نشطاً في النطاق الزمني للتقرير
function isCommitmentActiveInRangeForReports(commitment, range) {
    if (commitment.status !== 'active') return false;
    
    const startDate = new Date(commitment.startDate);
    const duration = toNumber(commitment.duration || 12);
    const endDate = new Date(startDate);
    endDate.setMonth(endDate.getMonth() + duration);
    
    // إذا لم يكن هناك نطاق زمني محدد، نعود جميع الالتزامات النشطة
    if (!range.from && !range.to) return true;
    
    // نطاق محدد: تحقق إذا كان الالتزام نشطاً في أي جزء من النطاق
    if (range.from && range.to) {
        return !(endDate < range.from || startDate > range.to);
    }
    
    // من تاريخ محدد إلى المستقبل
    if (range.from) {
        return endDate >= range.from;
    }
    
    // من الماضي إلى تاريخ محدد
    if (range.to) {
        return startDate <= range.to;
    }
    
    return false;
}

// دالة مساعدة: تحديث واجهة التقارير
function updateReportsUI(data) {
    // تقارير الصيانة
    document.getElementById('r_maint_total').textContent = currency(data.r_maint_total);
    document.getElementById('r_maint_parts').textContent = currency(data.r_maint_parts);
    document.getElementById('r_maint_net').textContent = currency(data.r_maint_net);
    document.getElementById('r_maint_dealers').textContent = currency(data.r_maint_dealers);
    document.getElementById('r_maint_cash').textContent = currency(data.r_maint_cash);
    document.getElementById('r_maint_transfer').textContent = currency(data.r_maint_transfer);
    document.getElementById('r_maint_in_shop').textContent = currency(data.r_maint_in_shop);
    document.getElementById('r_maint_delivery').textContent = currency(data.r_maint_delivery);
    
    // تقارير المبيعات
    document.getElementById('r_sales_total').textContent = currency(data.r_sales_total);
    document.getElementById('r_sales_buy').textContent = currency(data.r_sales_buy);
    document.getElementById('r_sales_net').textContent = currency(data.r_sales_net);
    document.getElementById('r_sales_cash').textContent = currency(data.r_sales_cash);
    document.getElementById('r_sales_transfer').textContent = currency(data.r_sales_transfer);
    
    // تقارير المصاريف
    document.getElementById('r_expenses_total').textContent = currency(data.r_expenses_total);
    document.getElementById('r_commitments_total').textContent = currency(data.r_commitments_total);
    document.getElementById('r_net_after_expenses').textContent = currency(data.r_net_after_expenses);
    
    // التقارير الشاملة
    document.getElementById('r_total_maint_net').textContent = currency(data.r_total_maint_net);
    document.getElementById('r_total_sales_net').textContent = currency(data.r_total_sales_net);
    document.getElementById('r_total_expenses_comprehensive').textContent = currency(data.r_total_expenses_comprehensive);
    document.getElementById('r_total_commitments_comprehensive').textContent = currency(data.r_total_commitments_comprehensive);
    document.getElementById('r_final_profit').textContent = currency(data.r_final_profit);
}

// دالة مساعدة: تحديث معلومات النطاق الزمني
function updateRangeInfo(range) {
    const rangeInfo = document.createElement('div');
    rangeInfo.className = 'alert alert-info mt-3';
    rangeInfo.id = 'reportsRangeInfo';
    
    if (range.from && range.to) {
        rangeInfo.innerHTML = `
            <i class="bi bi-calendar-range me-2"></i>
            <strong>الفترة المحددة:</strong> 
            من ${dateOnly(range.from)} إلى ${dateOnly(range.to)}
        `;
    } else {
        rangeInfo.innerHTML = `
            <i class="bi bi-calendar-check me-2"></i>
            <strong>الفترة:</strong> كل الفترات
        `;
    }
    
    // إزالة العنصر القديم إذا كان موجوداً
    const oldInfo = document.getElementById('reportsRangeInfo');
    if (oldInfo) oldInfo.remove();
    
    // إضافة العنصر الجديد في بداية قسم التقارير
    const reportsSection = document.getElementById('reports');
    if (reportsSection) {
        reportsSection.insertBefore(rangeInfo, reportsSection.firstChild);
    }
}

// دالة مساعدة: تصحيح حساب الالتزامات للشهر الحالي
function calculateCurrentMonthCommitments(commitments) {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    let monthlyTotal = 0;
    
    commitments.forEach(commitment => {
        if (commitment.status === 'active') {
            const startDate = new Date(commitment.startDate);
            const duration = toNumber(commitment.duration || 12);
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + duration);
            
            // التحقق إذا كان الالتزام نشطاً في الشهر الحالي
            const isActiveThisMonth = startDate <= now && endDate >= now;
            
            if (isActiveThisMonth) {
                monthlyTotal += toNumber(commitment.amount);
                console.log('✅ التزام نشط هذا الشهر:', commitment.name, toNumber(commitment.amount));
            }
        }
    });
    
    return monthlyTotal;
}

// دالة مساعدة: إضافة بيانات اختبارية للالتزامات
async function addTestCommitmentsForReports() {
    try {
        const now = new Date();
        const testCommitments = [
            {
                id: 'test_commit_' + Date.now() + '_1',
                name: 'إيجار المحل - اختبار',
                amount: 2000,
                startDate: dateOnly(new Date(now.getFullYear(), now.getMonth() - 2, 1)),
                duration: 12,
                status: 'active',
                createdAt: nowISO(),
                updatedAt: nowISO()
            },
            {
                id: 'test_commit_' + Date.now() + '_2',
                name: 'اشتراك الإنترنت - اختبار',
                amount: 150,
                startDate: dateOnly(new Date(now.getFullYear(), now.getMonth() - 1, 15)),
                duration: 6,
                status: 'active',
                createdAt: nowISO(),
                updatedAt: nowISO()
            },
            {
                id: 'test_commit_' + Date.now() + '_3',
                name: 'رواتب الموظفين - اختبار',
                amount: 5000,
                startDate: dateOnly(new Date(now.getFullYear(), 0, 1)), // بداية السنة
                duration: 12,
                status: 'active',
                createdAt: nowISO(),
                updatedAt: nowISO()
            }
        ];
        
        const currentCommitments = await load('commitments');
        const updatedCommitments = [...currentCommitments, ...testCommitments];
        
        await save('commitments', updatedCommitments);
        showToast('✅ تم إضافة التزامات اختبارية', 'success');
        
        // إعادة تحميل التقارير
        setTimeout(() => loadReports(), 1000);
        
    } catch (error) {
        console.error('خطأ في إضافة التزامات الاختبار:', error);
        showToast('❌ خطأ في إضافة التزامات الاختبار', 'error');
    }
}

// ========== إضافة زر اختبار إلى واجهة التقارير ==========

// أضف هذا HTML في قسم التقارير (بعد أزرار الفلترة)
/*
<div class="text-center mt-3 mb-4">
    <button class="btn btn-sm btn-outline-warning" onclick="debugReports()">
        <i class="bi bi-bug"></i> تشخيص التقارير
    </button>
    <button class="btn btn-sm btn-outline-info" onclick="addTestCommitmentsForReports()">
        <i class="bi bi-plus-circle"></i> إضافة التزامات اختبار
    </button>
    <button class="btn btn-sm btn-outline-primary" onclick="showCommitmentsReportDetails()">
        <i class="bi bi-info-circle"></i> تفاصيل الالتزامات
    </button>
</div>
*/

// دالة تشخيص التقارير
async function debugReports() {
    console.clear();
    console.log('🔍 === تشخيص التقارير ===');
    
    try {
        // تحميل البيانات
        const commitments = await load('commitments');
        const now = new Date();
        const range = getCurrentDateRange('reports');
        
        console.group('1. بيانات الالتزامات');
        console.log('إجمالي الالتزامات:', commitments.length);
        
        const activeCommitments = commitments.filter(c => c.status === 'active');
        console.log('الالتزامات النشطة:', activeCommitments.length);
        
        activeCommitments.forEach((c, i) => {
            console.log(`${i+1}. ${c.name}: ${c.amount} دينار (${dateOnly(c.startDate)} - ${c.duration} شهر)`);
        });
        console.groupEnd();
        
        console.group('2. نطاق الفلترة');
        console.log('من:', range.from ? dateOnly(range.from) : 'بدون');
        console.log('إلى:', range.to ? dateOnly(range.to) : 'بدون');
        console.groupEnd();
        
        console.group('3. التحقق من الالتزامات النشطة في النطاق');
        let total = 0;
        activeCommitments.forEach(c => {
            const isActive = isCommitmentActiveInRangeForReports(c, range);
            console.log(`${c.name}: ${isActive ? '✅ نشط' : '❌ غير نشط'} - ${c.amount} دينار`);
            if (isActive) total += toNumber(c.amount);
        });
        console.log('الإجمالي المحسوب:', total);
        console.groupEnd();
        
        console.group('4. مقارنة مع القيمة المعروضة');
        const displayedValue = document.getElementById('r_commitments_total').textContent;
        console.log('القيمة المعروضة:', displayedValue);
        console.log('القيمة المحسوبة:', currency(total));
        console.groupEnd();
        
        alert(`نتيجة التشخيص:
        • إجمالي الالتزامات: ${commitments.length}
        • النشطة: ${activeCommitments.length}
        • المحسوبة في النطاق: ${total} دينار
        • المعروضة: ${displayedValue}
        
        افتح Console (F12) للمزيد من التفاصيل`);
        
    } catch (error) {
        console.error('خطأ في التشخيص:', error);
        alert('حدث خطأ في التشخيص');
    }
}

// دالة لعرض تفاصيل الالتزامات في التقرير
async function showCommitmentsReportDetails() {
    try {
        const commitments = await load('commitments');
        const activeCommitments = commitments.filter(c => c.status === 'active');
        const range = getCurrentDateRange('reports');
        
        let details = `
            <div class="commitments-report-details">
                <h5 class="border-bottom pb-2">تفاصيل الالتزامات في التقرير</h5>
                <p><strong>النطاق الزمني:</strong> ${range.from ? dateOnly(range.from) : 'بداية'} - ${range.to ? dateOnly(range.to) : 'نهاية'}</p>
                
                <table class="table table-sm table-hover mt-3">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم الالتزام</th>
                            <th>المبلغ</th>
                            <th>تاريخ البدء</th>
                            <th>المدة</th>
                            <th>الحالة</th>
                            <th>متضمن في التقرير</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        let totalIncluded = 0;
        let totalExcluded = 0;
        
        activeCommitments.forEach((c, i) => {
            const isIncluded = isCommitmentActiveInRangeForReports(c, range);
            const amount = toNumber(c.amount);
            
            if (isIncluded) {
                totalIncluded += amount;
            } else {
                totalExcluded += amount;
            }
            
            details += `
                <tr class="${isIncluded ? 'table-success' : 'table-light'}">
                    <td>${i + 1}</td>
                    <td>${escapeHtml(c.name)}</td>
                    <td>${currency(amount)}</td>
                    <td>${dateOnly(c.startDate)}</td>
                    <td>${c.duration || 12} شهر</td>
                    <td><span class="badge bg-success">نشط</span></td>
                    <td>
                        <span class="badge ${isIncluded ? 'bg-success' : 'bg-secondary'}">
                            ${isIncluded ? '✅ نعم' : '❌ لا'}
                        </span>
                    </td>
                </tr>
            `;
        });
        
        details += `
                    </tbody>
                </table>
                
                <div class="alert alert-info mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>المجموع المضمن:</strong>
                            <div class="h4 text-success">${currency(totalIncluded)}</div>
                        </div>
                        <div class="col-md-6">
                            <strong>المجموع المستبعد:</strong>
                            <div class="h4 text-secondary">${currency(totalExcluded)}</div>
                        </div>
                    </div>
                    <div class="mt-2 text-muted">
                        <small>يتم تضمين الالتزامات النشطة فقط خلال النطاق الزمني المحدد.</small>
                    </div>
                </div>
            </div>
        `;
        
        // عرض في مودال
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'commitmentsDetailsModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تفاصيل حساب الالتزامات</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${details}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                        <button type="button" class="btn btn-primary" onclick="loadReports()" data-bs-dismiss="modal">
                            <i class="bi bi-arrow-clockwise"></i> تحديث التقرير
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // تنظيف بعد إغلاق المودال
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
        
    } catch (error) {
        console.error('خطأ في عرض تفاصيل الالتزامات:', error);
        showToast('❌ خطأ في عرض التفاصيل', 'error');
    }
}

// جعل الدوال متاحة عالمياً
window.debugReports = debugReports;
window.addTestCommitmentsForReports = addTestCommitmentsForReports;
window.showCommitmentsReportDetails = showCommitmentsReportDetails;
window.calculateCurrentMonthCommitments = calculateCurrentMonthCommitments;
  // ---------- Advanced Backup Functions ----------
  function setupBackup() {
    // Backup type toggle
    document.getElementById('backupType').addEventListener('change', function() {
      const customOptions = document.getElementById('customBackupOptions');
      customOptions.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    // Auto backup toggle
    document.getElementById('autoBackupToggle').addEventListener('change', function() {
      document.getElementById('autoBackupInterval').disabled = !this.checked;
    });
    
    // Create backup
    document.getElementById('btnCreateBackup').addEventListener('click', async function() {
      try {
        showLoading();
        
        // Determine what to backup
        const backupType = document.getElementById('backupType').value;
        let backupData = {};
        
        if (backupType === 'full') {
          // Backup all data
          const collections = [
            'customers', 'products', 'invoices', 'maintenance',
            'parts', 'dealers', 'expenses', 'commitments', 'users', 
            'counters', 'notifications', 'dealerPayments'
          ];
          
          for (const collection of collections) {
            backupData[collection] = await load(collection);
          }
        } else {
          // Custom backup
          const collections = [];
          if (document.getElementById('backupCustomers').checked) collections.push('customers');
          if (document.getElementById('backupProducts').checked) collections.push('products');
          if (document.getElementById('backupInvoices').checked) collections.push('invoices');
          if (document.getElementById('backupMaintenance').checked) collections.push('maintenance');
          if (document.getElementById('backupParts').checked) collections.push('parts');
          if (document.getElementById('backupDealers').checked) collections.push('dealers');
          if (document.getElementById('backupExpenses').checked) collections.push('expenses');
          if (document.getElementById('backupCommitments').checked) collections.push('commitments');
          if (document.getElementById('backupUsers').checked) collections.push('users');
          if (document.getElementById('backupDealers').checked) collections.push('dealerPayments');
          
          for (const collection of collections) {
            backupData[collection] = await load(collection);
          }
        }
        
        // Add metadata
        backupData.metadata = {
          app: 'WESAM System',
          version: '2.0',
          backupDate: nowISO(),
          dataCount: Object.keys(backupData).length - 1 // Exclude metadata
        };
        
        // Create download
        const dataStr = JSON.stringify(backupData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `wesam-backup-${new Date().toISOString().slice(0,10)}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showToast('✅ تم إنشاء النسخة الاحتياطية بنجاح', 'success');
        createNotification('نسخ احتياطي', 'تم إنشاء نسخة احتياطية جديدة', 'info');
        
      } catch (error) {
        console.error('Error creating backup:', error);
        showToast('❌ خطأ في إنشاء النسخة الاحتياطية', 'error');
      } finally {
        hideLoading();
      }
    });
    
    // Restore backup
    document.getElementById('btnRestoreBackup').addEventListener('click', async function() {
      const fileInput = document.getElementById('backupFile');
      const restoreType = document.getElementById('restoreType').value;
      
      if (!fileInput.files.length) {
        showToast('❌ يرجى اختيار ملف النسخ الاحتياطي', 'error');
        return;
      }
      
      if (!confirm('تحذير: هذه العملية ستؤثر على البيانات الحالية. هل تريد المتابعة؟')) {
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          showLoading();
          
          const backupData = JSON.parse(e.target.result);
          
          if (restoreType === 'full') {
            // Full restore - replace all data
            for (const [key, value] of Object.entries(backupData)) {
              if (key !== 'metadata') {
                await save(key, value);
              }
            }
            clearCache(); // Clear all cache
            showToast('✅ تم استعادة جميع البيانات بنجاح', 'success');
            createNotification('استعادة البيانات', 'تم استعادة جميع البيانات من النسخة الاحتياطية', 'success');
          } else {
            // Merge restore - add without deleting
            for (const [key, value] of Object.entries(backupData)) {
              if (key !== 'metadata' && Array.isArray(value)) {
                const currentData = await load(key);
                const mergedData = [...currentData, ...value];
                // Remove duplicates by id
                const uniqueData = mergedData.filter((item, index, self) =>
                  index === self.findIndex((t) => t.id === item.id)
                );
                await save(key, uniqueData);
              }
            }
            clearCache(); // Clear all cache
            showToast('✅ تم دمج البيانات بنجاح', 'success');
            createNotification('دمج البيانات', 'تم دمج البيانات من النسخة الاحتياطية', 'info');
          }
          
          // Clear file input
          fileInput.value = '';
          
          // Reload the page to reflect changes
          setTimeout(() => {
            window.location.reload();
          }, 2000);
          
        } catch (error) {
          console.error('Error restoring backup:', error);
          showToast('❌ خطأ في استعادة البيانات: ' + error.message, 'error');
        } finally {
          hideLoading();
        }
      };
      
      reader.onerror = function() {
        showToast('❌ خطأ في قراءة الملف', 'error');
      };
      
      reader.readAsText(file);
    });
    
    // Manual backup
    document.getElementById('btnManualBackup').addEventListener('click', async function() {
      try {
        showLoading();
        
        // Save backup to storage
        const backupData = {};
        const collections = [
          'customers', 'products', 'invoices', 'maintenance',
          'parts', 'dealers', 'expenses', 'commitments', 'users', 
          'counters', 'notifications', 'dealerPayments'
        ];
        
        for (const collection of collections) {
          backupData[collection] = await load(collection);
        }
        
        backupData.metadata = {
          app: 'WESAM System',
          version: '2.0',
          backupDate: nowISO(),
          type: 'manual'
        };
        
        // Save to localStorage
        const backupKey = `backup_${Date.now()}`;
        localStorage.setItem(backupKey, JSON.stringify(backupData));
        
        // Also save to current backup
        await save('system_backup', backupData);
        
        showToast('✅ تم حفظ النسخة الاحتياطية محلياً', 'success');
        createNotification('نسخ احتياطي تلقائي', 'تم إنشاء نسخة احتياطية تلقائية', 'info');
        
      } catch (error) {
        console.error('Error creating manual backup:', error);
        showToast('❌ خطأ في إنشاء النسخة الاحتياطية', 'error');
      } finally {
        hideLoading();
      }
    });
  }

  // ---------- Advanced Backup System ----------
  async function setupAutoBackup() {
    try {
      const autoBackupEnabled = localStorage.getItem('autoBackupEnabled') === 'true';
      const autoBackupInterval = localStorage.getItem('autoBackupInterval') || 'weekly';
      const lastAutoBackup = localStorage.getItem('lastAutoBackup');
      
      if (!autoBackupEnabled) return;
      
      const now = Date.now();
      const shouldBackup = () => {
        if (!lastAutoBackup) return true;
        
        const lastBackupTime = parseInt(lastAutoBackup);
        const intervalMs = autoBackupInterval === 'weekly' ? 7 * 24 * 60 * 60 * 1000 : 30 * 24 * 60 * 60 * 1000;
        
        return now - lastBackupTime >= intervalMs;
      };
      
      if (shouldBackup()) {
        console.log('🔄 Performing auto backup...');
        await createAutoBackup();
        localStorage.setItem('lastAutoBackup', now.toString());
      }
    } catch (error) {
      console.error('Auto backup error:', error);
    }
  }

  async function createAutoBackup() {
    try {
      const backupData = {};
      const collections = [
        'customers', 'products', 'invoices', 'maintenance',
        'parts', 'dealers', 'expenses', 'commitments', 'users', 
        'counters', 'dealerPayments'
      ];
      
      for (const collection of collections) {
        backupData[collection] = await load(collection);
      }
      
      backupData.metadata = {
        app: 'WESAM System',
        version: '2.0',
        backupDate: nowISO(),
        type: 'auto'
      };
      
      // Save to Firebase if connected
      if (useFirebase && database) {
        await database.ref('auto_backups').push(backupData);
      }
      
      // Save to localStorage
      const backupKey = `auto_backup_${Date.now()}`;
      localStorage.setItem(backupKey, JSON.stringify(backupData));
      
      console.log('✅ Auto backup created');
      createNotification('نسخ احتياطي تلقائي', 'تم إنشاء نسخة احتياطية تلقائية جديدة', 'info');
      
    } catch (error) {
      console.error('Error creating auto backup:', error);
    }
  }

  // ---------- Database Management ----------
  async function autoCleanup() {
    try {
      const retentionDays = 365; // Keep data for 1 year
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
      
      // Clean up old data
      const collections = ['invoices', 'maintenance', 'expenses'];
      
      for (const collection of collections) {
        const data = await load(collection);
        const filteredData = data.filter(item => {
          const itemDate = new Date(item.date || item.createdAt);
          return itemDate >= cutoffDate;
        });
        
        if (filteredData.length < data.length) {
          await save(collection, filteredData);
          console.log(`Cleaned up ${data.length - filteredData.length} old records from ${collection}`);
        }
      }
      
      // Clean up expired commitments
      const commitments = await load('commitments');
      const activeCommitments = commitments.filter(commitment => {
        if (commitment.status !== 'active') return true;
        
        const startDate = new Date(commitment.startDate);
        const endDate = new Date(startDate);
        endDate.setMonth(endDate.getMonth() + (commitment.duration || 12));
        
        return endDate >= new Date();
      });
      
      if (activeCommitments.length < commitments.length) {
        await save('commitments', activeCommitments);
        console.log(`Cleaned up ${commitments.length - activeCommitments.length} expired commitments`);
      }
      
    } catch (error) {
      console.error('Error in auto cleanup:', error);
    }
  }

  // ---------- Form Handlers ----------
  async function populateSelects() {
    try {
      // Populate customer selects
      const customers = await load('customers');
      const customerSelects = document.querySelectorAll('#invCustomer, #mntCustomer');
      
      customerSelects.forEach(select => {
        select.innerHTML = '<option value="">-- اختر العميل --</option>';
        customers.forEach(customer => {
          const option = document.createElement('option');
          option.value = customer.id;
          option.textContent = customer.name;
          select.appendChild(option);
        });
      });
      
      // Populate dealer selects
      const dealers = await load('dealers');
      const dealerSelects = document.querySelectorAll('#mntPartsDealer, #partSupplier');
      
      dealerSelects.forEach(select => {
        select.innerHTML = '<option value="">-- اختر التاجر --</option>';
        dealers.forEach(dealer => {
          const option = document.createElement('option');
          option.value = dealer.id;
          option.textContent = dealer.name;
          select.appendChild(option);
        });
      });
      
    } catch (error) {
      console.error('Error populating selects:', error);
    }
  }

  // Customer form
  document.getElementById('customerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('customers', 'create') && !document.getElementById('custId').value) {
        showToast('❌ لا تملك صلاحية إضافة عملاء', 'error');
        return;
      }
      
      if (!checkPermission('customers', 'update') && document.getElementById('custId').value) {
        showToast('❌ لا تملك صلاحية تعديل العملاء', 'error');
        return;
      }
      
      const customers = await load('customers');
      const id = document.getElementById('custId').value;
      const isEdit = !!id;
      
      const customerData = {
        name: document.getElementById('custName').value,
        deviceType: document.getElementById('custDeviceType').value,
        deviceSize: document.getElementById('custDeviceSize').value,
        phone: document.getElementById('custPhone').value,
        address: document.getElementById('custAddress').value,
        notes: document.getElementById('custNotes').value,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing customer
        const index = customers.findIndex(c => c.id === id);
        if (index !== -1) {
          customers[index] = { ...customers[index], ...customerData };
        }
      } else {
        // Add new customer
        customerData.id = uid();
        customerData.createdAt = nowISO();
        customers.push(customerData);
      }
      
      await save('customers', customers);
      clearCache('customers');
      hideModal('customerModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} العميل بنجاح`, 'success');
      loadCustomers();
      
    } catch (error) {
      console.error('Error saving customer:', error);
      showToast('❌ خطأ في حفظ العميل', 'error');
    }
  });

  // Product form
  document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('products', 'create') && !document.getElementById('prodId').value) {
        showToast('❌ لا تملك صلاحية إضافة منتجات', 'error');
        return;
      }
      
      if (!checkPermission('products', 'update') && document.getElementById('prodId').value) {
        showToast('❌ لا تملك صلاحية تعديل المنتجات', 'error');
        return;
      }
      
      const products = await load('products');
      const id = document.getElementById('prodId').value;
      const isEdit = !!id;
      
      const productData = {
        name: document.getElementById('prodName').value,
        buy: toNumber(document.getElementById('prodBuy').value),
        sell: toNumber(document.getElementById('prodSell').value),
        stock: toNumber(document.getElementById('prodStock').value),
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing product
        const index = products.findIndex(p => p.id === id);
        if (index !== -1) {
          products[index] = { ...products[index], ...productData };
        }
      } else {
        // Add new product
        productData.id = uid();
        productData.createdAt = nowISO();
        products.push(productData);
      }
      
      await save('products', products);
      clearCache('products');
      hideModal('productModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} المنتج بنجاح`, 'success');
      loadProducts();
      
    } catch (error) {
      console.error('Error saving product:', error);
      showToast('❌ خطأ في حفظ المنتج', 'error');
    }
  });

  // Invoice form
  document.getElementById('btnAddInvoice').addEventListener('click', async function() {
    try {
      if (!checkPermission('invoices', 'create')) {
        showToast('❌ لا تملك صلاحية إنشاء فواتير', 'error');
        return;
      }
      
      // Reset form
      document.getElementById('invoiceForm').reset();
      document.getElementById('invId').value = '';
      document.getElementById('invDate').value = dateOnly(new Date());
      document.getElementById('invoiceModalTitle').textContent = 'إنشاء فاتورة بيع';
      
      // Generate invoice number
      const counters = await load('counters');
      const invoiceNumber = counters.invoice + 1;
      document.getElementById('invNumber').value = `INV-${invoiceNumber}`;
      
      // Clear items container
      document.getElementById('invoiceItemsContainer').innerHTML = '';
      
      // Reset invoice item count
      invoiceItemCount = 0;
      
      // Add first item row
      addInvoiceItemRow();
      
      // Populate selects
      await populateSelects();
      
      showModal('invoiceModal');
      
    } catch (error) {
      console.error('Error opening invoice modal:', error);
      showToast('❌ خطأ في فتح نموذج الفاتورة', 'error');
    }
  });

  function addInvoiceItemRow() {
    invoiceItemCount++;
    const container = document.getElementById('invoiceItemsContainer');
    
    const row = document.createElement('div');
    row.className = 'invoice-item-row';
    row.id = `itemRow_${invoiceItemCount}`;
    row.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-md-5">
          <select class="form-select form-select-sm product-select" onchange="updateProductPrice(this, ${invoiceItemCount})">
            <option value="">-- اختر المنتج --</option>
          </select>
        </div>
        <div class="col-md-2">
          <input type="number" class="form-control form-control-sm quantity-input" 
                 onchange="updateInvoiceTotals()" oninput="updateInvoiceTotals()" 
                 value="1" min="1" id="quantity_${invoiceItemCount}">
        </div>
        <div class="col-md-2">
          <input type="number" class="form-control form-control-sm" 
                 readonly id="buyPrice_${invoiceItemCount}">
        </div>
        <div class="col-md-2">
          <input type="number" class="form-control form-control-sm" 
                 readonly id="sellPrice_${invoiceItemCount}">
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${invoiceItemCount})">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <input type="hidden" id="productId_${invoiceItemCount}">
    `;
    
    container.appendChild(row);
    
    // Populate product select
    populateProductSelect(row.querySelector('.product-select'));
  }

  async function populateProductSelect(selectElement) {
    try {
      const products = await load('products');
      selectElement.innerHTML = '<option value="">-- اختر المنتج --</option>';
      products.forEach(product => {
        if (toNumber(product.stock) > 0) {
          const option = document.createElement('option');
          option.value = product.id;
          option.textContent = `${product.name} (المخزون: ${product.stock})`;
          selectElement.appendChild(option);
        }
      });
    } catch (error) {
      console.error('Error populating product select:', error);
    }
  }

  async function updateProductPrice(selectElement, rowId) {
    try {
      const productId = selectElement.value;
      if (!productId) {
        document.getElementById(`buyPrice_${rowId}`).value = '';
        document.getElementById(`sellPrice_${rowId}`).value = '';
        document.getElementById(`productId_${rowId}`).value = '';
        updateInvoiceTotals();
        return;
      }
      
      const products = await load('products');
      const product = products.find(p => p.id === productId);
      if (product) {
        document.getElementById(`buyPrice_${rowId}`).value = product.buy;
        document.getElementById(`sellPrice_${rowId}`).value = product.sell;
        document.getElementById(`productId_${rowId}`).value = product.id;
      }
      
      updateInvoiceTotals();
    } catch (error) {
      console.error('Error updating product price:', error);
    }
  }

  function removeInvoiceItem(rowId) {
    const row = document.getElementById(`itemRow_${rowId}`);
    if (row) {
      row.remove();
      updateInvoiceTotals();
    }
  }

  function updateInvoiceTotals() {
    let totalSell = 0;
    let totalBuy = 0;
    
    for (let i = 1; i <= invoiceItemCount; i++) {
      const row = document.getElementById(`itemRow_${i}`);
      if (row) {
        const quantity = toNumber(document.getElementById(`quantity_${i}`)?.value || 0);
        const sellPrice = toNumber(document.getElementById(`sellPrice_${i}`)?.value || 0);
        const buyPrice = toNumber(document.getElementById(`buyPrice_${i}`)?.value || 0);
        
        totalSell += quantity * sellPrice;
        totalBuy += quantity * buyPrice;
      }
    }
    
    const net = totalSell - totalBuy;
    
    document.getElementById('invTotalSell').value = totalSell.toFixed(2);
    document.getElementById('invTotalBuy').value = totalBuy.toFixed(2);
    document.getElementById('invNet').value = net.toFixed(2);
  }

  document.getElementById('btnAddItem').addEventListener('click', function() {
    addInvoiceItemRow();
  });

  document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('invoices', 'create')) {
        showToast('❌ لا تملك صلاحية إنشاء فواتير', 'error');
        return;
      }
      
      // Validate
      const customerId = document.getElementById('invCustomer').value;
      // Allow anonymous customers (customerId can be empty or 'anonymous')
      
      // Collect items
      const items = [];
      let hasItems = false;
      let hasStockError = false;
      
      const products = await load('products');
      
      for (let i = 1; i <= invoiceItemCount; i++) {
        const row = document.getElementById(`itemRow_${i}`);
        if (row) {
          const productId = document.getElementById(`productId_${i}`)?.value;
          const quantity = toNumber(document.getElementById(`quantity_${i}`)?.value || 0);
          
          if (productId && quantity > 0) {
            const product = products.find(p => p.id === productId);
            if (product && toNumber(product.stock) < quantity) {
              showToast(`❌ كمية المنتج ${product.name} غير متوفرة. المتاح: ${product.stock}`, 'error');
              hasStockError = true;
              break;
            }
            
            const buyPrice = toNumber(document.getElementById(`buyPrice_${i}`)?.value || 0);
            const sellPrice = toNumber(document.getElementById(`sellPrice_${i}`)?.value || 0);
            
            items.push({
              productId,
              quantity,
              buy: buyPrice,
              sell: sellPrice
            });
            hasItems = true;
          }
        }
      }
      
      if (hasStockError) return;
      
      if (!hasItems) {
        showToast('❌ يرجى إضافة منتجات على الأقل', 'error');
        return;
      }
      
      // Calculate totals
      const totalSell = items.reduce((sum, item) => sum + (item.quantity * item.sell), 0);
      const totalBuy = items.reduce((sum, item) => sum + (item.quantity * item.buy), 0);
      const net = totalSell - totalBuy;
      
      // Get counters for invoice number
      const counters = await load('counters');
      const invoiceNumber = counters.invoice + 1;
      
      // Create invoice
      const invoice = {
        id: uid(),
        number: `INV-${invoiceNumber}`,
        customerId: customerId || 'anonymous',
        items,
        totalSell,
        totalBuy,
        net,
        date: document.getElementById('invDate').value || dateOnly(new Date()),
        paymentMethod: document.getElementById('invPaymentMethod').value,
        paymentStatus: document.getElementById('invPaymentStatus').value,
        notes: document.getElementById('invNotes').value,
        createdAt: nowISO()
      };
      
      // Save invoice
      const invoices = await load('invoices');
      invoices.push(invoice);
      await save('invoices', invoices);
      clearCache('invoices');
      
      // Update counters
      counters.invoice = invoiceNumber;
      await save('counters', counters);
      
      // Update product stock
      items.forEach(item => {
        const productIndex = products.findIndex(p => p.id === item.productId);
        if (productIndex !== -1) {
          products[productIndex].stock -= item.quantity;
          if (products[productIndex].stock < 0) products[productIndex].stock = 0;
        }
      });
      await save('products', products);
      clearCache('products');
      
      hideModal('invoiceModal');
      showToast('✅ تم إنشاء الفاتورة بنجاح', 'success');
      createNotification('فاتورة جديدة', `تم إنشاء فاتورة جديدة برقم ${invoice.number}`, 'success');
      loadInvoices();
      loadProducts(); // Refresh products table to show updated stock
      
    } catch (error) {
      console.error('Error saving invoice:', error);
      showToast('❌ خطأ في حفظ الفاتورة', 'error');
    }
  });

  // Maintenance form
  document.getElementById('btnAddMaintenance').addEventListener('click', async function() {
    try {
      if (!checkPermission('maintenance', 'create')) {
        showToast('❌ لا تملك صلاحية إضافة صيانة', 'error');
        return;
      }
      
      // Reset form
      document.getElementById('maintenanceForm').reset();
      document.getElementById('mntId').value = '';
      const today = new Date();
      document.getElementById('mntReceived').value = dateOnly(today);
      document.getElementById('mntDelivery').value = dateOnly(today);
      const warrantyDate = new Date(today);
      warrantyDate.setFullYear(warrantyDate.getFullYear() + 1);
      document.getElementById('mntWarranty').value = dateOnly(warrantyDate);
      document.getElementById('mntCost').value = '0';
      document.getElementById('mntParts').value = '0';
      document.getElementById('mntType').value = 'in_shop';
      document.getElementById('maintenanceModalTitle').textContent = 'إضافة أمر صيانة';
      
      // Calculate net
      updateMaintenanceNet();
      
      // Populate selects
      await populateSelects();
      
      showModal('maintenanceModal');
      
    } catch (error) {
      console.error('Error opening maintenance modal:', error);
      showToast('❌ خطأ في فتح نموذج الصيانة', 'error');
    }
  });

  function updateMaintenanceNet() {
    const cost = toNumber(document.getElementById('mntCost').value || 0);
    const parts = toNumber(document.getElementById('mntParts').value || 0);
    const net = cost - parts;
    document.getElementById('mntNet').value = net.toFixed(2);
  }

  function updateMaintenanceWarrantyFromDelivery() {
    const delivery = document.getElementById('mntDelivery').value;
    if (!delivery) return;
    const d = new Date(delivery);
    if (isNaN(d.getTime())) return;
    const w = new Date(d);
    w.setFullYear(w.getFullYear() + 1);
    document.getElementById('mntWarranty').value = dateOnly(w);
  }

  function updateMaintenanceDatesFromReceived() {
    const received = document.getElementById('mntReceived').value;
    if (!received) return;
    const deliveryInput = document.getElementById('mntDelivery');
    if (!deliveryInput.value) {
      deliveryInput.value = received;
    }
    updateMaintenanceWarrantyFromDelivery();
  }

  document.getElementById('mntCost').addEventListener('input', updateMaintenanceNet);
  document.getElementById('mntParts').addEventListener('input', updateMaintenanceNet);
  document.getElementById('mntReceived').addEventListener('change', updateMaintenanceDatesFromReceived);
  document.getElementById('mntDelivery').addEventListener('change', updateMaintenanceWarrantyFromDelivery);

  document.getElementById('maintenanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('maintenance', 'create') && !document.getElementById('mntId').value) {
        showToast('❌ لا تملك صلاحية إضافة صيانة', 'error');
        return;
      }
      
      if (!checkPermission('maintenance', 'update') && document.getElementById('mntId').value) {
        showToast('❌ لا تملك صلاحية تعديل الصيانة', 'error');
        return;
      }
      
      const maintenance = await load('maintenance');
      const dealers = await load('dealers');
      const id = document.getElementById('mntId').value;
      const isEdit = !!id;
      
      // Get counters for order number
      const counters = await load('counters');
      const orderNumber = counters.maintenance + 1;
      
      const partsDealerId = document.getElementById('mntPartsDealer').value;
      const partsCost = toNumber(document.getElementById('mntParts').value || 0);
      
      const maintenanceData = {
        number: `MNT-${orderNumber}`,
        customerId: document.getElementById('mntCustomer').value,
        device: document.getElementById('mntDevice').value,
        type: document.getElementById('mntType').value,
        cost: toNumber(document.getElementById('mntCost').value || 0),
        parts: partsCost,
        partsDealerId: partsDealerId || null,
        net: toNumber(document.getElementById('mntNet').value || 0),
        received: document.getElementById('mntReceived').value,
        delivery: document.getElementById('mntDelivery').value,
        warranty: document.getElementById('mntWarranty').value,
        paymentMethod: document.getElementById('mntPaymentMethod').value,
        paymentStatus: document.getElementById('mntPaymentStatus').value,
        status: document.getElementById('mntStatus').value,
        notes: document.getElementById('mntNotes').value,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing maintenance order
        const oldMaintenance = maintenance.find(m => m.id === id);
        const oldPartsDealerId = oldMaintenance?.partsDealerId;
        const oldPartsCost = toNumber(oldMaintenance?.parts || 0);
        
        const index = maintenance.findIndex(m => m.id === id);
        if (index !== -1) {
          maintenanceData.number = maintenance[index].number; // Keep original number
          maintenance[index] = { ...maintenance[index], ...maintenanceData };
        }
      } else {
        // Add new maintenance order
        maintenanceData.id = uid();
        maintenanceData.createdAt = nowISO();
        maintenance.push(maintenanceData);
        
        // Update counters for new orders only
        counters.maintenance = orderNumber;
        await save('counters', counters);
      }
      
      await save('maintenance', maintenance);
      clearCache('maintenance');
      hideModal('maintenanceModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} أمر الصيانة بنجاح`, 'success');
      createNotification('أمر صيانة', `تم ${isEdit ? 'تعديل' : 'إضافة'} أمر صيانة جديد`, 'success');
      loadMaintenance();
      
    } catch (error) {
      console.error('Error saving maintenance:', error);
      showToast('❌ خطأ في حفظ أمر الصيانة', 'error');
    }
  });

  // Part form
  document.getElementById('btnAddPart').addEventListener('click', async function() {
    try {
      if (!checkPermission('parts', 'create')) {
        showToast('❌ لا تملك صلاحية إضافة قطع', 'error');
        return;
      }
      
      // Reset form
      document.getElementById('partForm').reset();
      document.getElementById('partId').value = '';
      document.getElementById('partModalTitle').textContent = 'إضافة قطعة';
      
      // Populate dealer select
      const dealers = await load('dealers');
      const supplierSelect = document.getElementById('partSupplier');
      supplierSelect.innerHTML = '<option value="">-- اختر التاجر --</option>';
      dealers.forEach(dealer => {
        const option = document.createElement('option');
        option.value = dealer.id;
        option.textContent = dealer.name;
        supplierSelect.appendChild(option);
      });
      
      showModal('partModal');
      
    } catch (error) {
      console.error('Error opening part modal:', error);
      showToast('❌ خطأ في فتح نموذج القطعة', 'error');
    }
  });

  document.getElementById('partForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('parts', 'create') && !document.getElementById('partId').value) {
        showToast('❌ لا تملك صلاحية إضافة قطع', 'error');
        return;
      }
      
      if (!checkPermission('parts', 'update') && document.getElementById('partId').value) {
        showToast('❌ لا تملك صلاحية تعديل القطع', 'error');
        return;
      }
      
      const parts = await load('parts');
      const id = document.getElementById('partId').value;
      const isEdit = !!id;
      
      const partData = {
        name: document.getElementById('partName').value,
        type: document.getElementById('partType').value,
        buy: toNumber(document.getElementById('partBuy').value),
        sell: toNumber(document.getElementById('partSell').value),
        stock: toNumber(document.getElementById('partStock').value),
        supplierId: document.getElementById('partSupplier').value || null,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing part
        const index = parts.findIndex(p => p.id === id);
        if (index !== -1) {
          parts[index] = { ...parts[index], ...partData };
        }
      } else {
        // Add new part
        partData.id = uid();
        partData.createdAt = nowISO();
        parts.push(partData);
      }
      
      await save('parts', parts);
      clearCache('parts');
      hideModal('partModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} القطعة بنجاح`, 'success');
      createNotification('قطعة جديدة', `تم ${isEdit ? 'تعديل' : 'إضافة'} قطعة جديدة`, 'info');
      loadParts();
      
    } catch (error) {
      console.error('Error saving part:', error);
      showToast('❌ خطأ في حفظ القطعة', 'error');
    }
  });

  // Dealer form
  document.getElementById('btnAddDealer').addEventListener('click', function() {
    if (!checkPermission('dealers', 'create')) {
      showToast('❌ لا تملك صلاحية إضافة تجار', 'error');
      return;
    }
    
    // Reset form
    document.getElementById('dealerForm').reset();
    document.getElementById('dealerId').value = '';
    document.getElementById('dealerBalance').value = '0';
    document.getElementById('dealerTotalPayments').value = '0';
    document.getElementById('dealerRemaining').value = '0';
    document.getElementById('dealerModalTitle').textContent = 'إضافة تاجر';
    
    showModal('dealerModal');
  });

  function updateDealerRemaining() {
    const balance = toNumber(document.getElementById('dealerBalance').value || 0);
    const totalPayments = toNumber(document.getElementById('dealerTotalPayments').value || 0);
    const remaining = balance - totalPayments;
    document.getElementById('dealerRemaining').value = remaining.toFixed(2);
  }

  document.getElementById('dealerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('dealers', 'create') && !document.getElementById('dealerId').value) {
        showToast('❌ لا تملك صلاحية إضافة تجار', 'error');
        return;
      }
      
      if (!checkPermission('dealers', 'update') && document.getElementById('dealerId').value) {
        showToast('❌ لا تملك صلاحية تعديل التجار', 'error');
        return;
      }
      
      const dealers = await load('dealers');
      const id = document.getElementById('dealerId').value;
      const isEdit = !!id;
      
      const dealerData = {
        name: document.getElementById('dealerName').value,
        specialty: document.getElementById('dealerSpecialty').value,
        phone: document.getElementById('dealerPhone').value,
        address: document.getElementById('dealerAddress').value,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing dealer
        const index = dealers.findIndex(d => d.id === id);
        if (index !== -1) {
          dealers[index] = { ...dealers[index], ...dealerData };
        }
      } else {
        // Add new dealer
        dealerData.id = uid();
        dealerData.createdAt = nowISO();
        dealerData.lastTransaction = nowISO();
        dealers.push(dealerData);
      }
      
      await save('dealers', dealers);
      clearCache('dealers');
      hideModal('dealerModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} التاجر بنجاح`, 'success');
      loadDealers();
      
    } catch (error) {
      console.error('Error saving dealer:', error);
      showToast('❌ خطأ في حفظ التاجر', 'error');
    }
  });

  
// Dealer Payment Form
  document.getElementById('dealerPaymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('dealers', 'update')) {
        showToast('❌ لا تملك صلاحية إضافة / تعديل دفعات', 'error');
        return;
      }
      
      const dealerId = document.getElementById('paymentDealerId').value;
      const paymentAmount = toNumber(document.getElementById('paymentAmount').value);
      const paymentId = document.getElementById('dealerPaymentId').value;
      
      if (!dealerId || paymentAmount <= 0) {
        showToast('❌ يرجى إدخال مبلغ الدفعة', 'error');
        return;
      }
      
      let dealerPayments = await load('dealerPayments');
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      
      // تأكد أن المصفوفة صحيحة
      if (!Array.isArray(dealerPayments)) {
        dealerPayments = [];
      }
      
      // Find dealer
      const dealerIndex = dealers.findIndex(d => d.id === dealerId);
      if (dealerIndex === -1) {
        showToast('❌ التاجر غير موجود', 'error');
        return;
      }
      
      const paymentDate = document.getElementById('paymentDate').value || dateOnly(new Date());
      const paymentMethod = document.getElementById('paymentMethod').value;
      const paymentNotes = document.getElementById('paymentNotes').value;
      
      let paymentRecord;
      if (paymentId) {
        // تحديث دفعة موجودة
        const idx = dealerPayments.findIndex(p => p.id === paymentId);
        if (idx === -1) {
          showToast('❌ تعذر العثور على الدفعة لتعديلها', 'error');
          return;
        }
        
        const existing = dealerPayments[idx];
        paymentRecord = { ...existing,
          dealerId: dealerId,
          amount: paymentAmount,
          date: paymentDate,
          paymentMethod,
          notes: paymentNotes,
          updatedAt: nowISO(),
          updatedBy: currentUser()?.id || 'system'
        };
        dealerPayments[idx] = paymentRecord;
      } else {
        // إنشاء دفعة جديدة
        paymentRecord = {
          id: uid(),
          dealerId: dealerId,
          amount: paymentAmount,
          date: paymentDate,
          paymentMethod,
          notes: paymentNotes,
          createdAt: nowISO(),
          createdBy: currentUser()?.id || 'system'
        };
        dealerPayments.push(paymentRecord);
      }
      
      await save('dealerPayments', dealerPayments);
      
      // Update dealer's last transaction
      dealers[dealerIndex].lastTransaction = nowISO();
      await save('dealers', dealers);
      
      // Clear dealer cache
      clearCache('dealers');
      
      hideModal('dealerPaymentModal');
      showToast(paymentId ? '✅ تم تعديل الدفعة بنجاح' : '✅ تم إضافة الدفعة بنجاح', 'success');
      createNotification(
        paymentId ? 'تعديل دفعة' : 'دفعة جديدة',
        `${paymentId ? 'تم تعديل دفعة للتاجر' : 'تم إضافة دفعة جديدة للتاجر'} ${dealers[dealerIndex].name} بقيمة ${currency(paymentAmount)}`,
        'success'
      );
      
      // Reload dealers to show updated balance
      loadDealers();
      
    } catch (error) {
      console.error('Error saving dealer payment:', error);
      showToast('❌ خطأ في حفظ الدفعة', 'error');
    }
  });


// Expense form
  document.getElementById('btnAddExpense').addEventListener('click', function() {
    if (!checkPermission('expenses', 'create')) {
      showToast('❌ لا تملك صلاحية إضافة مصروفات', 'error');
      return;
    }
    
    // Reset form
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseId').value = '';
    document.getElementById('expenseDate').value = dateOnly(new Date());
    document.getElementById('expenseModalTitle').textContent = 'إضافة مصروف';
    
    showModal('expenseModal');
  });

  document.getElementById('expenseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('expenses', 'create') && !document.getElementById('expenseId').value) {
        showToast('❌ لا تملك صلاحية إضافة مصروفات', 'error');
        return;
      }
      
      if (!checkPermission('expenses', 'update') && document.getElementById('expenseId').value) {
        showToast('❌ لا تملك صلاحية تعديل المصروفات', 'error');
        return;
      }
      
      const expenses = await load('expenses');
      const id = document.getElementById('expenseId').value;
      const isEdit = !!id;
      
      const expenseData = {
        type: document.getElementById('expenseType').value,
        amount: toNumber(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        paymentMethod: document.getElementById('expensePaymentMethod').value,
        description: document.getElementById('expenseDescription').value,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing expense
        const index = expenses.findIndex(e => e.id === id);
        if (index !== -1) {
          expenses[index] = { ...expenses[index], ...expenseData };
        }
      } else {
        // Add new expense
        expenseData.id = uid();
        expenseData.createdAt = nowISO();
        expenses.push(expenseData);
      }
      
      await save('expenses', expenses);
      clearCache('expenses');
      hideModal('expenseModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} المصروف بنجاح`, 'success');
      loadExpenses();
      
    } catch (error) {
      console.error('Error saving expense:', error);
      showToast('❌ خطأ في حفظ المصروف', 'error');
    }
  });

  // Commitment form
  document.getElementById('btnAddCommitment').addEventListener('click', function() {
    if (!checkPermission('commitments', 'create')) {
      showToast('❌ لا تملك صلاحية إضافة التزامات', 'error');
      return;
    }
    
    // Reset form
    document.getElementById('commitmentForm').reset();
    document.getElementById('commitmentId').value = '';
    document.getElementById('commitmentStartDate').value = dateOnly(new Date());
    document.getElementById('commitmentDuration').value = '12';
    document.getElementById('commitmentModalTitle').textContent = 'إضافة التزام';
    
    showModal('commitmentModal');
  });

  document.getElementById('commitmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('commitments', 'create') && !document.getElementById('commitmentId').value) {
        showToast('❌ لا تملك صلاحية إضافة التزامات', 'error');
        return;
      }
      
      if (!checkPermission('commitments', 'update') && document.getElementById('commitmentId').value) {
        showToast('❌ لا تملك صلاحية تعديل الالتزامات', 'error');
        return;
      }
      
      const commitments = await load('commitments');
      const id = document.getElementById('commitmentId').value;
      const isEdit = !!id;
      
      const commitmentData = {
        name: document.getElementById('commitmentName').value,
        amount: toNumber(document.getElementById('commitmentAmount').value),
        startDate: document.getElementById('commitmentStartDate').value,
        duration: parseInt(document.getElementById('commitmentDuration').value),
        status: document.getElementById('commitmentStatus').value,
        updatedAt: nowISO()
      };
      
      if (isEdit) {
        // Update existing commitment
        const index = commitments.findIndex(c => c.id === id);
        if (index !== -1) {
          commitments[index] = { ...commitments[index], ...commitmentData };
        }
      } else {
        // Add new commitment
        commitmentData.id = uid();
        commitmentData.createdAt = nowISO();
        commitments.push(commitmentData);
      }
      
      await save('commitments', commitments);
      clearCache('commitments');
      hideModal('commitmentModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} الالتزام بنجاح`, 'success');
      loadCommitments();
      
    } catch (error) {
      console.error('Error saving commitment:', error);
      showToast('❌ خطأ في حفظ الالتزام', 'error');
    }
  });

  // User form
  document.getElementById('btnAddUser').addEventListener('click', function() {
    // Check permissions
    if (!checkPermission('users', 'create')) {
      showToast('❌ لا تملك صلاحية إضافة مستخدمين', 'error');
      return;
    }
    
    // Reset form
    document.getElementById('userForm').reset();
    document.getElementById('uId').value = '';
    document.getElementById('uActive').checked = true;
    document.getElementById('uRole').value = 'sales';
    document.getElementById('uPassword').required = true;
    document.getElementById('userModalTitle').textContent = 'إضافة مستخدم';
    
    showModal('userModal');
  });

  document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
      if (!checkPermission('users', 'create') && !document.getElementById('uId').value) {
        showToast('❌ لا تملك صلاحية إضافة مستخدمين', 'error');
        return;
      }
      
      if (!checkPermission('users', 'update') && document.getElementById('uId').value) {
        showToast('❌ لا تملك صلاحية تعديل المستخدمين', 'error');
        return;
      }
      
      const users = await load('users');
      const id = document.getElementById('uId').value;
      const isEdit = !!id;
      
      // Check if email already exists (for new users)
      const email = document.getElementById('uEmail').value;
      if (!isEdit) {
        const existingUser = users.find(u => u.email === email);
        if (existingUser) {
          showToast('❌ البريد الإلكتروني مسجل بالفعل', 'error');
          return;
        }
      }
      
      const userData = {
        name: document.getElementById('uName').value,
        email: email,
        role: document.getElementById('uRole').value,
        active: document.getElementById('uActive').checked,
        updatedAt: nowISO()
      };
      
      // Handle password
      const password = document.getElementById('uPassword').value;
      if (password) {
        userData.password = encryptPassword(password);
      } else if (!isEdit) {
        // New user must have a password
        showToast('❌ يرجى إدخال كلمة مرور', 'error');
        return;
      }
      
      if (isEdit) {
        // Update existing user (keep password if not changed)
        const index = users.findIndex(u => u.id === id);
        if (index !== -1) {
          if (!password) {
            userData.password = users[index].password; // Keep old password
          }
          users[index] = { ...users[index], ...userData };
        }
      } else {
        // Add new user
        userData.id = uid();
        userData.createdAt = nowISO();
        userData.loginAttempts = 0;
        userData.lastLogin = null;
        users.push(userData);
      }
      
      await save('users', users);
      clearCache('users');
      hideModal('userModal');
      showToast(`✅ تم ${isEdit ? 'تعديل' : 'إضافة'} المستخدم بنجاح`, 'success');
      loadUsers();
      
    } catch (error) {
      console.error('Error saving user:', error);
      showToast('❌ خطأ في حفظ المستخدم', 'error');
    }
  });

  // ---------- Export Functions ----------
  document.getElementById('exportCustomersCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('customers', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات العملاء', 'error');
        return;
      }
      
      const customers = await load('customers');
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,الاسم,نوع الجهاز,حجم الجهاز,الهاتف,العنوان,تاريخ التسجيل,ملاحظات\n';
      
      // Add data
      customers.forEach(customer => {
        const row = [
          customer.id,
          customer.name || '',
          customer.deviceType || '',
          customer.deviceSize || '',
          customer.phone || '',
          customer.address || '',
          dateOnly(customer.createdAt),
          customer.notes || ''
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `customers_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات العملاء بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting customers:', error);
      showToast('❌ خطأ في تصدير بيانات العملاء', 'error');
    }
  });

  document.getElementById('exportProductsCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('products', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات المنتجات', 'error');
        return;
      }
      
      const products = await load('products');
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,اسم المنتج,سعر الشراء,سعر البيع,الكمية,تاريخ الإضافة\n';
      
      // Add data
      products.forEach(product => {
        const row = [
          product.id,
          product.name || '',
          product.buy || 0,
          product.sell || 0,
          product.stock || 0,
          dateOnly(product.createdAt)
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `products_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات المنتجات بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting products:', error);
      showToast('❌ خطأ في تصدير بيانات المنتجات', 'error');
    }
  });

  document.getElementById('exportInvoicesCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('invoices', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات الفواتير', 'error');
        return;
      }
      
      const invoices = await load('invoices');
      const customers = await load('customers');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'رقم الفاتورة,اسم العميل,إجمالي البيع,إجمالي الشراء,الصافي,تاريخ الفاتورة,طريقة الدفع,حالة الدفع,ملاحظات\n';
      
      // Add data
      invoices.forEach(invoice => {
        const customer = customers.find(c => c.id === invoice.customerId);
        const customerName = invoice.customerId === 'anonymous' ? 'عميل بدون اسم' : (customer ? customer.name : 'غير معروف');
        
        const row = [
          invoice.number || 'N/A',
          customerName,
          invoice.totalSell || 0,
          invoice.totalBuy || 0,
          invoice.net || 0,
          dateOnly(invoice.date),
          invoice.paymentMethod === 'cash' ? 'كاش' : 'حوالة',
          invoice.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع',
          invoice.notes || ''
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `invoices_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات الفواتير بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting invoices:', error);
      showToast('❌ خطأ في تصدير بيانات الفواتير', 'error');
    }
  });

  document.getElementById('exportMaintenanceCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('maintenance', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات الصيانة', 'error');
        return;
      }
      
      const maintenance = await load('maintenance');
      const customers = await load('customers');
      const dealers = await load('dealers');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'رقم الأمر,اسم العميل,الجهاز,نوع الصيانة,تكلفة العمل,ثمن القطع,تاجر القطع,الصافي,تاريخ الاستلام,تاريخ التسليم,تاريخ الكفالة,طريقة الدفع,حالة الدفع,الحالة,ملاحظات\n';
      
      // Add data
      maintenance.forEach(order => {
        const customer = customers.find(c => c.id === order.customerId);
        const dealer = dealers.find(d => d.id === order.partsDealerId);
        
        const row = [
          order.number || 'N/A',
          customer ? customer.name : 'غير معروف',
          order.device || '',
          order.type === 'in_shop' ? 'في المحل' : 'توصيل',
          order.cost || 0,
          order.parts || 0,
          dealer ? dealer.name : '',
          order.net || 0,
          dateOnly(order.received),
          dateOnly(order.delivery),
          dateOnly(order.warranty),
          order.paymentMethod === 'cash' ? 'كاش' : 'حوالة',
          order.paymentStatus === 'paid' ? 'مدفوع' : 'غير مدفوع',
          order.status || 'new',
          order.notes || ''
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `maintenance_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات الصيانة بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting maintenance:', error);
      showToast('❌ خطأ في تصدير بيانات الصيانة', 'error');
    }
  });

  document.getElementById('exportPartsCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('parts', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات القطع', 'error');
        return;
      }
      
      const parts = await load('parts');
      const dealers = await load('dealers');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,اسم القطعة,النوع,سعر الشراء,سعر البيع,الكمية,المورد,تاريخ الإضافة\n';
      
      // Add data
      parts.forEach(part => {
        const dealer = dealers.find(d => d.id === part.supplierId);
        
        const row = [
          part.id,
          part.name || '',
          part.type || '',
          part.buy || 0,
          part.sell || 0,
          part.stock || 0,
          dealer ? dealer.name : '',
          dateOnly(part.createdAt)
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `parts_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات القطع بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting parts:', error);
      showToast('❌ خطأ في تصدير بيانات القطع', 'error');
    }
  });

  document.getElementById('exportDealersCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('dealers', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات التجار', 'error');
        return;
      }
      
      const dealers = await load('dealers');
      const maintenance = await load('maintenance');
      const parts = await load('parts');
      const dealerPayments = await load('dealerPayments');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,اسم التاجر,التخصص,الهاتف,العنوان,إجمالي المشتريات,إجمالي المدفوعات,الباقي,آخر معاملة\n';
      
      // Add data
      dealers.forEach(dealer => {
        // Calculate totals (full history, not filtered)
        let totalPurchases = 0;
        let totalPayments = 0;
        
        // Calculate total purchases from maintenance
        maintenance.forEach(mnt => {
          if (mnt.partsDealerId === dealer.id) {
            totalPurchases += toNumber(mnt.parts);
          }
        });
        
        // Calculate total purchases from parts inventory
        parts.forEach(part => {
          if (part.supplierId === dealer.id) {
            totalPurchases += toNumber(part.buy) * toNumber(part.stock);
          }
        });
        
        // Calculate total payments from dealerPayments
        const dealerPaymentRecords = dealerPayments.filter(payment => payment.dealerId === dealer.id);
        dealerPaymentRecords.forEach(payment => {
          totalPayments += toNumber(payment.amount);
        });
        
        const remaining = totalPurchases - totalPayments;
        
        const row = [
          dealer.id,
          dealer.name || '',
          dealer.specialty || '',
          dealer.phone || '',
          dealer.address || '',
          totalPurchases,
          totalPayments,
          remaining,
          dealer.lastTransaction ? dateOnly(dealer.lastTransaction) : ''
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `dealers_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات التجار بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting dealers:', error);
      showToast('❌ خطأ في تصدير بيانات التجار', 'error');
    }
  });

  document.getElementById('exportExpensesCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('expenses', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات المصروفات', 'error');
        return;
      }
      
      const expenses = await load('expenses');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,التاريخ,نوع المصروف,المبلغ,طريقة الدفع,الوصف\n';
      
      // Add data
      expenses.forEach(expense => {
        const row = [
          expense.id,
          dateOnly(expense.date),
          getExpenseTypeText(expense.type),
          expense.amount || 0,
          expense.paymentMethod === 'cash' ? 'كاش' : 'حوالة',
          expense.description || ''
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `expenses_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات المصروفات بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting expenses:', error);
      showToast('❌ خطأ في تصدير بيانات المصروفات', 'error');
    }
  });

  document.getElementById('exportCommitmentsCsv').addEventListener('click', async function() {
    try {
      if (!checkPermission('commitments', 'export')) {
        showToast('❌ لا تملك صلاحية تصدير بيانات الالتزامات', 'error');
        return;
      }
      
      const commitments = await load('commitments');
      
      let csvContent = 'data:text/csv;charset=utf-8,';
      
      // Add headers
      csvContent += 'ID,اسم الالتزام,المبلغ الشهري,تاريخ البدء,المدة (شهر),الحالة\n';
      
      // Add data
      commitments.forEach(commitment => {
        const row = [
          commitment.id,
          commitment.name || '',
          commitment.amount || 0,
          dateOnly(commitment.startDate),
          commitment.duration || 12,
          commitment.status === 'active' ? 'نشط' : 'غير نشط'
        ].map(field => `"${field}"`).join(',');
        csvContent += row + '\n';
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', `commitments_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('✅ تم تصدير بيانات الالتزامات بنجاح', 'success');
      
    } catch (error) {
      console.error('Error exporting commitments:', error);
      showToast('❌ خطأ في تصدير بيانات الالتزامات', 'error');
    }
  });

  // ---------- Event Listeners ----------
  document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    const user = await login(email, password);
    if (user) {
      // Show success message
      document.getElementById('loginError').style.display = 'none';
      
      // Update UI based on user role
      document.getElementById('sidebarUserName').textContent = user.name;
      document.getElementById('sidebarUserRole').textContent = getRoleText(user.role);
      
      // Hide login, show app
      document.getElementById('loginView').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      
      // Initialize app
      await initializeApp();
      
      // Show welcome message
      showToast(`مرحباً ${user.name}!`, 'success');
      createNotification('تسجيل دخول', `تم تسجيل دخول المستخدم ${user.name}`, 'info');
    }
  });

  document.getElementById('testConnectionFromLogin').addEventListener('click', async function() {
    const result = await testFirebaseConnection();
    showToast(result.message, result.success ? 'success' : 'error');
  });

  document.getElementById('useLocalMode').addEventListener('click', function() {
    if (confirm('هل تريد استخدام النسخة المحلية؟ ستفقد مزامنة البيانات مع Firebase.')) {
      useFirebase = false;
      document.getElementById('storageBadge').className = 'badge bg-warning';
      document.getElementById('storageBadge').textContent = 'Local';
      showToast('✅ تم التبديل إلى النسخة المحلية', 'success');
    }
  });

  // Navigation
  document.querySelectorAll('.sidebar .nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const section = this.getAttribute('data-section');
      showSection(section);
    });
  });

  // Buttons
  document.getElementById('refreshStats').addEventListener('click', loadDashboard);
  document.getElementById('btnAddCustomer').addEventListener('click', function() {
    if (!checkPermission('customers', 'create')) {
      showToast('❌ لا تملك صلاحية إضافة عملاء', 'error');
      return;
    }
    
    // Reset form
    document.getElementById('customerForm').reset();
    document.getElementById('custId').value = '';
    document.getElementById('customerModalTitle').textContent = 'إضافة عميل';
    showModal('customerModal');
  });

  // Search inputs with debouncing
  const searchInputs = ['searchCustomer', 'searchProduct', 'searchPart', 'searchDealer', 'searchExpense'];
  searchInputs.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (input) {
      input.addEventListener('input', debounce(function() {
        const section = this.id.replace('search', '').toLowerCase();
        switch(section) {
          case 'customer':
            loadCustomers();
            break;
          case 'product':
            loadProducts();
            break;
          case 'part':
            loadParts();
            break;
          case 'dealer':
            loadDealers();
            break;
          case 'expense':
            loadExpenses();
            break;
        }
      }, DEBOUNCE_DELAY));
    }
  });

  // Connection test button
  document.getElementById('testConnectionBtn').addEventListener('click', async function() {
    const result = await testFirebaseConnection();
    showToast(result.message, result.success ? 'success' : 'error');
    updateStorageBadge();
  });

  // Sync to Firebase button
  document.getElementById('syncToFirebaseBtn').addEventListener('click', async function() {
    try {
      if (useFirebase) {
        showToast('✅ أنت متصل بالفعل بـ Firebase', 'info');
        return;
      }
      
      if (confirm('هل تريد المزامنة مع Firebase؟ قد تستغرق هذه العملية بعض الوقت.')) {
        showLoading();
        
        // Try to initialize Firebase
        const initialized = initializeFirebase();
        if (!initialized) {
          hideLoading();
          showToast('❌ تعذر الاتصال بـ Firebase', 'error');
          return;
        }
        
        useFirebase = true;
        
        // Sync all data to Firebase
        const collections = [
          'customers', 'products', 'invoices', 'maintenance',
          'parts', 'dealers', 'expenses', 'commitments', 'users',
          'counters', 'notifications', 'dealerPayments'
        ];
        
        let syncedCount = 0;
        
        for (const collection of collections) {
          const data = JSON.parse(localStorage.getItem('wesam_' + collection) || '[]');
          if (Array.isArray(data) && data.length > 0) {
            await database.ref(collection).set(data);
            syncedCount++;
            console.log(`✅ Synced ${collection}: ${data.length} items`);
          }
        }
        
        hideLoading();
        updateStorageBadge();
        showToast(`✅ تمت مزامنة ${syncedCount} مجموعة مع Firebase`, 'success');
        createNotification('مزامنة البيانات', 'تمت مزامنة جميع البيانات مع Firebase بنجاح', 'success');
      }
    } catch (error) {
      hideLoading();
      console.error('Error syncing to Firebase:', error);
      showToast('❌ خطأ في المزامنة: ' + error.message, 'error');
    }
  });

  // Logout button
  document.getElementById('logoutBtn').addEventListener('click', logout);

  // Theme toggle
  document.getElementById('toggleThemeBtn').addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    this.innerHTML = isDark ? '<i class="bi bi-sun me-1"></i>وضع فاتح' : '<i class="bi bi-moon-stars me-1"></i>وضع داكن';
    localStorage.setItem('darkMode', isDark);
  });

  // Notifications button
  document.getElementById('notificationsBtn').addEventListener('click', showNotifications);
  document.getElementById('markAllAsRead').addEventListener('click', markAllNotificationsAsRead);
  const clearNotificationsBtn = document.getElementById('clearNotifications');
  if (clearNotificationsBtn) {
    clearNotificationsBtn.addEventListener('click', clearAllNotifications);
  }

  // ---------- Initialization ----------
  async function initializeApp() {
    try {
      showLoading();
      
      // Initialize Firebase
      const firebaseInitialized = initializeFirebase();
      if (!firebaseInitialized) {
        console.log('⚠️ Firebase initialization failed, using local storage');
        useFirebase = false;
      }
      
      // Update storage badge
      updateStorageBadge();
      
      // Ensure default data exists
      await ensureSeed();
      
      // Check for dark mode preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('toggleThemeBtn').innerHTML = '<i class="bi bi-sun me-1"></i>وضع فاتح';
      }
      
      // Load notifications
      await loadNotifications();
      
      // Set up auto backup
      await setupAutoBackup();
      
      // Set up auto cleanup
      await autoCleanup();
      
      // Monitor for smart notifications
      setTimeout(monitorNotifications, 5000); // Check after 5 seconds
      
      // Register lazy loaders
      registerLazyLoader('dashboard', loadDashboard);
      registerLazyLoader('customers', loadCustomers);
      registerLazyLoader('products', loadProducts);
      registerLazyLoader('sales', loadInvoices);
      registerLazyLoader('maintenance', loadMaintenance);
      registerLazyLoader('parts', loadParts);
      registerLazyLoader('dealers', loadDealers);
      registerLazyLoader('expenses', loadExpenses);
      registerLazyLoader('commitments', loadCommitments);
      registerLazyLoader('bank', loadBank);
      registerLazyLoader('debts', loadDebts);
      registerLazyLoader('reports', loadReports);
      registerLazyLoader('users', loadUsers);
      registerLazyLoader('backup', setupBackup);
      
      // Initialize date range filters
      initializeDateRangeFilters();
      
      // Show dashboard by default
      showSection('dashboard');
      
      // Check for remembered email
      const rememberedEmail = localStorage.getItem('rememberedEmail');
      if (rememberedEmail) {
        document.getElementById('loginEmail').value = rememberedEmail;
      }
      
      hideLoading();
      
    } catch (error) {
      console.error('Initialization error:', error);
      hideLoading();
      showToast('❌ خطأ في تهيئة النظام', 'error');
    }
  }

  // Check if user is already logged in
  const user = currentUser();
  if (user) {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('sidebarUserName').textContent = user.name;
    document.getElementById('sidebarUserRole').textContent = getRoleText(user.role);
    initializeApp();
  } else {
    document.getElementById('loginView').style.display = 'block';
  }

  // Expose functions to global scope for HTML onclick attributes
  window.removeInvoiceItem = removeInvoiceItem;
  window.updateProductPrice = updateProductPrice;
// ... جميع الدوال السابقة ...

// ========== جعل الدوال متاحة عالمياً ==========
window.viewDealerPayments = viewDealerPayments;
window.editDealerPayment = editDealerPayment;
window.deleteDealerPayment = deleteDealerPayment;

// ========== نهاية الملف ==========

  </script>

<script>
/* Mobile Sidebar Toggle + Responsive Tables (Cards) */
(function(){
  const mq = window.matchMedia('(max-width: 768px)');
  const body = document.body;
  const sidebar = document.querySelector('.sidebar');
  const toggleBtn = document.getElementById('mobileSidebarToggle');
  const overlay = document.getElementById('sidebarOverlay');

  function closeSidebar(){ body.classList.remove('sidebar-open'); }
  function toggleSidebar(){ body.classList.toggle('sidebar-open'); }

  if (toggleBtn) toggleBtn.addEventListener('click', toggleSidebar);
  if (overlay) overlay.addEventListener('click', closeSidebar);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeSidebar();
  });

  if (sidebar){
    sidebar.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (a && mq.matches) closeSidebar();
    });
  }

  // Ensure sidebar closes when leaving mobile view
  if (mq.addEventListener){
    mq.addEventListener('change', () => { if (!mq.matches) closeSidebar(); });
  } else if (mq.addListener){
    mq.addListener(() => { if (!mq.matches) closeSidebar(); });
  }

  // ----- Tables -> Cards: add data-label from TH to each TD -----
  function applyTableLabels(table){
    if (!table) return;
    const ths = Array.from(table.querySelectorAll('thead th')).map(th => (th.textContent || '').trim());
    if (!ths.length) return;

    table.querySelectorAll('tbody tr').forEach(tr => {
      const tds = Array.from(tr.children).filter(el => el.tagName && el.tagName.toLowerCase() === 'td');
      tds.forEach((td, i) => {
        const label = ths[i] || '';
        if (label) td.setAttribute('data-label', label);
      });
    });
  }

  function applyAllTables(){
    document.querySelectorAll('.table-responsive table.table').forEach(applyTableLabels);
  }

  // Initial apply
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', applyAllTables);
  } else {
    applyAllTables();
  }

  // Observe changes in all TBODY (tables are dynamic)
  function observe(tbody){
    const obs = new MutationObserver(() => applyAllTables());
    obs.observe(tbody, { childList: true, subtree: true });
  }
  document.querySelectorAll('table.table tbody').forEach(observe);

  // Safety: re-apply shortly after load
  setTimeout(applyAllTables, 600);

  // Re-apply on resize (only needed on mobile)
  window.addEventListener('resize', () => {
    if (mq.matches) applyAllTables();
  });
})();
</script>

</body>
</html>